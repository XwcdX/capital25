function Sc(a,o){for(var h=0;h<o.length;h++){const c=o[h];if(typeof c!="string"&&!Array.isArray(c)){for(const p in c)if(p!=="default"&&!(p in a)){const y=Object.getOwnPropertyDescriptor(c,p);y&&Object.defineProperty(a,p,y.get?y:{enumerable:!0,get:()=>c[p]})}}}return Object.freeze(Object.defineProperty(a,Symbol.toStringTag,{value:"Module"}))}function vo(a,o){return function(){return a.apply(o,arguments)}}const{toString:_c}=Object.prototype,{getPrototypeOf:ki}=Object,Ws=(a=>o=>{const h=_c.call(o);return a[h]||(a[h]=h.slice(8,-1).toLowerCase())})(Object.create(null)),$e=a=>(a=a.toLowerCase(),o=>Ws(o)===a),zs=a=>o=>typeof o===a,{isArray:Xt}=Array,Gn=zs("undefined");function Rc(a){return a!==null&&!Gn(a)&&a.constructor!==null&&!Gn(a.constructor)&&Be(a.constructor.isBuffer)&&a.constructor.isBuffer(a)}const wo=$e("ArrayBuffer");function Oc(a){let o;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?o=ArrayBuffer.isView(a):o=a&&a.buffer&&wo(a.buffer),o}const kc=zs("string"),Be=zs("function"),Co=zs("number"),Vs=a=>a!==null&&typeof a=="object",Tc=a=>a===!0||a===!1,Ns=a=>{if(Ws(a)!=="object")return!1;const o=ki(a);return(o===null||o===Object.prototype||Object.getPrototypeOf(o)===null)&&!(Symbol.toStringTag in a)&&!(Symbol.iterator in a)},Ac=$e("Date"),Ec=$e("File"),Pc=$e("Blob"),Ic=$e("FileList"),Mc=a=>Vs(a)&&Be(a.pipe),xc=a=>{let o;return a&&(typeof FormData=="function"&&a instanceof FormData||Be(a.append)&&((o=Ws(a))==="formdata"||o==="object"&&Be(a.toString)&&a.toString()==="[object FormData]"))},Lc=$e("URLSearchParams"),[Nc,Uc,qc,Dc]=["ReadableStream","Request","Response","Headers"].map($e),Bc=a=>a.trim?a.trim():a.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function Fn(a,o,{allOwnKeys:h=!1}={}){if(a===null||typeof a>"u")return;let c,p;if(typeof a!="object"&&(a=[a]),Xt(a))for(c=0,p=a.length;c<p;c++)o.call(null,a[c],c,a);else{const y=h?Object.getOwnPropertyNames(a):Object.keys(a),w=y.length;let k;for(c=0;c<w;c++)k=y[c],o.call(null,a[k],k,a)}}function So(a,o){o=o.toLowerCase();const h=Object.keys(a);let c=h.length,p;for(;c-- >0;)if(p=h[c],o===p.toLowerCase())return p;return null}const Ot=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,_o=a=>!Gn(a)&&a!==Ot;function di(){const{caseless:a}=_o(this)&&this||{},o={},h=(c,p)=>{const y=a&&So(o,p)||p;Ns(o[y])&&Ns(c)?o[y]=di(o[y],c):Ns(c)?o[y]=di({},c):Xt(c)?o[y]=c.slice():o[y]=c};for(let c=0,p=arguments.length;c<p;c++)arguments[c]&&Fn(arguments[c],h);return o}const jc=(a,o,h,{allOwnKeys:c}={})=>(Fn(o,(p,y)=>{h&&Be(p)?a[y]=vo(p,h):a[y]=p},{allOwnKeys:c}),a),Hc=a=>(a.charCodeAt(0)===65279&&(a=a.slice(1)),a),Gc=(a,o,h,c)=>{a.prototype=Object.create(o.prototype,c),a.prototype.constructor=a,Object.defineProperty(a,"super",{value:o.prototype}),h&&Object.assign(a.prototype,h)},Fc=(a,o,h,c)=>{let p,y,w;const k={};if(o=o||{},a==null)return o;do{for(p=Object.getOwnPropertyNames(a),y=p.length;y-- >0;)w=p[y],(!c||c(w,a,o))&&!k[w]&&(o[w]=a[w],k[w]=!0);a=h!==!1&&ki(a)}while(a&&(!h||h(a,o))&&a!==Object.prototype);return o},Wc=(a,o,h)=>{a=String(a),(h===void 0||h>a.length)&&(h=a.length),h-=o.length;const c=a.indexOf(o,h);return c!==-1&&c===h},zc=a=>{if(!a)return null;if(Xt(a))return a;let o=a.length;if(!Co(o))return null;const h=new Array(o);for(;o-- >0;)h[o]=a[o];return h},Vc=(a=>o=>a&&o instanceof a)(typeof Uint8Array<"u"&&ki(Uint8Array)),Jc=(a,o)=>{const c=(a&&a[Symbol.iterator]).call(a);let p;for(;(p=c.next())&&!p.done;){const y=p.value;o.call(a,y[0],y[1])}},$c=(a,o)=>{let h;const c=[];for(;(h=a.exec(o))!==null;)c.push(h);return c},Kc=$e("HTMLFormElement"),Xc=a=>a.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(h,c,p){return c.toUpperCase()+p}),to=(({hasOwnProperty:a})=>(o,h)=>a.call(o,h))(Object.prototype),Qc=$e("RegExp"),Ro=(a,o)=>{const h=Object.getOwnPropertyDescriptors(a),c={};Fn(h,(p,y)=>{let w;(w=o(p,y,a))!==!1&&(c[y]=w||p)}),Object.defineProperties(a,c)},Yc=a=>{Ro(a,(o,h)=>{if(Be(a)&&["arguments","caller","callee"].indexOf(h)!==-1)return!1;const c=a[h];if(Be(c)){if(o.enumerable=!1,"writable"in o){o.writable=!1;return}o.set||(o.set=()=>{throw Error("Can not rewrite read-only method '"+h+"'")})}})},Zc=(a,o)=>{const h={},c=p=>{p.forEach(y=>{h[y]=!0})};return Xt(a)?c(a):c(String(a).split(o)),h},el=()=>{},tl=(a,o)=>a!=null&&Number.isFinite(a=+a)?a:o;function nl(a){return!!(a&&Be(a.append)&&a[Symbol.toStringTag]==="FormData"&&a[Symbol.iterator])}const sl=a=>{const o=new Array(10),h=(c,p)=>{if(Vs(c)){if(o.indexOf(c)>=0)return;if(!("toJSON"in c)){o[p]=c;const y=Xt(c)?[]:{};return Fn(c,(w,k)=>{const x=h(w,p+1);!Gn(x)&&(y[k]=x)}),o[p]=void 0,y}}return c};return h(a,0)},rl=$e("AsyncFunction"),il=a=>a&&(Vs(a)||Be(a))&&Be(a.then)&&Be(a.catch),Oo=((a,o)=>a?setImmediate:o?((h,c)=>(Ot.addEventListener("message",({source:p,data:y})=>{p===Ot&&y===h&&c.length&&c.shift()()},!1),p=>{c.push(p),Ot.postMessage(h,"*")}))(`axios@${Math.random()}`,[]):h=>setTimeout(h))(typeof setImmediate=="function",Be(Ot.postMessage)),ol=typeof queueMicrotask<"u"?queueMicrotask.bind(Ot):typeof process<"u"&&process.nextTick||Oo,O={isArray:Xt,isArrayBuffer:wo,isBuffer:Rc,isFormData:xc,isArrayBufferView:Oc,isString:kc,isNumber:Co,isBoolean:Tc,isObject:Vs,isPlainObject:Ns,isReadableStream:Nc,isRequest:Uc,isResponse:qc,isHeaders:Dc,isUndefined:Gn,isDate:Ac,isFile:Ec,isBlob:Pc,isRegExp:Qc,isFunction:Be,isStream:Mc,isURLSearchParams:Lc,isTypedArray:Vc,isFileList:Ic,forEach:Fn,merge:di,extend:jc,trim:Bc,stripBOM:Hc,inherits:Gc,toFlatObject:Fc,kindOf:Ws,kindOfTest:$e,endsWith:Wc,toArray:zc,forEachEntry:Jc,matchAll:$c,isHTMLForm:Kc,hasOwnProperty:to,hasOwnProp:to,reduceDescriptors:Ro,freezeMethods:Yc,toObjectSet:Zc,toCamelCase:Xc,noop:el,toFiniteNumber:tl,findKey:So,global:Ot,isContextDefined:_o,isSpecCompliantForm:nl,toJSONObject:sl,isAsyncFn:rl,isThenable:il,setImmediate:Oo,asap:ol};function te(a,o,h,c,p){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=a,this.name="AxiosError",o&&(this.code=o),h&&(this.config=h),c&&(this.request=c),p&&(this.response=p,this.status=p.status?p.status:null)}O.inherits(te,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:O.toJSONObject(this.config),code:this.code,status:this.status}}});const ko=te.prototype,To={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(a=>{To[a]={value:a}});Object.defineProperties(te,To);Object.defineProperty(ko,"isAxiosError",{value:!0});te.from=(a,o,h,c,p,y)=>{const w=Object.create(ko);return O.toFlatObject(a,w,function(x){return x!==Error.prototype},k=>k!=="isAxiosError"),te.call(w,a.message,o,h,c,p),w.cause=a,w.name=a.name,y&&Object.assign(w,y),w};const al=null;function fi(a){return O.isPlainObject(a)||O.isArray(a)}function Ao(a){return O.endsWith(a,"[]")?a.slice(0,-2):a}function no(a,o,h){return a?a.concat(o).map(function(p,y){return p=Ao(p),!h&&y?"["+p+"]":p}).join(h?".":""):o}function cl(a){return O.isArray(a)&&!a.some(fi)}const ll=O.toFlatObject(O,{},null,function(o){return/^is[A-Z]/.test(o)});function Js(a,o,h){if(!O.isObject(a))throw new TypeError("target must be an object");o=o||new FormData,h=O.toFlatObject(h,{metaTokens:!0,dots:!1,indexes:!1},!1,function(U,R){return!O.isUndefined(R[U])});const c=h.metaTokens,p=h.visitor||I,y=h.dots,w=h.indexes,x=(h.Blob||typeof Blob<"u"&&Blob)&&O.isSpecCompliantForm(o);if(!O.isFunction(p))throw new TypeError("visitor must be a function");function N(L){if(L===null)return"";if(O.isDate(L))return L.toISOString();if(!x&&O.isBlob(L))throw new te("Blob is not supported. Use a Buffer instead.");return O.isArrayBuffer(L)||O.isTypedArray(L)?x&&typeof Blob=="function"?new Blob([L]):Buffer.from(L):L}function I(L,U,R){let q=L;if(L&&!R&&typeof L=="object"){if(O.endsWith(U,"{}"))U=c?U:U.slice(0,-2),L=JSON.stringify(L);else if(O.isArray(L)&&cl(L)||(O.isFileList(L)||O.endsWith(U,"[]"))&&(q=O.toArray(L)))return U=Ao(U),q.forEach(function(K,_){!(O.isUndefined(K)||K===null)&&o.append(w===!0?no([U],_,y):w===null?U:U+"[]",N(K))}),!1}return fi(L)?!0:(o.append(no(R,U,y),N(L)),!1)}const D=[],F=Object.assign(ll,{defaultVisitor:I,convertValue:N,isVisitable:fi});function H(L,U){if(!O.isUndefined(L)){if(D.indexOf(L)!==-1)throw Error("Circular reference detected in "+U.join("."));D.push(L),O.forEach(L,function(q,W){(!(O.isUndefined(q)||q===null)&&p.call(o,q,O.isString(W)?W.trim():W,U,F))===!0&&H(q,U?U.concat(W):[W])}),D.pop()}}if(!O.isObject(a))throw new TypeError("data must be an object");return H(a),o}function so(a){const o={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(a).replace(/[!'()~]|%20|%00/g,function(c){return o[c]})}function Ti(a,o){this._pairs=[],a&&Js(a,this,o)}const Eo=Ti.prototype;Eo.append=function(o,h){this._pairs.push([o,h])};Eo.toString=function(o){const h=o?function(c){return o.call(this,c,so)}:so;return this._pairs.map(function(p){return h(p[0])+"="+h(p[1])},"").join("&")};function ul(a){return encodeURIComponent(a).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Po(a,o,h){if(!o)return a;const c=h&&h.encode||ul;O.isFunction(h)&&(h={serialize:h});const p=h&&h.serialize;let y;if(p?y=p(o,h):y=O.isURLSearchParams(o)?o.toString():new Ti(o,h).toString(c),y){const w=a.indexOf("#");w!==-1&&(a=a.slice(0,w)),a+=(a.indexOf("?")===-1?"?":"&")+y}return a}class ro{constructor(){this.handlers=[]}use(o,h,c){return this.handlers.push({fulfilled:o,rejected:h,synchronous:c?c.synchronous:!1,runWhen:c?c.runWhen:null}),this.handlers.length-1}eject(o){this.handlers[o]&&(this.handlers[o]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(o){O.forEach(this.handlers,function(c){c!==null&&o(c)})}}const Io={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},hl=typeof URLSearchParams<"u"?URLSearchParams:Ti,dl=typeof FormData<"u"?FormData:null,fl=typeof Blob<"u"?Blob:null,pl={isBrowser:!0,classes:{URLSearchParams:hl,FormData:dl,Blob:fl},protocols:["http","https","file","blob","url","data"]},Ai=typeof window<"u"&&typeof document<"u",pi=typeof navigator=="object"&&navigator||void 0,gl=Ai&&(!pi||["ReactNative","NativeScript","NS"].indexOf(pi.product)<0),ml=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",yl=Ai&&window.location.href||"http://localhost",bl=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:Ai,hasStandardBrowserEnv:gl,hasStandardBrowserWebWorkerEnv:ml,navigator:pi,origin:yl},Symbol.toStringTag,{value:"Module"})),Ie={...bl,...pl};function vl(a,o){return Js(a,new Ie.classes.URLSearchParams,Object.assign({visitor:function(h,c,p,y){return Ie.isNode&&O.isBuffer(h)?(this.append(c,h.toString("base64")),!1):y.defaultVisitor.apply(this,arguments)}},o))}function wl(a){return O.matchAll(/\w+|\[(\w*)]/g,a).map(o=>o[0]==="[]"?"":o[1]||o[0])}function Cl(a){const o={},h=Object.keys(a);let c;const p=h.length;let y;for(c=0;c<p;c++)y=h[c],o[y]=a[y];return o}function Mo(a){function o(h,c,p,y){let w=h[y++];if(w==="__proto__")return!0;const k=Number.isFinite(+w),x=y>=h.length;return w=!w&&O.isArray(p)?p.length:w,x?(O.hasOwnProp(p,w)?p[w]=[p[w],c]:p[w]=c,!k):((!p[w]||!O.isObject(p[w]))&&(p[w]=[]),o(h,c,p[w],y)&&O.isArray(p[w])&&(p[w]=Cl(p[w])),!k)}if(O.isFormData(a)&&O.isFunction(a.entries)){const h={};return O.forEachEntry(a,(c,p)=>{o(wl(c),p,h,0)}),h}return null}function Sl(a,o,h){if(O.isString(a))try{return(o||JSON.parse)(a),O.trim(a)}catch(c){if(c.name!=="SyntaxError")throw c}return(h||JSON.stringify)(a)}const Wn={transitional:Io,adapter:["xhr","http","fetch"],transformRequest:[function(o,h){const c=h.getContentType()||"",p=c.indexOf("application/json")>-1,y=O.isObject(o);if(y&&O.isHTMLForm(o)&&(o=new FormData(o)),O.isFormData(o))return p?JSON.stringify(Mo(o)):o;if(O.isArrayBuffer(o)||O.isBuffer(o)||O.isStream(o)||O.isFile(o)||O.isBlob(o)||O.isReadableStream(o))return o;if(O.isArrayBufferView(o))return o.buffer;if(O.isURLSearchParams(o))return h.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),o.toString();let k;if(y){if(c.indexOf("application/x-www-form-urlencoded")>-1)return vl(o,this.formSerializer).toString();if((k=O.isFileList(o))||c.indexOf("multipart/form-data")>-1){const x=this.env&&this.env.FormData;return Js(k?{"files[]":o}:o,x&&new x,this.formSerializer)}}return y||p?(h.setContentType("application/json",!1),Sl(o)):o}],transformResponse:[function(o){const h=this.transitional||Wn.transitional,c=h&&h.forcedJSONParsing,p=this.responseType==="json";if(O.isResponse(o)||O.isReadableStream(o))return o;if(o&&O.isString(o)&&(c&&!this.responseType||p)){const w=!(h&&h.silentJSONParsing)&&p;try{return JSON.parse(o)}catch(k){if(w)throw k.name==="SyntaxError"?te.from(k,te.ERR_BAD_RESPONSE,this,null,this.response):k}}return o}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Ie.classes.FormData,Blob:Ie.classes.Blob},validateStatus:function(o){return o>=200&&o<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};O.forEach(["delete","get","head","post","put","patch"],a=>{Wn.headers[a]={}});const _l=O.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),Rl=a=>{const o={};let h,c,p;return a&&a.split(`
`).forEach(function(w){p=w.indexOf(":"),h=w.substring(0,p).trim().toLowerCase(),c=w.substring(p+1).trim(),!(!h||o[h]&&_l[h])&&(h==="set-cookie"?o[h]?o[h].push(c):o[h]=[c]:o[h]=o[h]?o[h]+", "+c:c)}),o},io=Symbol("internals");function Un(a){return a&&String(a).trim().toLowerCase()}function Us(a){return a===!1||a==null?a:O.isArray(a)?a.map(Us):String(a)}function Ol(a){const o=Object.create(null),h=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let c;for(;c=h.exec(a);)o[c[1]]=c[2];return o}const kl=a=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(a.trim());function ai(a,o,h,c,p){if(O.isFunction(c))return c.call(this,o,h);if(p&&(o=h),!!O.isString(o)){if(O.isString(c))return o.indexOf(c)!==-1;if(O.isRegExp(c))return c.test(o)}}function Tl(a){return a.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(o,h,c)=>h.toUpperCase()+c)}function Al(a,o){const h=O.toCamelCase(" "+o);["get","set","has"].forEach(c=>{Object.defineProperty(a,c+h,{value:function(p,y,w){return this[c].call(this,o,p,y,w)},configurable:!0})})}let Ne=class{constructor(o){o&&this.set(o)}set(o,h,c){const p=this;function y(k,x,N){const I=Un(x);if(!I)throw new Error("header name must be a non-empty string");const D=O.findKey(p,I);(!D||p[D]===void 0||N===!0||N===void 0&&p[D]!==!1)&&(p[D||x]=Us(k))}const w=(k,x)=>O.forEach(k,(N,I)=>y(N,I,x));if(O.isPlainObject(o)||o instanceof this.constructor)w(o,h);else if(O.isString(o)&&(o=o.trim())&&!kl(o))w(Rl(o),h);else if(O.isHeaders(o))for(const[k,x]of o.entries())y(x,k,c);else o!=null&&y(h,o,c);return this}get(o,h){if(o=Un(o),o){const c=O.findKey(this,o);if(c){const p=this[c];if(!h)return p;if(h===!0)return Ol(p);if(O.isFunction(h))return h.call(this,p,c);if(O.isRegExp(h))return h.exec(p);throw new TypeError("parser must be boolean|regexp|function")}}}has(o,h){if(o=Un(o),o){const c=O.findKey(this,o);return!!(c&&this[c]!==void 0&&(!h||ai(this,this[c],c,h)))}return!1}delete(o,h){const c=this;let p=!1;function y(w){if(w=Un(w),w){const k=O.findKey(c,w);k&&(!h||ai(c,c[k],k,h))&&(delete c[k],p=!0)}}return O.isArray(o)?o.forEach(y):y(o),p}clear(o){const h=Object.keys(this);let c=h.length,p=!1;for(;c--;){const y=h[c];(!o||ai(this,this[y],y,o,!0))&&(delete this[y],p=!0)}return p}normalize(o){const h=this,c={};return O.forEach(this,(p,y)=>{const w=O.findKey(c,y);if(w){h[w]=Us(p),delete h[y];return}const k=o?Tl(y):String(y).trim();k!==y&&delete h[y],h[k]=Us(p),c[k]=!0}),this}concat(...o){return this.constructor.concat(this,...o)}toJSON(o){const h=Object.create(null);return O.forEach(this,(c,p)=>{c!=null&&c!==!1&&(h[p]=o&&O.isArray(c)?c.join(", "):c)}),h}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([o,h])=>o+": "+h).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(o){return o instanceof this?o:new this(o)}static concat(o,...h){const c=new this(o);return h.forEach(p=>c.set(p)),c}static accessor(o){const c=(this[io]=this[io]={accessors:{}}).accessors,p=this.prototype;function y(w){const k=Un(w);c[k]||(Al(p,w),c[k]=!0)}return O.isArray(o)?o.forEach(y):y(o),this}};Ne.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);O.reduceDescriptors(Ne.prototype,({value:a},o)=>{let h=o[0].toUpperCase()+o.slice(1);return{get:()=>a,set(c){this[h]=c}}});O.freezeMethods(Ne);function ci(a,o){const h=this||Wn,c=o||h,p=Ne.from(c.headers);let y=c.data;return O.forEach(a,function(k){y=k.call(h,y,p.normalize(),o?o.status:void 0)}),p.normalize(),y}function xo(a){return!!(a&&a.__CANCEL__)}function Qt(a,o,h){te.call(this,a??"canceled",te.ERR_CANCELED,o,h),this.name="CanceledError"}O.inherits(Qt,te,{__CANCEL__:!0});function Lo(a,o,h){const c=h.config.validateStatus;!h.status||!c||c(h.status)?a(h):o(new te("Request failed with status code "+h.status,[te.ERR_BAD_REQUEST,te.ERR_BAD_RESPONSE][Math.floor(h.status/100)-4],h.config,h.request,h))}function El(a){const o=/^([-+\w]{1,25})(:?\/\/|:)/.exec(a);return o&&o[1]||""}function Pl(a,o){a=a||10;const h=new Array(a),c=new Array(a);let p=0,y=0,w;return o=o!==void 0?o:1e3,function(x){const N=Date.now(),I=c[y];w||(w=N),h[p]=x,c[p]=N;let D=y,F=0;for(;D!==p;)F+=h[D++],D=D%a;if(p=(p+1)%a,p===y&&(y=(y+1)%a),N-w<o)return;const H=I&&N-I;return H?Math.round(F*1e3/H):void 0}}function Il(a,o){let h=0,c=1e3/o,p,y;const w=(N,I=Date.now())=>{h=I,p=null,y&&(clearTimeout(y),y=null),a.apply(null,N)};return[(...N)=>{const I=Date.now(),D=I-h;D>=c?w(N,I):(p=N,y||(y=setTimeout(()=>{y=null,w(p)},c-D)))},()=>p&&w(p)]}const js=(a,o,h=3)=>{let c=0;const p=Pl(50,250);return Il(y=>{const w=y.loaded,k=y.lengthComputable?y.total:void 0,x=w-c,N=p(x),I=w<=k;c=w;const D={loaded:w,total:k,progress:k?w/k:void 0,bytes:x,rate:N||void 0,estimated:N&&k&&I?(k-w)/N:void 0,event:y,lengthComputable:k!=null,[o?"download":"upload"]:!0};a(D)},h)},oo=(a,o)=>{const h=a!=null;return[c=>o[0]({lengthComputable:h,total:a,loaded:c}),o[1]]},ao=a=>(...o)=>O.asap(()=>a(...o)),Ml=Ie.hasStandardBrowserEnv?((a,o)=>h=>(h=new URL(h,Ie.origin),a.protocol===h.protocol&&a.host===h.host&&(o||a.port===h.port)))(new URL(Ie.origin),Ie.navigator&&/(msie|trident)/i.test(Ie.navigator.userAgent)):()=>!0,xl=Ie.hasStandardBrowserEnv?{write(a,o,h,c,p,y){const w=[a+"="+encodeURIComponent(o)];O.isNumber(h)&&w.push("expires="+new Date(h).toGMTString()),O.isString(c)&&w.push("path="+c),O.isString(p)&&w.push("domain="+p),y===!0&&w.push("secure"),document.cookie=w.join("; ")},read(a){const o=document.cookie.match(new RegExp("(^|;\\s*)("+a+")=([^;]*)"));return o?decodeURIComponent(o[3]):null},remove(a){this.write(a,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function Ll(a){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(a)}function Nl(a,o){return o?a.replace(/\/?\/$/,"")+"/"+o.replace(/^\/+/,""):a}function No(a,o,h){let c=!Ll(o);return a&&c||h==!1?Nl(a,o):o}const co=a=>a instanceof Ne?{...a}:a;function Tt(a,o){o=o||{};const h={};function c(N,I,D,F){return O.isPlainObject(N)&&O.isPlainObject(I)?O.merge.call({caseless:F},N,I):O.isPlainObject(I)?O.merge({},I):O.isArray(I)?I.slice():I}function p(N,I,D,F){if(O.isUndefined(I)){if(!O.isUndefined(N))return c(void 0,N,D,F)}else return c(N,I,D,F)}function y(N,I){if(!O.isUndefined(I))return c(void 0,I)}function w(N,I){if(O.isUndefined(I)){if(!O.isUndefined(N))return c(void 0,N)}else return c(void 0,I)}function k(N,I,D){if(D in o)return c(N,I);if(D in a)return c(void 0,N)}const x={url:y,method:y,data:y,baseURL:w,transformRequest:w,transformResponse:w,paramsSerializer:w,timeout:w,timeoutMessage:w,withCredentials:w,withXSRFToken:w,adapter:w,responseType:w,xsrfCookieName:w,xsrfHeaderName:w,onUploadProgress:w,onDownloadProgress:w,decompress:w,maxContentLength:w,maxBodyLength:w,beforeRedirect:w,transport:w,httpAgent:w,httpsAgent:w,cancelToken:w,socketPath:w,responseEncoding:w,validateStatus:k,headers:(N,I,D)=>p(co(N),co(I),D,!0)};return O.forEach(Object.keys(Object.assign({},a,o)),function(I){const D=x[I]||p,F=D(a[I],o[I],I);O.isUndefined(F)&&D!==k||(h[I]=F)}),h}const Uo=a=>{const o=Tt({},a);let{data:h,withXSRFToken:c,xsrfHeaderName:p,xsrfCookieName:y,headers:w,auth:k}=o;o.headers=w=Ne.from(w),o.url=Po(No(o.baseURL,o.url,o.allowAbsoluteUrls),a.params,a.paramsSerializer),k&&w.set("Authorization","Basic "+btoa((k.username||"")+":"+(k.password?unescape(encodeURIComponent(k.password)):"")));let x;if(O.isFormData(h)){if(Ie.hasStandardBrowserEnv||Ie.hasStandardBrowserWebWorkerEnv)w.setContentType(void 0);else if((x=w.getContentType())!==!1){const[N,...I]=x?x.split(";").map(D=>D.trim()).filter(Boolean):[];w.setContentType([N||"multipart/form-data",...I].join("; "))}}if(Ie.hasStandardBrowserEnv&&(c&&O.isFunction(c)&&(c=c(o)),c||c!==!1&&Ml(o.url))){const N=p&&y&&xl.read(y);N&&w.set(p,N)}return o},Ul=typeof XMLHttpRequest<"u",ql=Ul&&function(a){return new Promise(function(h,c){const p=Uo(a);let y=p.data;const w=Ne.from(p.headers).normalize();let{responseType:k,onUploadProgress:x,onDownloadProgress:N}=p,I,D,F,H,L;function U(){H&&H(),L&&L(),p.cancelToken&&p.cancelToken.unsubscribe(I),p.signal&&p.signal.removeEventListener("abort",I)}let R=new XMLHttpRequest;R.open(p.method.toUpperCase(),p.url,!0),R.timeout=p.timeout;function q(){if(!R)return;const K=Ne.from("getAllResponseHeaders"in R&&R.getAllResponseHeaders()),ne={data:!k||k==="text"||k==="json"?R.responseText:R.response,status:R.status,statusText:R.statusText,headers:K,config:a,request:R};Lo(function(ve){h(ve),U()},function(ve){c(ve),U()},ne),R=null}"onloadend"in R?R.onloadend=q:R.onreadystatechange=function(){!R||R.readyState!==4||R.status===0&&!(R.responseURL&&R.responseURL.indexOf("file:")===0)||setTimeout(q)},R.onabort=function(){R&&(c(new te("Request aborted",te.ECONNABORTED,a,R)),R=null)},R.onerror=function(){c(new te("Network Error",te.ERR_NETWORK,a,R)),R=null},R.ontimeout=function(){let _=p.timeout?"timeout of "+p.timeout+"ms exceeded":"timeout exceeded";const ne=p.transitional||Io;p.timeoutErrorMessage&&(_=p.timeoutErrorMessage),c(new te(_,ne.clarifyTimeoutError?te.ETIMEDOUT:te.ECONNABORTED,a,R)),R=null},y===void 0&&w.setContentType(null),"setRequestHeader"in R&&O.forEach(w.toJSON(),function(_,ne){R.setRequestHeader(ne,_)}),O.isUndefined(p.withCredentials)||(R.withCredentials=!!p.withCredentials),k&&k!=="json"&&(R.responseType=p.responseType),N&&([F,L]=js(N,!0),R.addEventListener("progress",F)),x&&R.upload&&([D,H]=js(x),R.upload.addEventListener("progress",D),R.upload.addEventListener("loadend",H)),(p.cancelToken||p.signal)&&(I=K=>{R&&(c(!K||K.type?new Qt(null,a,R):K),R.abort(),R=null)},p.cancelToken&&p.cancelToken.subscribe(I),p.signal&&(p.signal.aborted?I():p.signal.addEventListener("abort",I)));const W=El(p.url);if(W&&Ie.protocols.indexOf(W)===-1){c(new te("Unsupported protocol "+W+":",te.ERR_BAD_REQUEST,a));return}R.send(y||null)})},Dl=(a,o)=>{const{length:h}=a=a?a.filter(Boolean):[];if(o||h){let c=new AbortController,p;const y=function(N){if(!p){p=!0,k();const I=N instanceof Error?N:this.reason;c.abort(I instanceof te?I:new Qt(I instanceof Error?I.message:I))}};let w=o&&setTimeout(()=>{w=null,y(new te(`timeout ${o} of ms exceeded`,te.ETIMEDOUT))},o);const k=()=>{a&&(w&&clearTimeout(w),w=null,a.forEach(N=>{N.unsubscribe?N.unsubscribe(y):N.removeEventListener("abort",y)}),a=null)};a.forEach(N=>N.addEventListener("abort",y));const{signal:x}=c;return x.unsubscribe=()=>O.asap(k),x}},Bl=function*(a,o){let h=a.byteLength;if(h<o){yield a;return}let c=0,p;for(;c<h;)p=c+o,yield a.slice(c,p),c=p},jl=async function*(a,o){for await(const h of Hl(a))yield*Bl(h,o)},Hl=async function*(a){if(a[Symbol.asyncIterator]){yield*a;return}const o=a.getReader();try{for(;;){const{done:h,value:c}=await o.read();if(h)break;yield c}}finally{await o.cancel()}},lo=(a,o,h,c)=>{const p=jl(a,o);let y=0,w,k=x=>{w||(w=!0,c&&c(x))};return new ReadableStream({async pull(x){try{const{done:N,value:I}=await p.next();if(N){k(),x.close();return}let D=I.byteLength;if(h){let F=y+=D;h(F)}x.enqueue(new Uint8Array(I))}catch(N){throw k(N),N}},cancel(x){return k(x),p.return()}},{highWaterMark:2})},$s=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",qo=$s&&typeof ReadableStream=="function",Gl=$s&&(typeof TextEncoder=="function"?(a=>o=>a.encode(o))(new TextEncoder):async a=>new Uint8Array(await new Response(a).arrayBuffer())),Do=(a,...o)=>{try{return!!a(...o)}catch{return!1}},Fl=qo&&Do(()=>{let a=!1;const o=new Request(Ie.origin,{body:new ReadableStream,method:"POST",get duplex(){return a=!0,"half"}}).headers.has("Content-Type");return a&&!o}),uo=64*1024,gi=qo&&Do(()=>O.isReadableStream(new Response("").body)),Hs={stream:gi&&(a=>a.body)};$s&&(a=>{["text","arrayBuffer","blob","formData","stream"].forEach(o=>{!Hs[o]&&(Hs[o]=O.isFunction(a[o])?h=>h[o]():(h,c)=>{throw new te(`Response type '${o}' is not supported`,te.ERR_NOT_SUPPORT,c)})})})(new Response);const Wl=async a=>{if(a==null)return 0;if(O.isBlob(a))return a.size;if(O.isSpecCompliantForm(a))return(await new Request(Ie.origin,{method:"POST",body:a}).arrayBuffer()).byteLength;if(O.isArrayBufferView(a)||O.isArrayBuffer(a))return a.byteLength;if(O.isURLSearchParams(a)&&(a=a+""),O.isString(a))return(await Gl(a)).byteLength},zl=async(a,o)=>{const h=O.toFiniteNumber(a.getContentLength());return h??Wl(o)},Vl=$s&&(async a=>{let{url:o,method:h,data:c,signal:p,cancelToken:y,timeout:w,onDownloadProgress:k,onUploadProgress:x,responseType:N,headers:I,withCredentials:D="same-origin",fetchOptions:F}=Uo(a);N=N?(N+"").toLowerCase():"text";let H=Dl([p,y&&y.toAbortSignal()],w),L;const U=H&&H.unsubscribe&&(()=>{H.unsubscribe()});let R;try{if(x&&Fl&&h!=="get"&&h!=="head"&&(R=await zl(I,c))!==0){let ne=new Request(o,{method:"POST",body:c,duplex:"half"}),ue;if(O.isFormData(c)&&(ue=ne.headers.get("content-type"))&&I.setContentType(ue),ne.body){const[ve,we]=oo(R,js(ao(x)));c=lo(ne.body,uo,ve,we)}}O.isString(D)||(D=D?"include":"omit");const q="credentials"in Request.prototype;L=new Request(o,{...F,signal:H,method:h.toUpperCase(),headers:I.normalize().toJSON(),body:c,duplex:"half",credentials:q?D:void 0});let W=await fetch(L);const K=gi&&(N==="stream"||N==="response");if(gi&&(k||K&&U)){const ne={};["status","statusText","headers"].forEach(ge=>{ne[ge]=W[ge]});const ue=O.toFiniteNumber(W.headers.get("content-length")),[ve,we]=k&&oo(ue,js(ao(k),!0))||[];W=new Response(lo(W.body,uo,ve,()=>{we&&we(),U&&U()}),ne)}N=N||"text";let _=await Hs[O.findKey(Hs,N)||"text"](W,a);return!K&&U&&U(),await new Promise((ne,ue)=>{Lo(ne,ue,{data:_,headers:Ne.from(W.headers),status:W.status,statusText:W.statusText,config:a,request:L})})}catch(q){throw U&&U(),q&&q.name==="TypeError"&&/fetch/i.test(q.message)?Object.assign(new te("Network Error",te.ERR_NETWORK,a,L),{cause:q.cause||q}):te.from(q,q&&q.code,a,L)}}),mi={http:al,xhr:ql,fetch:Vl};O.forEach(mi,(a,o)=>{if(a){try{Object.defineProperty(a,"name",{value:o})}catch{}Object.defineProperty(a,"adapterName",{value:o})}});const ho=a=>`- ${a}`,Jl=a=>O.isFunction(a)||a===null||a===!1,Bo={getAdapter:a=>{a=O.isArray(a)?a:[a];const{length:o}=a;let h,c;const p={};for(let y=0;y<o;y++){h=a[y];let w;if(c=h,!Jl(h)&&(c=mi[(w=String(h)).toLowerCase()],c===void 0))throw new te(`Unknown adapter '${w}'`);if(c)break;p[w||"#"+y]=c}if(!c){const y=Object.entries(p).map(([k,x])=>`adapter ${k} `+(x===!1?"is not supported by the environment":"is not available in the build"));let w=o?y.length>1?`since :
`+y.map(ho).join(`
`):" "+ho(y[0]):"as no adapter specified";throw new te("There is no suitable adapter to dispatch the request "+w,"ERR_NOT_SUPPORT")}return c},adapters:mi};function li(a){if(a.cancelToken&&a.cancelToken.throwIfRequested(),a.signal&&a.signal.aborted)throw new Qt(null,a)}function fo(a){return li(a),a.headers=Ne.from(a.headers),a.data=ci.call(a,a.transformRequest),["post","put","patch"].indexOf(a.method)!==-1&&a.headers.setContentType("application/x-www-form-urlencoded",!1),Bo.getAdapter(a.adapter||Wn.adapter)(a).then(function(c){return li(a),c.data=ci.call(a,a.transformResponse,c),c.headers=Ne.from(c.headers),c},function(c){return xo(c)||(li(a),c&&c.response&&(c.response.data=ci.call(a,a.transformResponse,c.response),c.response.headers=Ne.from(c.response.headers))),Promise.reject(c)})}const jo="1.8.3",Ks={};["object","boolean","number","function","string","symbol"].forEach((a,o)=>{Ks[a]=function(c){return typeof c===a||"a"+(o<1?"n ":" ")+a}});const po={};Ks.transitional=function(o,h,c){function p(y,w){return"[Axios v"+jo+"] Transitional option '"+y+"'"+w+(c?". "+c:"")}return(y,w,k)=>{if(o===!1)throw new te(p(w," has been removed"+(h?" in "+h:"")),te.ERR_DEPRECATED);return h&&!po[w]&&(po[w]=!0,console.warn(p(w," has been deprecated since v"+h+" and will be removed in the near future"))),o?o(y,w,k):!0}};Ks.spelling=function(o){return(h,c)=>(console.warn(`${c} is likely a misspelling of ${o}`),!0)};function $l(a,o,h){if(typeof a!="object")throw new te("options must be an object",te.ERR_BAD_OPTION_VALUE);const c=Object.keys(a);let p=c.length;for(;p-- >0;){const y=c[p],w=o[y];if(w){const k=a[y],x=k===void 0||w(k,y,a);if(x!==!0)throw new te("option "+y+" must be "+x,te.ERR_BAD_OPTION_VALUE);continue}if(h!==!0)throw new te("Unknown option "+y,te.ERR_BAD_OPTION)}}const qs={assertOptions:$l,validators:Ks},tt=qs.validators;let kt=class{constructor(o){this.defaults=o,this.interceptors={request:new ro,response:new ro}}async request(o,h){try{return await this._request(o,h)}catch(c){if(c instanceof Error){let p={};Error.captureStackTrace?Error.captureStackTrace(p):p=new Error;const y=p.stack?p.stack.replace(/^.+\n/,""):"";try{c.stack?y&&!String(c.stack).endsWith(y.replace(/^.+\n.+\n/,""))&&(c.stack+=`
`+y):c.stack=y}catch{}}throw c}}_request(o,h){typeof o=="string"?(h=h||{},h.url=o):h=o||{},h=Tt(this.defaults,h);const{transitional:c,paramsSerializer:p,headers:y}=h;c!==void 0&&qs.assertOptions(c,{silentJSONParsing:tt.transitional(tt.boolean),forcedJSONParsing:tt.transitional(tt.boolean),clarifyTimeoutError:tt.transitional(tt.boolean)},!1),p!=null&&(O.isFunction(p)?h.paramsSerializer={serialize:p}:qs.assertOptions(p,{encode:tt.function,serialize:tt.function},!0)),h.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?h.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:h.allowAbsoluteUrls=!0),qs.assertOptions(h,{baseUrl:tt.spelling("baseURL"),withXsrfToken:tt.spelling("withXSRFToken")},!0),h.method=(h.method||this.defaults.method||"get").toLowerCase();let w=y&&O.merge(y.common,y[h.method]);y&&O.forEach(["delete","get","head","post","put","patch","common"],L=>{delete y[L]}),h.headers=Ne.concat(w,y);const k=[];let x=!0;this.interceptors.request.forEach(function(U){typeof U.runWhen=="function"&&U.runWhen(h)===!1||(x=x&&U.synchronous,k.unshift(U.fulfilled,U.rejected))});const N=[];this.interceptors.response.forEach(function(U){N.push(U.fulfilled,U.rejected)});let I,D=0,F;if(!x){const L=[fo.bind(this),void 0];for(L.unshift.apply(L,k),L.push.apply(L,N),F=L.length,I=Promise.resolve(h);D<F;)I=I.then(L[D++],L[D++]);return I}F=k.length;let H=h;for(D=0;D<F;){const L=k[D++],U=k[D++];try{H=L(H)}catch(R){U.call(this,R);break}}try{I=fo.call(this,H)}catch(L){return Promise.reject(L)}for(D=0,F=N.length;D<F;)I=I.then(N[D++],N[D++]);return I}getUri(o){o=Tt(this.defaults,o);const h=No(o.baseURL,o.url,o.allowAbsoluteUrls);return Po(h,o.params,o.paramsSerializer)}};O.forEach(["delete","get","head","options"],function(o){kt.prototype[o]=function(h,c){return this.request(Tt(c||{},{method:o,url:h,data:(c||{}).data}))}});O.forEach(["post","put","patch"],function(o){function h(c){return function(y,w,k){return this.request(Tt(k||{},{method:o,headers:c?{"Content-Type":"multipart/form-data"}:{},url:y,data:w}))}}kt.prototype[o]=h(),kt.prototype[o+"Form"]=h(!0)});let Kl=class Ho{constructor(o){if(typeof o!="function")throw new TypeError("executor must be a function.");let h;this.promise=new Promise(function(y){h=y});const c=this;this.promise.then(p=>{if(!c._listeners)return;let y=c._listeners.length;for(;y-- >0;)c._listeners[y](p);c._listeners=null}),this.promise.then=p=>{let y;const w=new Promise(k=>{c.subscribe(k),y=k}).then(p);return w.cancel=function(){c.unsubscribe(y)},w},o(function(y,w,k){c.reason||(c.reason=new Qt(y,w,k),h(c.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(o){if(this.reason){o(this.reason);return}this._listeners?this._listeners.push(o):this._listeners=[o]}unsubscribe(o){if(!this._listeners)return;const h=this._listeners.indexOf(o);h!==-1&&this._listeners.splice(h,1)}toAbortSignal(){const o=new AbortController,h=c=>{o.abort(c)};return this.subscribe(h),o.signal.unsubscribe=()=>this.unsubscribe(h),o.signal}static source(){let o;return{token:new Ho(function(p){o=p}),cancel:o}}};function Xl(a){return function(h){return a.apply(null,h)}}function Ql(a){return O.isObject(a)&&a.isAxiosError===!0}const yi={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(yi).forEach(([a,o])=>{yi[o]=a});function Go(a){const o=new kt(a),h=vo(kt.prototype.request,o);return O.extend(h,kt.prototype,o,{allOwnKeys:!0}),O.extend(h,o,null,{allOwnKeys:!0}),h.create=function(p){return Go(Tt(a,p))},h}const ye=Go(Wn);ye.Axios=kt;ye.CanceledError=Qt;ye.CancelToken=Kl;ye.isCancel=xo;ye.VERSION=jo;ye.toFormData=Js;ye.AxiosError=te;ye.Cancel=ye.CanceledError;ye.all=function(o){return Promise.all(o)};ye.spread=Xl;ye.isAxiosError=Ql;ye.mergeConfig=Tt;ye.AxiosHeaders=Ne;ye.formToJSON=a=>Mo(O.isHTMLForm(a)?new FormData(a):a);ye.getAdapter=Bo.getAdapter;ye.HttpStatusCode=yi;ye.default=ye;const{Axios:wu,AxiosError:Cu,CanceledError:Su,isCancel:_u,CancelToken:Ru,VERSION:Ou,all:ku,Cancel:Tu,isAxiosError:Au,spread:Eu,toFormData:Pu,AxiosHeaders:Iu,HttpStatusCode:Mu,formToJSON:xu,getAdapter:Lu,mergeConfig:Nu}=ye;function Yl(a){if(a===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function Ue(a,o,h){return o=Gs(o),tu(a,Fo()?Reflect.construct(o,h||[],Gs(a).constructor):o.apply(a,h))}function ke(a,o){if(!(a instanceof o))throw new TypeError("Cannot call a class as a function")}function Zl(a,o){for(var h=0;h<o.length;h++){var c=o[h];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,Wo(c.key),c)}}function Te(a,o,h){return o&&Zl(a.prototype,o),Object.defineProperty(a,"prototype",{writable:!1}),a}function eu(a,o,h){return(o=Wo(o))in a?Object.defineProperty(a,o,{value:h,enumerable:!0,configurable:!0,writable:!0}):a[o]=h,a}function Gs(a){return Gs=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(o){return o.__proto__||Object.getPrototypeOf(o)},Gs(a)}function qe(a,o){if(typeof o!="function"&&o!==null)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(o&&o.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),Object.defineProperty(a,"prototype",{writable:!1}),o&&bi(a,o)}function Fo(){try{var a=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Fo=function(){return!!a})()}function go(a,o){var h=Object.keys(a);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(a);o&&(c=c.filter(function(p){return Object.getOwnPropertyDescriptor(a,p).enumerable})),h.push.apply(h,c)}return h}function jn(a){for(var o=1;o<arguments.length;o++){var h=arguments[o]!=null?arguments[o]:{};o%2?go(Object(h),!0).forEach(function(c){eu(a,c,h[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(h)):go(Object(h)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(h,c))})}return a}function tu(a,o){if(o&&(typeof o=="object"||typeof o=="function"))return o;if(o!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Yl(a)}function bi(a,o){return bi=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(h,c){return h.__proto__=c,h},bi(a,o)}function nu(a,o){if(typeof a!="object"||!a)return a;var h=a[Symbol.toPrimitive];if(h!==void 0){var c=h.call(a,o);if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(a)}function Wo(a){var o=nu(a,"string");return typeof o=="symbol"?o:o+""}function Hn(a){"@babel/helpers - typeof";return Hn=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(o){return typeof o}:function(o){return o&&typeof Symbol=="function"&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},Hn(a)}var Ei=function(){function a(){ke(this,a)}return Te(a,[{key:"listenForWhisper",value:function(h,c){return this.listen(".client-"+h,c)}},{key:"notification",value:function(h){return this.listen(".Illuminate\\Notifications\\Events\\BroadcastNotificationCreated",h)}},{key:"stopListeningForWhisper",value:function(h,c){return this.stopListening(".client-"+h,c)}}])}(),zo=function(){function a(o){ke(this,a),this.namespace=o}return Te(a,[{key:"format",value:function(h){return[".","\\"].includes(h.charAt(0))?h.substring(1):(this.namespace&&(h=this.namespace+"."+h),h.replace(/\./g,"\\"))}},{key:"setNamespace",value:function(h){this.namespace=h}}])}();function su(a){try{new a}catch(o){if(o instanceof Error&&o.message.includes("is not a constructor"))return!1}return!0}var Pi=function(a){function o(h,c,p){var y;return ke(this,o),y=Ue(this,o),y.name=c,y.pusher=h,y.options=p,y.eventFormatter=new zo(y.options.namespace),y.subscribe(),y}return qe(o,a),Te(o,[{key:"subscribe",value:function(){this.subscription=this.pusher.subscribe(this.name)}},{key:"unsubscribe",value:function(){this.pusher.unsubscribe(this.name)}},{key:"listen",value:function(c,p){return this.on(this.eventFormatter.format(c),p),this}},{key:"listenToAll",value:function(c){var p=this;return this.subscription.bind_global(function(y,w){var k;if(!y.startsWith("pusher:")){var x=String((k=p.options.namespace)!==null&&k!==void 0?k:"").replace(/\./g,"\\"),N=y.startsWith(x)?y.substring(x.length+1):"."+y;c(N,w)}}),this}},{key:"stopListening",value:function(c,p){return p?this.subscription.unbind(this.eventFormatter.format(c),p):this.subscription.unbind(this.eventFormatter.format(c)),this}},{key:"stopListeningToAll",value:function(c){return c?this.subscription.unbind_global(c):this.subscription.unbind_global(),this}},{key:"subscribed",value:function(c){return this.on("pusher:subscription_succeeded",function(){c()}),this}},{key:"error",value:function(c){return this.on("pusher:subscription_error",function(p){c(p)}),this}},{key:"on",value:function(c,p){return this.subscription.bind(c,p),this}}])}(Ei),Vo=function(a){function o(){return ke(this,o),Ue(this,o,arguments)}return qe(o,a),Te(o,[{key:"whisper",value:function(c,p){return this.pusher.channels.channels[this.name].trigger("client-".concat(c),p),this}}])}(Pi),ru=function(a){function o(){return ke(this,o),Ue(this,o,arguments)}return qe(o,a),Te(o,[{key:"whisper",value:function(c,p){return this.pusher.channels.channels[this.name].trigger("client-".concat(c),p),this}}])}(Pi),iu=function(a){function o(){return ke(this,o),Ue(this,o,arguments)}return qe(o,a),Te(o,[{key:"here",value:function(c){return this.on("pusher:subscription_succeeded",function(p){c(Object.keys(p.members).map(function(y){return p.members[y]}))}),this}},{key:"joining",value:function(c){return this.on("pusher:member_added",function(p){c(p.info)}),this}},{key:"whisper",value:function(c,p){return this.pusher.channels.channels[this.name].trigger("client-".concat(c),p),this}},{key:"leaving",value:function(c){return this.on("pusher:member_removed",function(p){c(p.info)}),this}}])}(Vo),Jo=function(a){function o(h,c,p){var y;return ke(this,o),y=Ue(this,o),y.events={},y.listeners={},y.name=c,y.socket=h,y.options=p,y.eventFormatter=new zo(y.options.namespace),y.subscribe(),y}return qe(o,a),Te(o,[{key:"subscribe",value:function(){this.socket.emit("subscribe",{channel:this.name,auth:this.options.auth||{}})}},{key:"unsubscribe",value:function(){this.unbind(),this.socket.emit("unsubscribe",{channel:this.name,auth:this.options.auth||{}})}},{key:"listen",value:function(c,p){return this.on(this.eventFormatter.format(c),p),this}},{key:"stopListening",value:function(c,p){return this.unbindEvent(this.eventFormatter.format(c),p),this}},{key:"subscribed",value:function(c){return this.on("connect",function(p){c(p)}),this}},{key:"error",value:function(c){return this}},{key:"on",value:function(c,p){var y=this;return this.listeners[c]=this.listeners[c]||[],this.events[c]||(this.events[c]=function(w,k){y.name===w&&y.listeners[c]&&y.listeners[c].forEach(function(x){return x(k)})},this.socket.on(c,this.events[c])),this.listeners[c].push(p),this}},{key:"unbind",value:function(){var c=this;Object.keys(this.events).forEach(function(p){c.unbindEvent(p)})}},{key:"unbindEvent",value:function(c,p){this.listeners[c]=this.listeners[c]||[],p&&(this.listeners[c]=this.listeners[c].filter(function(y){return y!==p})),(!p||this.listeners[c].length===0)&&(this.events[c]&&(this.socket.removeListener(c,this.events[c]),delete this.events[c]),delete this.listeners[c])}}])}(Ei),$o=function(a){function o(){return ke(this,o),Ue(this,o,arguments)}return qe(o,a),Te(o,[{key:"whisper",value:function(c,p){return this.socket.emit("client event",{channel:this.name,event:"client-".concat(c),data:p}),this}}])}(Jo),ou=function(a){function o(){return ke(this,o),Ue(this,o,arguments)}return qe(o,a),Te(o,[{key:"here",value:function(c){return this.on("presence:subscribed",function(p){c(p.map(function(y){return y.user_info}))}),this}},{key:"joining",value:function(c){return this.on("presence:joining",function(p){return c(p.user_info)}),this}},{key:"whisper",value:function(c,p){return this.socket.emit("client event",{channel:this.name,event:"client-".concat(c),data:p}),this}},{key:"leaving",value:function(c){return this.on("presence:leaving",function(p){return c(p.user_info)}),this}}])}($o),Fs=function(a){function o(){return ke(this,o),Ue(this,o,arguments)}return qe(o,a),Te(o,[{key:"subscribe",value:function(){}},{key:"unsubscribe",value:function(){}},{key:"listen",value:function(c,p){return this}},{key:"listenToAll",value:function(c){return this}},{key:"stopListening",value:function(c,p){return this}},{key:"subscribed",value:function(c){return this}},{key:"error",value:function(c){return this}},{key:"on",value:function(c,p){return this}}])}(Ei),Ko=function(a){function o(){return ke(this,o),Ue(this,o,arguments)}return qe(o,a),Te(o,[{key:"whisper",value:function(c,p){return this}}])}(Fs),au=function(a){function o(){return ke(this,o),Ue(this,o,arguments)}return qe(o,a),Te(o,[{key:"whisper",value:function(c,p){return this}}])}(Fs),cu=function(a){function o(){return ke(this,o),Ue(this,o,arguments)}return qe(o,a),Te(o,[{key:"here",value:function(c){return this}},{key:"joining",value:function(c){return this}},{key:"whisper",value:function(c,p){return this}},{key:"leaving",value:function(c){return this}}])}(Ko),Xs=function(){function a(o){ke(this,a),this.setOptions(o),this.connect()}return Te(a,[{key:"setOptions",value:function(h){this.options=jn(jn(jn({},a._defaultOptions),h),{},{broadcaster:h.broadcaster});var c=this.csrfToken();c&&(this.options.auth.headers["X-CSRF-TOKEN"]=c,this.options.userAuthentication.headers["X-CSRF-TOKEN"]=c),c=this.options.bearerToken,c&&(this.options.auth.headers.Authorization="Bearer "+c,this.options.userAuthentication.headers.Authorization="Bearer "+c)}},{key:"csrfToken",value:function(){var h;return typeof window<"u"&&typeof window.Laravel<"u"&&window.Laravel.csrfToken?window.Laravel.csrfToken:this.options.csrfToken?this.options.csrfToken:typeof document<"u"&&typeof document.querySelector=="function"&&(h=document.querySelector('meta[name="csrf-token"]'))?h.getAttribute("content"):null}}])}();Xs._defaultOptions={auth:{headers:{}},authEndpoint:"/broadcasting/auth",userAuthentication:{endpoint:"/broadcasting/user-auth",headers:{}},csrfToken:null,bearerToken:null,host:null,key:null,namespace:"App.Events"};var ui=function(a){function o(){var h;return ke(this,o),h=Ue(this,o,arguments),h.channels={},h}return qe(o,a),Te(o,[{key:"connect",value:function(){if(typeof this.options.client<"u")this.pusher=this.options.client;else if(this.options.Pusher)this.pusher=new this.options.Pusher(this.options.key,this.options);else if(typeof window<"u"&&typeof window.Pusher<"u")this.pusher=new window.Pusher(this.options.key,this.options);else throw new Error("Pusher client not found. Should be globally available or passed via options.client")}},{key:"signin",value:function(){this.pusher.signin()}},{key:"listen",value:function(c,p,y){return this.channel(c).listen(p,y)}},{key:"channel",value:function(c){return this.channels[c]||(this.channels[c]=new Pi(this.pusher,c,this.options)),this.channels[c]}},{key:"privateChannel",value:function(c){return this.channels["private-"+c]||(this.channels["private-"+c]=new Vo(this.pusher,"private-"+c,this.options)),this.channels["private-"+c]}},{key:"encryptedPrivateChannel",value:function(c){return this.channels["private-encrypted-"+c]||(this.channels["private-encrypted-"+c]=new ru(this.pusher,"private-encrypted-"+c,this.options)),this.channels["private-encrypted-"+c]}},{key:"presenceChannel",value:function(c){return this.channels["presence-"+c]||(this.channels["presence-"+c]=new iu(this.pusher,"presence-"+c,this.options)),this.channels["presence-"+c]}},{key:"leave",value:function(c){var p=this,y=[c,"private-"+c,"private-encrypted-"+c,"presence-"+c];y.forEach(function(w){p.leaveChannel(w)})}},{key:"leaveChannel",value:function(c){this.channels[c]&&(this.channels[c].unsubscribe(),delete this.channels[c])}},{key:"socketId",value:function(){return this.pusher.connection.socket_id}},{key:"disconnect",value:function(){this.pusher.disconnect()}}])}(Xs),lu=function(a){function o(){var h;return ke(this,o),h=Ue(this,o,arguments),h.channels={},h}return qe(o,a),Te(o,[{key:"connect",value:function(){var c,p=this,y=this.getSocketIO();this.socket=y((c=this.options.host)!==null&&c!==void 0?c:void 0,this.options),this.socket.on("reconnect",function(){Object.values(p.channels).forEach(function(w){w.subscribe()})})}},{key:"getSocketIO",value:function(){if(typeof this.options.client<"u")return this.options.client;if(typeof window<"u"&&typeof window.io<"u")return window.io;throw new Error("Socket.io client not found. Should be globally available or passed via options.client")}},{key:"listen",value:function(c,p,y){return this.channel(c).listen(p,y)}},{key:"channel",value:function(c){return this.channels[c]||(this.channels[c]=new Jo(this.socket,c,this.options)),this.channels[c]}},{key:"privateChannel",value:function(c){return this.channels["private-"+c]||(this.channels["private-"+c]=new $o(this.socket,"private-"+c,this.options)),this.channels["private-"+c]}},{key:"presenceChannel",value:function(c){return this.channels["presence-"+c]||(this.channels["presence-"+c]=new ou(this.socket,"presence-"+c,this.options)),this.channels["presence-"+c]}},{key:"leave",value:function(c){var p=this,y=[c,"private-"+c,"presence-"+c];y.forEach(function(w){p.leaveChannel(w)})}},{key:"leaveChannel",value:function(c){this.channels[c]&&(this.channels[c].unsubscribe(),delete this.channels[c])}},{key:"socketId",value:function(){return this.socket.id}},{key:"disconnect",value:function(){this.socket.disconnect()}}])}(Xs),mo=function(a){function o(){var h;return ke(this,o),h=Ue(this,o,arguments),h.channels={},h}return qe(o,a),Te(o,[{key:"connect",value:function(){}},{key:"listen",value:function(c,p,y){return new Fs}},{key:"channel",value:function(c){return new Fs}},{key:"privateChannel",value:function(c){return new Ko}},{key:"encryptedPrivateChannel",value:function(c){return new au}},{key:"presenceChannel",value:function(c){return new cu}},{key:"leave",value:function(c){}},{key:"leaveChannel",value:function(c){}},{key:"socketId",value:function(){return"fake-socket-id"}},{key:"disconnect",value:function(){}}])}(Xs),uu=function(){function a(o){ke(this,a),this.options=o,this.connect(),this.options.withoutInterceptors||this.registerInterceptors()}return Te(a,[{key:"channel",value:function(h){return this.connector.channel(h)}},{key:"connect",value:function(){if(this.options.broadcaster==="reverb")this.connector=new ui(jn(jn({},this.options),{},{cluster:""}));else if(this.options.broadcaster==="pusher")this.connector=new ui(this.options);else if(this.options.broadcaster==="socket.io")this.connector=new lu(this.options);else if(this.options.broadcaster==="null")this.connector=new mo(this.options);else if(typeof this.options.broadcaster=="function"&&su(this.options.broadcaster))this.connector=new this.options.broadcaster(this.options);else throw new Error("Broadcaster ".concat(Hn(this.options.broadcaster)," ").concat(String(this.options.broadcaster)," is not supported."))}},{key:"disconnect",value:function(){this.connector.disconnect()}},{key:"join",value:function(h){return this.connector.presenceChannel(h)}},{key:"leave",value:function(h){this.connector.leave(h)}},{key:"leaveChannel",value:function(h){this.connector.leaveChannel(h)}},{key:"leaveAllChannels",value:function(){for(var h in this.connector.channels)this.leaveChannel(h)}},{key:"listen",value:function(h,c,p){return this.connector.listen(h,c,p)}},{key:"private",value:function(h){return this.connector.privateChannel(h)}},{key:"encryptedPrivate",value:function(h){if(this.connectorSupportsEncryptedPrivateChannels(this.connector))return this.connector.encryptedPrivateChannel(h);throw new Error("Broadcaster ".concat(Hn(this.options.broadcaster)," ").concat(String(this.options.broadcaster)," does not support encrypted private channels."))}},{key:"connectorSupportsEncryptedPrivateChannels",value:function(h){return h instanceof ui||h instanceof mo}},{key:"socketId",value:function(){return this.connector.socketId()}},{key:"registerInterceptors",value:function(){typeof Vue=="function"&&Vue.http&&this.registerVueRequestInterceptor(),typeof axios=="function"&&this.registerAxiosRequestInterceptor(),typeof jQuery=="function"&&this.registerjQueryAjaxSetup(),(typeof Turbo>"u"?"undefined":Hn(Turbo))==="object"&&this.registerTurboRequestInterceptor()}},{key:"registerVueRequestInterceptor",value:function(){var h=this;Vue.http.interceptors.push(function(c,p){h.socketId()&&c.headers.set("X-Socket-ID",h.socketId()),p()})}},{key:"registerAxiosRequestInterceptor",value:function(){var h=this;axios.interceptors.request.use(function(c){return h.socketId()&&(c.headers["X-Socket-Id"]=h.socketId()),c})}},{key:"registerjQueryAjaxSetup",value:function(){var h=this;typeof jQuery.ajax<"u"&&jQuery.ajaxPrefilter(function(c,p,y){h.socketId()&&y.setRequestHeader("X-Socket-Id",h.socketId())})}},{key:"registerTurboRequestInterceptor",value:function(){var h=this;document.addEventListener("turbo:before-fetch-request",function(c){c.detail.fetchOptions.headers["X-Socket-Id"]=h.socketId()})}}])}(),pt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Xo(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var hi={exports:{}};/*!
 * Pusher JavaScript Library v8.4.0
 * https://pusher.com/
 *
 * Copyright 2020, Pusher
 * Released under the MIT licence.
 */var yo;function hu(){return yo||(yo=1,function(a,o){(function(c,p){a.exports=p()})(window,function(){return function(h){var c={};function p(y){if(c[y])return c[y].exports;var w=c[y]={i:y,l:!1,exports:{}};return h[y].call(w.exports,w,w.exports,p),w.l=!0,w.exports}return p.m=h,p.c=c,p.d=function(y,w,k){p.o(y,w)||Object.defineProperty(y,w,{enumerable:!0,get:k})},p.r=function(y){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(y,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(y,"__esModule",{value:!0})},p.t=function(y,w){if(w&1&&(y=p(y)),w&8||w&4&&typeof y=="object"&&y&&y.__esModule)return y;var k=Object.create(null);if(p.r(k),Object.defineProperty(k,"default",{enumerable:!0,value:y}),w&2&&typeof y!="string")for(var x in y)p.d(k,x,(function(N){return y[N]}).bind(null,x));return k},p.n=function(y){var w=y&&y.__esModule?function(){return y.default}:function(){return y};return p.d(w,"a",w),w},p.o=function(y,w){return Object.prototype.hasOwnProperty.call(y,w)},p.p="",p(p.s=2)}([function(h,c,p){var y=this&&this.__extends||function(){var U=function(R,q){return U=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(W,K){W.__proto__=K}||function(W,K){for(var _ in K)K.hasOwnProperty(_)&&(W[_]=K[_])},U(R,q)};return function(R,q){U(R,q);function W(){this.constructor=R}R.prototype=q===null?Object.create(q):(W.prototype=q.prototype,new W)}}();Object.defineProperty(c,"__esModule",{value:!0});var w=256,k=function(){function U(R){R===void 0&&(R="="),this._paddingCharacter=R}return U.prototype.encodedLength=function(R){return this._paddingCharacter?(R+2)/3*4|0:(R*8+5)/6|0},U.prototype.encode=function(R){for(var q="",W=0;W<R.length-2;W+=3){var K=R[W]<<16|R[W+1]<<8|R[W+2];q+=this._encodeByte(K>>>3*6&63),q+=this._encodeByte(K>>>2*6&63),q+=this._encodeByte(K>>>1*6&63),q+=this._encodeByte(K>>>0*6&63)}var _=R.length-W;if(_>0){var K=R[W]<<16|(_===2?R[W+1]<<8:0);q+=this._encodeByte(K>>>3*6&63),q+=this._encodeByte(K>>>2*6&63),_===2?q+=this._encodeByte(K>>>1*6&63):q+=this._paddingCharacter||"",q+=this._paddingCharacter||""}return q},U.prototype.maxDecodedLength=function(R){return this._paddingCharacter?R/4*3|0:(R*6+7)/8|0},U.prototype.decodedLength=function(R){return this.maxDecodedLength(R.length-this._getPaddingLength(R))},U.prototype.decode=function(R){if(R.length===0)return new Uint8Array(0);for(var q=this._getPaddingLength(R),W=R.length-q,K=new Uint8Array(this.maxDecodedLength(W)),_=0,ne=0,ue=0,ve=0,we=0,ge=0,Ke=0;ne<W-4;ne+=4)ve=this._decodeChar(R.charCodeAt(ne+0)),we=this._decodeChar(R.charCodeAt(ne+1)),ge=this._decodeChar(R.charCodeAt(ne+2)),Ke=this._decodeChar(R.charCodeAt(ne+3)),K[_++]=ve<<2|we>>>4,K[_++]=we<<4|ge>>>2,K[_++]=ge<<6|Ke,ue|=ve&w,ue|=we&w,ue|=ge&w,ue|=Ke&w;if(ne<W-1&&(ve=this._decodeChar(R.charCodeAt(ne)),we=this._decodeChar(R.charCodeAt(ne+1)),K[_++]=ve<<2|we>>>4,ue|=ve&w,ue|=we&w),ne<W-2&&(ge=this._decodeChar(R.charCodeAt(ne+2)),K[_++]=we<<4|ge>>>2,ue|=ge&w),ne<W-3&&(Ke=this._decodeChar(R.charCodeAt(ne+3)),K[_++]=ge<<6|Ke,ue|=Ke&w),ue!==0)throw new Error("Base64Coder: incorrect characters for decoding");return K},U.prototype._encodeByte=function(R){var q=R;return q+=65,q+=25-R>>>8&6,q+=51-R>>>8&-75,q+=61-R>>>8&-15,q+=62-R>>>8&3,String.fromCharCode(q)},U.prototype._decodeChar=function(R){var q=w;return q+=(42-R&R-44)>>>8&-256+R-43+62,q+=(46-R&R-48)>>>8&-256+R-47+63,q+=(47-R&R-58)>>>8&-256+R-48+52,q+=(64-R&R-91)>>>8&-256+R-65+0,q+=(96-R&R-123)>>>8&-256+R-97+26,q},U.prototype._getPaddingLength=function(R){var q=0;if(this._paddingCharacter){for(var W=R.length-1;W>=0&&R[W]===this._paddingCharacter;W--)q++;if(R.length<4||q>2)throw new Error("Base64Coder: incorrect padding")}return q},U}();c.Coder=k;var x=new k;function N(U){return x.encode(U)}c.encode=N;function I(U){return x.decode(U)}c.decode=I;var D=function(U){y(R,U);function R(){return U!==null&&U.apply(this,arguments)||this}return R.prototype._encodeByte=function(q){var W=q;return W+=65,W+=25-q>>>8&6,W+=51-q>>>8&-75,W+=61-q>>>8&-13,W+=62-q>>>8&49,String.fromCharCode(W)},R.prototype._decodeChar=function(q){var W=w;return W+=(44-q&q-46)>>>8&-256+q-45+62,W+=(94-q&q-96)>>>8&-256+q-95+63,W+=(47-q&q-58)>>>8&-256+q-48+52,W+=(64-q&q-91)>>>8&-256+q-65+0,W+=(96-q&q-123)>>>8&-256+q-97+26,W},R}(k);c.URLSafeCoder=D;var F=new D;function H(U){return F.encode(U)}c.encodeURLSafe=H;function L(U){return F.decode(U)}c.decodeURLSafe=L,c.encodedLength=function(U){return x.encodedLength(U)},c.maxDecodedLength=function(U){return x.maxDecodedLength(U)},c.decodedLength=function(U){return x.decodedLength(U)}},function(h,c,p){Object.defineProperty(c,"__esModule",{value:!0});var y="utf8: invalid string",w="utf8: invalid source encoding";function k(I){for(var D=new Uint8Array(x(I)),F=0,H=0;H<I.length;H++){var L=I.charCodeAt(H);L<128?D[F++]=L:L<2048?(D[F++]=192|L>>6,D[F++]=128|L&63):L<55296?(D[F++]=224|L>>12,D[F++]=128|L>>6&63,D[F++]=128|L&63):(H++,L=(L&1023)<<10,L|=I.charCodeAt(H)&1023,L+=65536,D[F++]=240|L>>18,D[F++]=128|L>>12&63,D[F++]=128|L>>6&63,D[F++]=128|L&63)}return D}c.encode=k;function x(I){for(var D=0,F=0;F<I.length;F++){var H=I.charCodeAt(F);if(H<128)D+=1;else if(H<2048)D+=2;else if(H<55296)D+=3;else if(H<=57343){if(F>=I.length-1)throw new Error(y);F++,D+=4}else throw new Error(y)}return D}c.encodedLength=x;function N(I){for(var D=[],F=0;F<I.length;F++){var H=I[F];if(H&128){var L=void 0;if(H<224){if(F>=I.length)throw new Error(w);var U=I[++F];if((U&192)!==128)throw new Error(w);H=(H&31)<<6|U&63,L=128}else if(H<240){if(F>=I.length-1)throw new Error(w);var U=I[++F],R=I[++F];if((U&192)!==128||(R&192)!==128)throw new Error(w);H=(H&15)<<12|(U&63)<<6|R&63,L=2048}else if(H<248){if(F>=I.length-2)throw new Error(w);var U=I[++F],R=I[++F],q=I[++F];if((U&192)!==128||(R&192)!==128||(q&192)!==128)throw new Error(w);H=(H&15)<<18|(U&63)<<12|(R&63)<<6|q&63,L=65536}else throw new Error(w);if(H<L||H>=55296&&H<=57343)throw new Error(w);if(H>=65536){if(H>1114111)throw new Error(w);H-=65536,D.push(String.fromCharCode(55296|H>>10)),H=56320|H&1023}}D.push(String.fromCharCode(H))}return D.join("")}c.decode=N},function(h,c,p){h.exports=p(3).default},function(h,c,p){p.r(c);class y{constructor(r,l){this.lastId=0,this.prefix=r,this.name=l}create(r){this.lastId++;var l=this.lastId,m=this.prefix+l,v=this.name+"["+l+"]",T=!1,B=function(){T||(r.apply(null,arguments),T=!0)};return this[l]=B,{number:l,id:m,name:v,callback:B}}remove(r){delete this[r.number]}}var w=new y("_pusher_script_","Pusher.ScriptReceivers"),k={VERSION:"8.4.0",PROTOCOL:7,wsPort:80,wssPort:443,wsPath:"",httpHost:"sockjs.pusher.com",httpPort:80,httpsPort:443,httpPath:"/pusher",stats_host:"stats.pusher.com",authEndpoint:"/pusher/auth",authTransport:"ajax",activityTimeout:12e4,pongTimeout:3e4,unavailableTimeout:1e4,userAuthentication:{endpoint:"/pusher/user-auth",transport:"ajax"},channelAuthorization:{endpoint:"/pusher/auth",transport:"ajax"},cdn_http:"http://js.pusher.com",cdn_https:"https://js.pusher.com",dependency_suffix:""},x=k;class N{constructor(r){this.options=r,this.receivers=r.receivers||w,this.loading={}}load(r,l,m){var v=this;if(v.loading[r]&&v.loading[r].length>0)v.loading[r].push(m);else{v.loading[r]=[m];var T=Y.createScriptRequest(v.getPath(r,l)),B=v.receivers.create(function(z){if(v.receivers.remove(B),v.loading[r]){var X=v.loading[r];delete v.loading[r];for(var se=function(pe){pe||T.cleanup()},re=0;re<X.length;re++)X[re](z,se)}});T.send(B)}}getRoot(r){var l,m=Y.getDocument().location.protocol;return r&&r.useTLS||m==="https:"?l=this.options.cdn_https:l=this.options.cdn_http,l.replace(/\/*$/,"")+"/"+this.options.version}getPath(r,l){return this.getRoot(l)+"/"+r+this.options.suffix+".js"}}var I=new y("_pusher_dependencies","Pusher.DependenciesReceivers"),D=new N({cdn_http:x.cdn_http,cdn_https:x.cdn_https,version:x.VERSION,suffix:x.dependency_suffix,receivers:I});const F={baseUrl:"https://pusher.com",urls:{authenticationEndpoint:{path:"/docs/channels/server_api/authenticating_users"},authorizationEndpoint:{path:"/docs/channels/server_api/authorizing-users/"},javascriptQuickStart:{path:"/docs/javascript_quick_start"},triggeringClientEvents:{path:"/docs/client_api_guide/client_events#trigger-events"},encryptedChannelSupport:{fullUrl:"https://github.com/pusher/pusher-js/tree/cc491015371a4bde5743d1c87a0fbac0feb53195#encrypted-channel-support"}}};var L={buildLogSuffix:function(d){const r="See:",l=F.urls[d];if(!l)return"";let m;return l.fullUrl?m=l.fullUrl:l.path&&(m=F.baseUrl+l.path),m?`${r} ${m}`:""}},U;(function(d){d.UserAuthentication="user-authentication",d.ChannelAuthorization="channel-authorization"})(U||(U={}));class R extends Error{constructor(r){super(r),Object.setPrototypeOf(this,new.target.prototype)}}class q extends Error{constructor(r){super(r),Object.setPrototypeOf(this,new.target.prototype)}}class W extends Error{constructor(r){super(r),Object.setPrototypeOf(this,new.target.prototype)}}class K extends Error{constructor(r){super(r),Object.setPrototypeOf(this,new.target.prototype)}}class _ extends Error{constructor(r){super(r),Object.setPrototypeOf(this,new.target.prototype)}}class ne extends Error{constructor(r){super(r),Object.setPrototypeOf(this,new.target.prototype)}}class ue extends Error{constructor(r){super(r),Object.setPrototypeOf(this,new.target.prototype)}}class ve extends Error{constructor(r){super(r),Object.setPrototypeOf(this,new.target.prototype)}}class we extends Error{constructor(r,l){super(l),this.status=r,Object.setPrototypeOf(this,new.target.prototype)}}var Ke=function(d,r,l,m,v){const T=Y.createXHR();T.open("POST",l.endpoint,!0),T.setRequestHeader("Content-Type","application/x-www-form-urlencoded");for(var B in l.headers)T.setRequestHeader(B,l.headers[B]);if(l.headersProvider!=null){let z=l.headersProvider();for(var B in z)T.setRequestHeader(B,z[B])}return T.onreadystatechange=function(){if(T.readyState===4)if(T.status===200){let z,X=!1;try{z=JSON.parse(T.responseText),X=!0}catch{v(new we(200,`JSON returned from ${m.toString()} endpoint was invalid, yet status code was 200. Data was: ${T.responseText}`),null)}X&&v(null,z)}else{let z="";switch(m){case U.UserAuthentication:z=L.buildLogSuffix("authenticationEndpoint");break;case U.ChannelAuthorization:z=`Clients must be authorized to join private or presence channels. ${L.buildLogSuffix("authorizationEndpoint")}`;break}v(new we(T.status,`Unable to retrieve auth string from ${m.toString()} endpoint - received status: ${T.status} from ${l.endpoint}. ${z}`),null)}},T.send(r),T};function f(d){return Z(Re(d))}var nt=String.fromCharCode,gt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",A=function(d){var r=d.charCodeAt(0);return r<128?d:r<2048?nt(192|r>>>6)+nt(128|r&63):nt(224|r>>>12&15)+nt(128|r>>>6&63)+nt(128|r&63)},Re=function(d){return d.replace(/[^\x00-\x7F]/g,A)},Qs=function(d){var r=[0,2,1][d.length%3],l=d.charCodeAt(0)<<16|(d.length>1?d.charCodeAt(1):0)<<8|(d.length>2?d.charCodeAt(2):0),m=[gt.charAt(l>>>18),gt.charAt(l>>>12&63),r>=2?"=":gt.charAt(l>>>6&63),r>=1?"=":gt.charAt(l&63)];return m.join("")},Z=window.btoa||function(d){return d.replace(/[\s\S]{1,3}/g,Qs)};class ot{constructor(r,l,m,v){this.clear=l,this.timer=r(()=>{this.timer&&(this.timer=v(this.timer))},m)}isRunning(){return this.timer!==null}ensureAborted(){this.timer&&(this.clear(this.timer),this.timer=null)}}var Yt=ot;function at(d){window.clearTimeout(d)}function Ys(d){window.clearInterval(d)}class Ce extends Yt{constructor(r,l){super(setTimeout,at,r,function(m){return l(),null})}}class Zs extends Yt{constructor(r,l){super(setInterval,Ys,r,function(m){return l(),m})}}var zn={now(){return Date.now?Date.now():new Date().valueOf()},defer(d){return new Ce(0,d)},method(d,...r){var l=Array.prototype.slice.call(arguments,1);return function(m){return m[d].apply(m,l.concat(arguments))}}},Oe=zn;function Ae(d,...r){for(var l=0;l<r.length;l++){var m=r[l];for(var v in m)m[v]&&m[v].constructor&&m[v].constructor===Object?d[v]=Ae(d[v]||{},m[v]):d[v]=m[v]}return d}function Vn(){for(var d=["Pusher"],r=0;r<arguments.length;r++)typeof arguments[r]=="string"?d.push(arguments[r]):d.push(bt(arguments[r]));return d.join(" : ")}function Zt(d,r){var l=Array.prototype.indexOf;if(d===null)return-1;if(l&&d.indexOf===l)return d.indexOf(r);for(var m=0,v=d.length;m<v;m++)if(d[m]===r)return m;return-1}function je(d,r){for(var l in d)Object.prototype.hasOwnProperty.call(d,l)&&r(d[l],l,d)}function Jn(d){var r=[];return je(d,function(l,m){r.push(m)}),r}function $n(d){var r=[];return je(d,function(l){r.push(l)}),r}function mt(d,r,l){for(var m=0;m<d.length;m++)r.call(l||window,d[m],m,d)}function ct(d,r){for(var l=[],m=0;m<d.length;m++)l.push(r(d[m],m,d,l));return l}function Kn(d,r){var l={};return je(d,function(m,v){l[v]=r(m)}),l}function en(d,r){r=r||function(v){return!!v};for(var l=[],m=0;m<d.length;m++)r(d[m],m,d,l)&&l.push(d[m]);return l}function tn(d,r){var l={};return je(d,function(m,v){(r&&r(m,v,d,l)||m)&&(l[v]=m)}),l}function Xn(d){var r=[];return je(d,function(l,m){r.push([m,l])}),r}function At(d,r){for(var l=0;l<d.length;l++)if(r(d[l],l,d))return!0;return!1}function yt(d,r){for(var l=0;l<d.length;l++)if(!r(d[l],l,d))return!1;return!0}function Et(d){return Kn(d,function(r){return typeof r=="object"&&(r=bt(r)),encodeURIComponent(f(r.toString()))})}function nn(d){var r=tn(d,function(m){return m!==void 0}),l=ct(Xn(Et(r)),Oe.method("join","=")).join("&");return l}function oe(d){var r=[],l=[];return function m(v,T){var B,z,X;switch(typeof v){case"object":if(!v)return null;for(B=0;B<r.length;B+=1)if(r[B]===v)return{$ref:l[B]};if(r.push(v),l.push(T),Object.prototype.toString.apply(v)==="[object Array]")for(X=[],B=0;B<v.length;B+=1)X[B]=m(v[B],T+"["+B+"]");else{X={};for(z in v)Object.prototype.hasOwnProperty.call(v,z)&&(X[z]=m(v[z],T+"["+JSON.stringify(z)+"]"))}return X;case"number":case"string":case"boolean":return v}}(d,"$")}function bt(d){try{return JSON.stringify(d)}catch{return JSON.stringify(oe(d))}}class Qn{constructor(){this.globalLog=r=>{window.console&&window.console.log&&window.console.log(r)}}debug(...r){this.log(this.globalLog,r)}warn(...r){this.log(this.globalLogWarn,r)}error(...r){this.log(this.globalLogError,r)}globalLogWarn(r){window.console&&window.console.warn?window.console.warn(r):this.globalLog(r)}globalLogError(r){window.console&&window.console.error?window.console.error(r):this.globalLogWarn(r)}log(r,...l){var m=Vn.apply(this,arguments);ze.log?ze.log(m):ze.logToConsole&&r.bind(this)(m)}}var ae=new Qn,Yn=function(d,r,l,m,v){(l.headers!==void 0||l.headersProvider!=null)&&ae.warn(`To send headers with the ${m.toString()} request, you must use AJAX, rather than JSONP.`);var T=d.nextAuthCallbackID.toString();d.nextAuthCallbackID++;var B=d.getDocument(),z=B.createElement("script");d.auth_callbacks[T]=function(re){v(null,re)};var X="Pusher.auth_callbacks['"+T+"']";z.src=l.endpoint+"?callback="+encodeURIComponent(X)+"&"+r;var se=B.getElementsByTagName("head")[0]||B.documentElement;se.insertBefore(z,se.firstChild)},Zn=Yn;class Ee{constructor(r){this.src=r}send(r){var l=this,m="Error loading "+l.src;l.script=document.createElement("script"),l.script.id=r.id,l.script.src=l.src,l.script.type="text/javascript",l.script.charset="UTF-8",l.script.addEventListener?(l.script.onerror=function(){r.callback(m)},l.script.onload=function(){r.callback(null)}):l.script.onreadystatechange=function(){(l.script.readyState==="loaded"||l.script.readyState==="complete")&&r.callback(null)},l.script.async===void 0&&document.attachEvent&&/opera/i.test(navigator.userAgent)?(l.errorScript=document.createElement("script"),l.errorScript.id=r.id+"_error",l.errorScript.text=r.name+"('"+m+"');",l.script.async=l.errorScript.async=!1):l.script.async=!0;var v=document.getElementsByTagName("head")[0];v.insertBefore(l.script,v.firstChild),l.errorScript&&v.insertBefore(l.errorScript,l.script.nextSibling)}cleanup(){this.script&&(this.script.onload=this.script.onerror=null,this.script.onreadystatechange=null),this.script&&this.script.parentNode&&this.script.parentNode.removeChild(this.script),this.errorScript&&this.errorScript.parentNode&&this.errorScript.parentNode.removeChild(this.errorScript),this.script=null,this.errorScript=null}}class Me{constructor(r,l){this.url=r,this.data=l}send(r){if(!this.request){var l=nn(this.data),m=this.url+"/"+r.number+"?"+l;this.request=Y.createScriptRequest(m),this.request.send(r)}}cleanup(){this.request&&this.request.cleanup()}}var He=function(d,r){return function(l,m){var v="http"+(r?"s":"")+"://",T=v+(d.host||d.options.host)+d.options.path,B=Y.createJSONPRequest(T,l),z=Y.ScriptReceivers.create(function(X,se){w.remove(z),B.cleanup(),se&&se.host&&(d.host=se.host),m&&m(X,se)});B.send(z)}},sn={name:"jsonp",getAgent:He},es=sn;function Pt(d,r,l){var m=d+(r.useTLS?"s":""),v=r.useTLS?r.hostTLS:r.hostNonTLS;return m+"://"+v+l}function It(d,r){var l="/app/"+d,m="?protocol="+x.PROTOCOL+"&client=js&version="+x.VERSION+(r?"&"+r:"");return l+m}var rn={getInitial:function(d,r){var l=(r.httpPath||"")+It(d,"flash=false");return Pt("ws",r,l)}},on={getInitial:function(d,r){var l=(r.httpPath||"/pusher")+It(d);return Pt("http",r,l)}},ts={getInitial:function(d,r){return Pt("http",r,r.httpPath||"/pusher")},getPath:function(d,r){return It(d)}};class ns{constructor(){this._callbacks={}}get(r){return this._callbacks[lt(r)]}add(r,l,m){var v=lt(r);this._callbacks[v]=this._callbacks[v]||[],this._callbacks[v].push({fn:l,context:m})}remove(r,l,m){if(!r&&!l&&!m){this._callbacks={};return}var v=r?[lt(r)]:Jn(this._callbacks);l||m?this.removeCallback(v,l,m):this.removeAllCallbacks(v)}removeCallback(r,l,m){mt(r,function(v){this._callbacks[v]=en(this._callbacks[v]||[],function(T){return l&&l!==T.fn||m&&m!==T.context}),this._callbacks[v].length===0&&delete this._callbacks[v]},this)}removeAllCallbacks(r){mt(r,function(l){delete this._callbacks[l]},this)}}function lt(d){return"_"+d}class Ge{constructor(r){this.callbacks=new ns,this.global_callbacks=[],this.failThrough=r}bind(r,l,m){return this.callbacks.add(r,l,m),this}bind_global(r){return this.global_callbacks.push(r),this}unbind(r,l,m){return this.callbacks.remove(r,l,m),this}unbind_global(r){return r?(this.global_callbacks=en(this.global_callbacks||[],l=>l!==r),this):(this.global_callbacks=[],this)}unbind_all(){return this.unbind(),this.unbind_global(),this}emit(r,l,m){for(var v=0;v<this.global_callbacks.length;v++)this.global_callbacks[v](r,l);var T=this.callbacks.get(r),B=[];if(m?B.push(l,m):l&&B.push(l),T&&T.length>0)for(var v=0;v<T.length;v++)T[v].fn.apply(T[v].context||window,B);else this.failThrough&&this.failThrough(r,l);return this}}class Mt extends Ge{constructor(r,l,m,v,T){super(),this.initialize=Y.transportConnectionInitializer,this.hooks=r,this.name=l,this.priority=m,this.key=v,this.options=T,this.state="new",this.timeline=T.timeline,this.activityTimeout=T.activityTimeout,this.id=this.timeline.generateUniqueID()}handlesActivityChecks(){return!!this.hooks.handlesActivityChecks}supportsPing(){return!!this.hooks.supportsPing}connect(){if(this.socket||this.state!=="initialized")return!1;var r=this.hooks.urls.getInitial(this.key,this.options);try{this.socket=this.hooks.getSocket(r,this.options)}catch(l){return Oe.defer(()=>{this.onError(l),this.changeState("closed")}),!1}return this.bindListeners(),ae.debug("Connecting",{transport:this.name,url:r}),this.changeState("connecting"),!0}close(){return this.socket?(this.socket.close(),!0):!1}send(r){return this.state==="open"?(Oe.defer(()=>{this.socket&&this.socket.send(r)}),!0):!1}ping(){this.state==="open"&&this.supportsPing()&&this.socket.ping()}onOpen(){this.hooks.beforeOpen&&this.hooks.beforeOpen(this.socket,this.hooks.urls.getPath(this.key,this.options)),this.changeState("open"),this.socket.onopen=void 0}onError(r){this.emit("error",{type:"WebSocketError",error:r}),this.timeline.error(this.buildTimelineMessage({error:r.toString()}))}onClose(r){r?this.changeState("closed",{code:r.code,reason:r.reason,wasClean:r.wasClean}):this.changeState("closed"),this.unbindListeners(),this.socket=void 0}onMessage(r){this.emit("message",r)}onActivity(){this.emit("activity")}bindListeners(){this.socket.onopen=()=>{this.onOpen()},this.socket.onerror=r=>{this.onError(r)},this.socket.onclose=r=>{this.onClose(r)},this.socket.onmessage=r=>{this.onMessage(r)},this.supportsPing()&&(this.socket.onactivity=()=>{this.onActivity()})}unbindListeners(){this.socket&&(this.socket.onopen=void 0,this.socket.onerror=void 0,this.socket.onclose=void 0,this.socket.onmessage=void 0,this.supportsPing()&&(this.socket.onactivity=void 0))}changeState(r,l){this.state=r,this.timeline.info(this.buildTimelineMessage({state:r,params:l})),this.emit(r,l)}buildTimelineMessage(r){return Ae({cid:this.id},r)}}class be{constructor(r){this.hooks=r}isSupported(r){return this.hooks.isSupported(r)}createConnection(r,l,m,v){return new Mt(this.hooks,r,l,m,v)}}var ss=new be({urls:rn,handlesActivityChecks:!1,supportsPing:!1,isInitialized:function(){return!!Y.getWebSocketAPI()},isSupported:function(){return!!Y.getWebSocketAPI()},getSocket:function(d){return Y.createWebSocket(d)}}),an={urls:on,handlesActivityChecks:!1,supportsPing:!0,isInitialized:function(){return!0}},rs=Ae({getSocket:function(d){return Y.HTTPFactory.createStreamingSocket(d)}},an),Se=Ae({getSocket:function(d){return Y.HTTPFactory.createPollingSocket(d)}},an),cn={isSupported:function(){return Y.isXHRSupported()}},er=new be(Ae({},rs,cn)),tr=new be(Ae({},Se,cn)),is={ws:ss,xhr_streaming:er,xhr_polling:tr},vt=is,nr=new be({file:"sockjs",urls:ts,handlesActivityChecks:!0,supportsPing:!1,isSupported:function(){return!0},isInitialized:function(){return window.SockJS!==void 0},getSocket:function(d,r){return new window.SockJS(d,null,{js_path:D.getPath("sockjs",{useTLS:r.useTLS}),ignore_null_origin:r.ignoreNullOrigin})},beforeOpen:function(d,r){d.send(JSON.stringify({path:r}))}}),ln={isSupported:function(d){var r=Y.isXDRSupported(d.useTLS);return r}},sr=new be(Ae({},rs,ln)),rr=new be(Ae({},Se,ln));vt.xdr_streaming=sr,vt.xdr_polling=rr,vt.sockjs=nr;var un=vt;class ir extends Ge{constructor(){super();var r=this;window.addEventListener!==void 0&&(window.addEventListener("online",function(){r.emit("online")},!1),window.addEventListener("offline",function(){r.emit("offline")},!1))}isOnline(){return window.navigator.onLine===void 0?!0:window.navigator.onLine}}var or=new ir;class xt{constructor(r,l,m){this.manager=r,this.transport=l,this.minPingDelay=m.minPingDelay,this.maxPingDelay=m.maxPingDelay,this.pingDelay=void 0}createConnection(r,l,m,v){v=Ae({},v,{activityTimeout:this.pingDelay});var T=this.transport.createConnection(r,l,m,v),B=null,z=function(){T.unbind("open",z),T.bind("closed",X),B=Oe.now()},X=se=>{if(T.unbind("closed",X),se.code===1002||se.code===1003)this.manager.reportDeath();else if(!se.wasClean&&B){var re=Oe.now()-B;re<2*this.maxPingDelay&&(this.manager.reportDeath(),this.pingDelay=Math.max(re/2,this.minPingDelay))}};return T.bind("open",z),T}isSupported(r){return this.manager.isAlive()&&this.transport.isSupported(r)}}const hn={decodeMessage:function(d){try{var r=JSON.parse(d.data),l=r.data;if(typeof l=="string")try{l=JSON.parse(r.data)}catch{}var m={event:r.event,channel:r.channel,data:l};return r.user_id&&(m.user_id=r.user_id),m}catch(v){throw{type:"MessageParseError",error:v,data:d.data}}},encodeMessage:function(d){return JSON.stringify(d)},processHandshake:function(d){var r=hn.decodeMessage(d);if(r.event==="pusher:connection_established"){if(!r.data.activity_timeout)throw"No activity timeout specified in handshake";return{action:"connected",id:r.data.socket_id,activityTimeout:r.data.activity_timeout*1e3}}else{if(r.event==="pusher:error")return{action:this.getCloseAction(r.data),error:this.getCloseError(r.data)};throw"Invalid handshake"}},getCloseAction:function(d){return d.code<4e3?d.code>=1002&&d.code<=1004?"backoff":null:d.code===4e3?"tls_only":d.code<4100?"refused":d.code<4200?"backoff":d.code<4300?"retry":"refused"},getCloseError:function(d){return d.code!==1e3&&d.code!==1001?{type:"PusherError",data:{code:d.code,message:d.reason||d.message}}:null}};var Fe=hn;class ar extends Ge{constructor(r,l){super(),this.id=r,this.transport=l,this.activityTimeout=l.activityTimeout,this.bindListeners()}handlesActivityChecks(){return this.transport.handlesActivityChecks()}send(r){return this.transport.send(r)}send_event(r,l,m){var v={event:r,data:l};return m&&(v.channel=m),ae.debug("Event sent",v),this.send(Fe.encodeMessage(v))}ping(){this.transport.supportsPing()?this.transport.ping():this.send_event("pusher:ping",{})}close(){this.transport.close()}bindListeners(){var r={message:m=>{var v;try{v=Fe.decodeMessage(m)}catch(T){this.emit("error",{type:"MessageParseError",error:T,data:m.data})}if(v!==void 0){switch(ae.debug("Event recd",v),v.event){case"pusher:error":this.emit("error",{type:"PusherError",data:v.data});break;case"pusher:ping":this.emit("ping");break;case"pusher:pong":this.emit("pong");break}this.emit("message",v)}},activity:()=>{this.emit("activity")},error:m=>{this.emit("error",m)},closed:m=>{l(),m&&m.code&&this.handleCloseEvent(m),this.transport=null,this.emit("closed")}},l=()=>{je(r,(m,v)=>{this.transport.unbind(v,m)})};je(r,(m,v)=>{this.transport.bind(v,m)})}handleCloseEvent(r){var l=Fe.getCloseAction(r),m=Fe.getCloseError(r);m&&this.emit("error",m),l&&this.emit(l,{action:l,error:m})}}class cr{constructor(r,l){this.transport=r,this.callback=l,this.bindListeners()}close(){this.unbindListeners(),this.transport.close()}bindListeners(){this.onMessage=r=>{this.unbindListeners();var l;try{l=Fe.processHandshake(r)}catch(m){this.finish("error",{error:m}),this.transport.close();return}l.action==="connected"?this.finish("connected",{connection:new ar(l.id,this.transport),activityTimeout:l.activityTimeout}):(this.finish(l.action,{error:l.error}),this.transport.close())},this.onClosed=r=>{this.unbindListeners();var l=Fe.getCloseAction(r)||"backoff",m=Fe.getCloseError(r);this.finish(l,{error:m})},this.transport.bind("message",this.onMessage),this.transport.bind("closed",this.onClosed)}unbindListeners(){this.transport.unbind("message",this.onMessage),this.transport.unbind("closed",this.onClosed)}finish(r,l){this.callback(Ae({transport:this.transport,action:r},l))}}class ${constructor(r,l){this.timeline=r,this.options=l||{}}send(r,l){this.timeline.isEmpty()||this.timeline.send(Y.TimelineTransport.getAgent(this,r),l)}}class dn extends Ge{constructor(r,l){super(function(m,v){ae.debug("No callbacks on "+r+" for "+m)}),this.name=r,this.pusher=l,this.subscribed=!1,this.subscriptionPending=!1,this.subscriptionCancelled=!1}authorize(r,l){return l(null,{auth:""})}trigger(r,l){if(r.indexOf("client-")!==0)throw new R("Event '"+r+"' does not start with 'client-'");if(!this.subscribed){var m=L.buildLogSuffix("triggeringClientEvents");ae.warn(`Client event triggered before channel 'subscription_succeeded' event . ${m}`)}return this.pusher.send_event(r,l,this.name)}disconnect(){this.subscribed=!1,this.subscriptionPending=!1}handleEvent(r){var l=r.event,m=r.data;if(l==="pusher_internal:subscription_succeeded")this.handleSubscriptionSucceededEvent(r);else if(l==="pusher_internal:subscription_count")this.handleSubscriptionCountEvent(r);else if(l.indexOf("pusher_internal:")!==0){var v={};this.emit(l,m,v)}}handleSubscriptionSucceededEvent(r){this.subscriptionPending=!1,this.subscribed=!0,this.subscriptionCancelled?this.pusher.unsubscribe(this.name):this.emit("pusher:subscription_succeeded",r.data)}handleSubscriptionCountEvent(r){r.data.subscription_count&&(this.subscriptionCount=r.data.subscription_count),this.emit("pusher:subscription_count",r.data)}subscribe(){this.subscribed||(this.subscriptionPending=!0,this.subscriptionCancelled=!1,this.authorize(this.pusher.connection.socket_id,(r,l)=>{r?(this.subscriptionPending=!1,ae.error(r.toString()),this.emit("pusher:subscription_error",Object.assign({},{type:"AuthError",error:r.message},r instanceof we?{status:r.status}:{}))):this.pusher.send_event("pusher:subscribe",{auth:l.auth,channel_data:l.channel_data,channel:this.name})}))}unsubscribe(){this.subscribed=!1,this.pusher.send_event("pusher:unsubscribe",{channel:this.name})}cancelSubscription(){this.subscriptionCancelled=!0}reinstateSubscription(){this.subscriptionCancelled=!1}}class fn extends dn{authorize(r,l){return this.pusher.config.channelAuthorizer({channelName:this.name,socketId:r},l)}}class pn{constructor(){this.reset()}get(r){return Object.prototype.hasOwnProperty.call(this.members,r)?{id:r,info:this.members[r]}:null}each(r){je(this.members,(l,m)=>{r(this.get(m))})}setMyID(r){this.myID=r}onSubscription(r){this.members=r.presence.hash,this.count=r.presence.count,this.me=this.get(this.myID)}addMember(r){return this.get(r.user_id)===null&&this.count++,this.members[r.user_id]=r.user_info,this.get(r.user_id)}removeMember(r){var l=this.get(r.user_id);return l&&(delete this.members[r.user_id],this.count--),l}reset(){this.members={},this.count=0,this.myID=null,this.me=null}}var os=function(d,r,l,m){function v(T){return T instanceof l?T:new l(function(B){B(T)})}return new(l||(l=Promise))(function(T,B){function z(re){try{se(m.next(re))}catch(pe){B(pe)}}function X(re){try{se(m.throw(re))}catch(pe){B(pe)}}function se(re){re.done?T(re.value):v(re.value).then(z,X)}se((m=m.apply(d,r||[])).next())})};class he extends fn{constructor(r,l){super(r,l),this.members=new pn}authorize(r,l){super.authorize(r,(m,v)=>os(this,void 0,void 0,function*(){if(!m)if(v=v,v.channel_data!=null){var T=JSON.parse(v.channel_data);this.members.setMyID(T.user_id)}else if(yield this.pusher.user.signinDonePromise,this.pusher.user.user_data!=null)this.members.setMyID(this.pusher.user.user_data.id);else{let B=L.buildLogSuffix("authorizationEndpoint");ae.error(`Invalid auth response for channel '${this.name}', expected 'channel_data' field. ${B}, or the user should be signed in.`),l("Invalid auth response");return}l(m,v)}))}handleEvent(r){var l=r.event;if(l.indexOf("pusher_internal:")===0)this.handleInternalEvent(r);else{var m=r.data,v={};r.user_id&&(v.user_id=r.user_id),this.emit(l,m,v)}}handleInternalEvent(r){var l=r.event,m=r.data;switch(l){case"pusher_internal:subscription_succeeded":this.handleSubscriptionSucceededEvent(r);break;case"pusher_internal:subscription_count":this.handleSubscriptionCountEvent(r);break;case"pusher_internal:member_added":var v=this.members.addMember(m);this.emit("pusher:member_added",v);break;case"pusher_internal:member_removed":var T=this.members.removeMember(m);T&&this.emit("pusher:member_removed",T);break}}handleSubscriptionSucceededEvent(r){this.subscriptionPending=!1,this.subscribed=!0,this.subscriptionCancelled?this.pusher.unsubscribe(this.name):(this.members.onSubscription(r.data),this.emit("pusher:subscription_succeeded",this.members))}disconnect(){this.members.reset(),super.disconnect()}}var as=p(1),gn=p(0);class Lt extends fn{constructor(r,l,m){super(r,l),this.key=null,this.nacl=m}authorize(r,l){super.authorize(r,(m,v)=>{if(m){l(m,v);return}let T=v.shared_secret;if(!T){l(new Error(`No shared_secret key in auth payload for encrypted channel: ${this.name}`),null);return}this.key=Object(gn.decode)(T),delete v.shared_secret,l(null,v)})}trigger(r,l){throw new ne("Client events are not currently supported for encrypted channels")}handleEvent(r){var l=r.event,m=r.data;if(l.indexOf("pusher_internal:")===0||l.indexOf("pusher:")===0){super.handleEvent(r);return}this.handleEncryptedEvent(l,m)}handleEncryptedEvent(r,l){if(!this.key){ae.debug("Received encrypted event before key has been retrieved from the authEndpoint");return}if(!l.ciphertext||!l.nonce){ae.error("Unexpected format for encrypted event, expected object with `ciphertext` and `nonce` fields, got: "+l);return}let m=Object(gn.decode)(l.ciphertext);if(m.length<this.nacl.secretbox.overheadLength){ae.error(`Expected encrypted event ciphertext length to be ${this.nacl.secretbox.overheadLength}, got: ${m.length}`);return}let v=Object(gn.decode)(l.nonce);if(v.length<this.nacl.secretbox.nonceLength){ae.error(`Expected encrypted event nonce length to be ${this.nacl.secretbox.nonceLength}, got: ${v.length}`);return}let T=this.nacl.secretbox.open(m,v,this.key);if(T===null){ae.debug("Failed to decrypt an event, probably because it was encrypted with a different key. Fetching a new key from the authEndpoint..."),this.authorize(this.pusher.connection.socket_id,(B,z)=>{if(B){ae.error(`Failed to make a request to the authEndpoint: ${z}. Unable to fetch new key, so dropping encrypted event`);return}if(T=this.nacl.secretbox.open(m,v,this.key),T===null){ae.error("Failed to decrypt event with new key. Dropping encrypted event");return}this.emit(r,this.getDataToEmit(T))});return}this.emit(r,this.getDataToEmit(T))}getDataToEmit(r){let l=Object(as.decode)(r);try{return JSON.parse(l)}catch{return l}}}class mn extends Ge{constructor(r,l){super(),this.state="initialized",this.connection=null,this.key=r,this.options=l,this.timeline=this.options.timeline,this.usingTLS=this.options.useTLS,this.errorCallbacks=this.buildErrorCallbacks(),this.connectionCallbacks=this.buildConnectionCallbacks(this.errorCallbacks),this.handshakeCallbacks=this.buildHandshakeCallbacks(this.errorCallbacks);var m=Y.getNetwork();m.bind("online",()=>{this.timeline.info({netinfo:"online"}),(this.state==="connecting"||this.state==="unavailable")&&this.retryIn(0)}),m.bind("offline",()=>{this.timeline.info({netinfo:"offline"}),this.connection&&this.sendActivityCheck()}),this.updateStrategy()}connect(){if(!(this.connection||this.runner)){if(!this.strategy.isSupported()){this.updateState("failed");return}this.updateState("connecting"),this.startConnecting(),this.setUnavailableTimer()}}send(r){return this.connection?this.connection.send(r):!1}send_event(r,l,m){return this.connection?this.connection.send_event(r,l,m):!1}disconnect(){this.disconnectInternally(),this.updateState("disconnected")}isUsingTLS(){return this.usingTLS}startConnecting(){var r=(l,m)=>{l?this.runner=this.strategy.connect(0,r):m.action==="error"?(this.emit("error",{type:"HandshakeError",error:m.error}),this.timeline.error({handshakeError:m.error})):(this.abortConnecting(),this.handshakeCallbacks[m.action](m))};this.runner=this.strategy.connect(0,r)}abortConnecting(){this.runner&&(this.runner.abort(),this.runner=null)}disconnectInternally(){if(this.abortConnecting(),this.clearRetryTimer(),this.clearUnavailableTimer(),this.connection){var r=this.abandonConnection();r.close()}}updateStrategy(){this.strategy=this.options.getStrategy({key:this.key,timeline:this.timeline,useTLS:this.usingTLS})}retryIn(r){this.timeline.info({action:"retry",delay:r}),r>0&&this.emit("connecting_in",Math.round(r/1e3)),this.retryTimer=new Ce(r||0,()=>{this.disconnectInternally(),this.connect()})}clearRetryTimer(){this.retryTimer&&(this.retryTimer.ensureAborted(),this.retryTimer=null)}setUnavailableTimer(){this.unavailableTimer=new Ce(this.options.unavailableTimeout,()=>{this.updateState("unavailable")})}clearUnavailableTimer(){this.unavailableTimer&&this.unavailableTimer.ensureAborted()}sendActivityCheck(){this.stopActivityCheck(),this.connection.ping(),this.activityTimer=new Ce(this.options.pongTimeout,()=>{this.timeline.error({pong_timed_out:this.options.pongTimeout}),this.retryIn(0)})}resetActivityCheck(){this.stopActivityCheck(),this.connection&&!this.connection.handlesActivityChecks()&&(this.activityTimer=new Ce(this.activityTimeout,()=>{this.sendActivityCheck()}))}stopActivityCheck(){this.activityTimer&&this.activityTimer.ensureAborted()}buildConnectionCallbacks(r){return Ae({},r,{message:l=>{this.resetActivityCheck(),this.emit("message",l)},ping:()=>{this.send_event("pusher:pong",{})},activity:()=>{this.resetActivityCheck()},error:l=>{this.emit("error",l)},closed:()=>{this.abandonConnection(),this.shouldRetry()&&this.retryIn(1e3)}})}buildHandshakeCallbacks(r){return Ae({},r,{connected:l=>{this.activityTimeout=Math.min(this.options.activityTimeout,l.activityTimeout,l.connection.activityTimeout||1/0),this.clearUnavailableTimer(),this.setConnection(l.connection),this.socket_id=this.connection.id,this.updateState("connected",{socket_id:this.socket_id})}})}buildErrorCallbacks(){let r=l=>m=>{m.error&&this.emit("error",{type:"WebSocketError",error:m.error}),l(m)};return{tls_only:r(()=>{this.usingTLS=!0,this.updateStrategy(),this.retryIn(0)}),refused:r(()=>{this.disconnect()}),backoff:r(()=>{this.retryIn(1e3)}),retry:r(()=>{this.retryIn(0)})}}setConnection(r){this.connection=r;for(var l in this.connectionCallbacks)this.connection.bind(l,this.connectionCallbacks[l]);this.resetActivityCheck()}abandonConnection(){if(this.connection){this.stopActivityCheck();for(var r in this.connectionCallbacks)this.connection.unbind(r,this.connectionCallbacks[r]);var l=this.connection;return this.connection=null,l}}updateState(r,l){var m=this.state;if(this.state=r,m!==r){var v=r;v==="connected"&&(v+=" with new socket ID "+l.socket_id),ae.debug("State changed",m+" -> "+v),this.timeline.info({state:r,params:l}),this.emit("state_change",{previous:m,current:r}),this.emit(r,l)}}shouldRetry(){return this.state==="connecting"||this.state==="connected"}}class lr{constructor(){this.channels={}}add(r,l){return this.channels[r]||(this.channels[r]=ur(r,l)),this.channels[r]}all(){return $n(this.channels)}find(r){return this.channels[r]}remove(r){var l=this.channels[r];return delete this.channels[r],l}disconnect(){je(this.channels,function(r){r.disconnect()})}}function ur(d,r){if(d.indexOf("private-encrypted-")===0){if(r.config.nacl)return Ve.createEncryptedChannel(d,r,r.config.nacl);let l="Tried to subscribe to a private-encrypted- channel but no nacl implementation available",m=L.buildLogSuffix("encryptedChannelSupport");throw new ne(`${l}. ${m}`)}else{if(d.indexOf("private-")===0)return Ve.createPrivateChannel(d,r);if(d.indexOf("presence-")===0)return Ve.createPresenceChannel(d,r);if(d.indexOf("#")===0)throw new q('Cannot create a channel with name "'+d+'".');return Ve.createChannel(d,r)}}var cs={createChannels(){return new lr},createConnectionManager(d,r){return new mn(d,r)},createChannel(d,r){return new dn(d,r)},createPrivateChannel(d,r){return new fn(d,r)},createPresenceChannel(d,r){return new he(d,r)},createEncryptedChannel(d,r,l){return new Lt(d,r,l)},createTimelineSender(d,r){return new $(d,r)},createHandshake(d,r){return new cr(d,r)},createAssistantToTheTransportManager(d,r,l){return new xt(d,r,l)}},Ve=cs;class yn{constructor(r){this.options=r||{},this.livesLeft=this.options.lives||1/0}getAssistant(r){return Ve.createAssistantToTheTransportManager(this,r,{minPingDelay:this.options.minPingDelay,maxPingDelay:this.options.maxPingDelay})}isAlive(){return this.livesLeft>0}reportDeath(){this.livesLeft-=1}}class Xe{constructor(r,l){this.strategies=r,this.loop=!!l.loop,this.failFast=!!l.failFast,this.timeout=l.timeout,this.timeoutLimit=l.timeoutLimit}isSupported(){return At(this.strategies,Oe.method("isSupported"))}connect(r,l){var m=this.strategies,v=0,T=this.timeout,B=null,z=(X,se)=>{se?l(null,se):(v=v+1,this.loop&&(v=v%m.length),v<m.length?(T&&(T=T*2,this.timeoutLimit&&(T=Math.min(T,this.timeoutLimit))),B=this.tryStrategy(m[v],r,{timeout:T,failFast:this.failFast},z)):l(!0))};return B=this.tryStrategy(m[v],r,{timeout:T,failFast:this.failFast},z),{abort:function(){B.abort()},forceMinPriority:function(X){r=X,B&&B.forceMinPriority(X)}}}tryStrategy(r,l,m,v){var T=null,B=null;return m.timeout>0&&(T=new Ce(m.timeout,function(){B.abort(),v(!0)})),B=r.connect(l,function(z,X){z&&T&&T.isRunning()&&!m.failFast||(T&&T.ensureAborted(),v(z,X))}),{abort:function(){T&&T.ensureAborted(),B.abort()},forceMinPriority:function(z){B.forceMinPriority(z)}}}}class bn{constructor(r){this.strategies=r}isSupported(){return At(this.strategies,Oe.method("isSupported"))}connect(r,l){return ls(this.strategies,r,function(m,v){return function(T,B){if(v[m].error=T,T){hr(v)&&l(!0);return}mt(v,function(z){z.forceMinPriority(B.transport.priority)}),l(null,B)}})}}function ls(d,r,l){var m=ct(d,function(v,T,B,z){return v.connect(r,l(T,z))});return{abort:function(){mt(m,dr)},forceMinPriority:function(v){mt(m,function(T){T.forceMinPriority(v)})}}}function hr(d){return yt(d,function(r){return!!r.error})}function dr(d){!d.error&&!d.aborted&&(d.abort(),d.aborted=!0)}class fr{constructor(r,l,m){this.strategy=r,this.transports=l,this.ttl=m.ttl||1800*1e3,this.usingTLS=m.useTLS,this.timeline=m.timeline}isSupported(){return this.strategy.isSupported()}connect(r,l){var m=this.usingTLS,v=Je(m),T=v&&v.cacheSkipCount?v.cacheSkipCount:0,B=[this.strategy];if(v&&v.timestamp+this.ttl>=Oe.now()){var z=this.transports[v.transport];z&&(["ws","wss"].includes(v.transport)||T>3?(this.timeline.info({cached:!0,transport:v.transport,latency:v.latency}),B.push(new Xe([z],{timeout:v.latency*2+1e3,failFast:!0}))):T++)}var X=Oe.now(),se=B.pop().connect(r,function re(pe,St){pe?(st(m),B.length>0?(X=Oe.now(),se=B.pop().connect(r,re)):l(pe)):(wn(m,St.transport.name,Oe.now()-X,T),l(null,St))});return{abort:function(){se.abort()},forceMinPriority:function(re){r=re,se&&se.forceMinPriority(re)}}}}function vn(d){return"pusherTransport"+(d?"TLS":"NonTLS")}function Je(d){var r=Y.getLocalStorage();if(r)try{var l=r[vn(d)];if(l)return JSON.parse(l)}catch{st(d)}return null}function wn(d,r,l,m){var v=Y.getLocalStorage();if(v)try{v[vn(d)]=bt({timestamp:Oe.now(),transport:r,latency:l,cacheSkipCount:m})}catch{}}function st(d){var r=Y.getLocalStorage();if(r)try{delete r[vn(d)]}catch{}}class Nt{constructor(r,{delay:l}){this.strategy=r,this.options={delay:l}}isSupported(){return this.strategy.isSupported()}connect(r,l){var m=this.strategy,v,T=new Ce(this.options.delay,function(){v=m.connect(r,l)});return{abort:function(){T.ensureAborted(),v&&v.abort()},forceMinPriority:function(B){r=B,v&&v.forceMinPriority(B)}}}}class wt{constructor(r,l,m){this.test=r,this.trueBranch=l,this.falseBranch=m}isSupported(){var r=this.test()?this.trueBranch:this.falseBranch;return r.isSupported()}connect(r,l){var m=this.test()?this.trueBranch:this.falseBranch;return m.connect(r,l)}}class Cn{constructor(r){this.strategy=r}isSupported(){return this.strategy.isSupported()}connect(r,l){var m=this.strategy.connect(r,function(v,T){T&&m.abort(),l(v,T)});return m}}function ut(d){return function(){return d.isSupported()}}var us=function(d,r,l){var m={};function v(Ft,Es,Gr,Ps,Is){var Ms=l(d,Ft,Es,Gr,Ps,Is);return m[Ft]=Ms,Ms}var T=Object.assign({},r,{hostNonTLS:d.wsHost+":"+d.wsPort,hostTLS:d.wsHost+":"+d.wssPort,httpPath:d.wsPath}),B=Object.assign({},T,{useTLS:!0}),z=Object.assign({},r,{hostNonTLS:d.httpHost+":"+d.httpPort,hostTLS:d.httpHost+":"+d.httpsPort,httpPath:d.httpPath}),X={loop:!0,timeout:15e3,timeoutLimit:6e4},se=new yn({minPingDelay:1e4,maxPingDelay:d.activityTimeout}),re=new yn({lives:2,minPingDelay:1e4,maxPingDelay:d.activityTimeout}),pe=v("ws","ws",3,T,se),St=v("wss","ws",3,B,se),dt=v("sockjs","sockjs",1,z),jt=v("xhr_streaming","xhr_streaming",1,z,re),Br=v("xdr_streaming","xdr_streaming",1,z,re),Ht=v("xhr_polling","xhr_polling",1,z),jr=v("xdr_polling","xdr_polling",1,z),_e=new Xe([pe],X),Hr=new Xe([St],X),ks=new Xe([dt],X),Ts=new Xe([new wt(ut(jt),jt,Br)],X),Gt=new Xe([new wt(ut(Ht),Ht,jr)],X),As=new Xe([new wt(ut(Ts),new bn([Ts,new Nt(Gt,{delay:4e3})]),Gt)],X),xe=new wt(ut(As),As,ks),_t;return r.useTLS?_t=new bn([_e,new Nt(xe,{delay:2e3})]):_t=new bn([_e,new Nt(Hr,{delay:2e3}),new Nt(xe,{delay:5e3})]),new fr(new Cn(new wt(ut(pe),_t,xe)),m,{ttl:18e5,timeline:r.timeline,useTLS:r.useTLS})},pr=us,ht=function(){var d=this;d.timeline.info(d.buildTimelineMessage({transport:d.name+(d.options.useTLS?"s":"")})),d.hooks.isInitialized()?d.changeState("initialized"):d.hooks.file?(d.changeState("initializing"),D.load(d.hooks.file,{useTLS:d.options.useTLS},function(r,l){d.hooks.isInitialized()?(d.changeState("initialized"),l(!0)):(r&&d.onError(r),d.onClose(),l(!1))})):d.onClose()},hs={getRequest:function(d){var r=new window.XDomainRequest;return r.ontimeout=function(){d.emit("error",new W),d.close()},r.onerror=function(l){d.emit("error",l),d.close()},r.onprogress=function(){r.responseText&&r.responseText.length>0&&d.onChunk(200,r.responseText)},r.onload=function(){r.responseText&&r.responseText.length>0&&d.onChunk(200,r.responseText),d.emit("finished",200),d.close()},r},abortRequest:function(d){d.ontimeout=d.onerror=d.onprogress=d.onload=null,d.abort()}},gr=hs;const mr=256*1024;class yr extends Ge{constructor(r,l,m){super(),this.hooks=r,this.method=l,this.url=m}start(r){this.position=0,this.xhr=this.hooks.getRequest(this),this.unloader=()=>{this.close()},Y.addUnloadListener(this.unloader),this.xhr.open(this.method,this.url,!0),this.xhr.setRequestHeader&&this.xhr.setRequestHeader("Content-Type","application/json"),this.xhr.send(r)}close(){this.unloader&&(Y.removeUnloadListener(this.unloader),this.unloader=null),this.xhr&&(this.hooks.abortRequest(this.xhr),this.xhr=null)}onChunk(r,l){for(;;){var m=this.advanceBuffer(l);if(m)this.emit("chunk",{status:r,data:m});else break}this.isBufferTooLong(l)&&this.emit("buffer_too_long")}advanceBuffer(r){var l=r.slice(this.position),m=l.indexOf(`
`);return m!==-1?(this.position+=m+1,l.slice(0,m)):null}isBufferTooLong(r){return this.position===r.length&&r.length>mr}}var de;(function(d){d[d.CONNECTING=0]="CONNECTING",d[d.OPEN=1]="OPEN",d[d.CLOSED=3]="CLOSED"})(de||(de={}));var rt=de,br=1;class vr{constructor(r,l){this.hooks=r,this.session=Sn(1e3)+"/"+Cr(8),this.location=wr(l),this.readyState=rt.CONNECTING,this.openStream()}send(r){return this.sendRaw(JSON.stringify([r]))}ping(){this.hooks.sendHeartbeat(this)}close(r,l){this.onClose(r,l,!0)}sendRaw(r){if(this.readyState===rt.OPEN)try{return Y.createSocketRequest("POST",fs(ds(this.location,this.session))).start(r),!0}catch{return!1}else return!1}reconnect(){this.closeStream(),this.openStream()}onClose(r,l,m){this.closeStream(),this.readyState=rt.CLOSED,this.onclose&&this.onclose({code:r,reason:l,wasClean:m})}onChunk(r){if(r.status===200){this.readyState===rt.OPEN&&this.onActivity();var l,m=r.data.slice(0,1);switch(m){case"o":l=JSON.parse(r.data.slice(1)||"{}"),this.onOpen(l);break;case"a":l=JSON.parse(r.data.slice(1)||"[]");for(var v=0;v<l.length;v++)this.onEvent(l[v]);break;case"m":l=JSON.parse(r.data.slice(1)||"null"),this.onEvent(l);break;case"h":this.hooks.onHeartbeat(this);break;case"c":l=JSON.parse(r.data.slice(1)||"[]"),this.onClose(l[0],l[1],!0);break}}}onOpen(r){this.readyState===rt.CONNECTING?(r&&r.hostname&&(this.location.base=Qe(this.location.base,r.hostname)),this.readyState=rt.OPEN,this.onopen&&this.onopen()):this.onClose(1006,"Server lost session",!0)}onEvent(r){this.readyState===rt.OPEN&&this.onmessage&&this.onmessage({data:r})}onActivity(){this.onactivity&&this.onactivity()}onError(r){this.onerror&&this.onerror(r)}openStream(){this.stream=Y.createSocketRequest("POST",fs(this.hooks.getReceiveURL(this.location,this.session))),this.stream.bind("chunk",r=>{this.onChunk(r)}),this.stream.bind("finished",r=>{this.hooks.onFinished(this,r)}),this.stream.bind("buffer_too_long",()=>{this.reconnect()});try{this.stream.start()}catch(r){Oe.defer(()=>{this.onError(r),this.onClose(1006,"Could not start streaming",!1)})}}closeStream(){this.stream&&(this.stream.unbind_all(),this.stream.close(),this.stream=null)}}function wr(d){var r=/([^\?]*)\/*(\??.*)/.exec(d);return{base:r[1],queryString:r[2]}}function ds(d,r){return d.base+"/"+r+"/xhr_send"}function fs(d){var r=d.indexOf("?")===-1?"?":"&";return d+r+"t="+ +new Date+"&n="+br++}function Qe(d,r){var l=/(https?:\/\/)([^\/:]+)((\/|:)?.*)/.exec(d);return l[1]+r+l[3]}function Sn(d){return Y.randomInt(d)}function Cr(d){for(var r=[],l=0;l<d;l++)r.push(Sn(32).toString(32));return r.join("")}var _n=vr,Sr={getReceiveURL:function(d,r){return d.base+"/"+r+"/xhr_streaming"+d.queryString},onHeartbeat:function(d){d.sendRaw("[]")},sendHeartbeat:function(d){d.sendRaw("[]")},onFinished:function(d,r){d.onClose(1006,"Connection interrupted ("+r+")",!1)}},_r=Sr,Rr={getReceiveURL:function(d,r){return d.base+"/"+r+"/xhr"+d.queryString},onHeartbeat:function(){},sendHeartbeat:function(d){d.sendRaw("[]")},onFinished:function(d,r){r===200?d.reconnect():d.onClose(1006,"Connection interrupted ("+r+")",!1)}},Or=Rr,kr={getRequest:function(d){var r=Y.getXHRAPI(),l=new r;return l.onreadystatechange=l.onprogress=function(){switch(l.readyState){case 3:l.responseText&&l.responseText.length>0&&d.onChunk(l.status,l.responseText);break;case 4:l.responseText&&l.responseText.length>0&&d.onChunk(l.status,l.responseText),d.emit("finished",l.status),d.close();break}},l},abortRequest:function(d){d.onreadystatechange=null,d.abort()}},ee=kr,ps={createStreamingSocket(d){return this.createSocket(_r,d)},createPollingSocket(d){return this.createSocket(Or,d)},createSocket(d,r){return new _n(d,r)},createXHR(d,r){return this.createRequest(ee,d,r)},createRequest(d,r,l){return new yr(d,r,l)}},We=ps;We.createXDR=function(d,r){return this.createRequest(gr,d,r)};var Tr=We,gs={nextAuthCallbackID:1,auth_callbacks:{},ScriptReceivers:w,DependenciesReceivers:I,getDefaultStrategy:pr,Transports:un,transportConnectionInitializer:ht,HTTPFactory:Tr,TimelineTransport:es,getXHRAPI(){return window.XMLHttpRequest},getWebSocketAPI(){return window.WebSocket||window.MozWebSocket},setup(d){window.Pusher=d;var r=()=>{this.onDocumentBody(d.ready)};window.JSON?r():D.load("json2",{},r)},getDocument(){return document},getProtocol(){return this.getDocument().location.protocol},getAuthorizers(){return{ajax:Ke,jsonp:Zn}},onDocumentBody(d){document.body?d():setTimeout(()=>{this.onDocumentBody(d)},0)},createJSONPRequest(d,r){return new Me(d,r)},createScriptRequest(d){return new Ee(d)},getLocalStorage(){try{return window.localStorage}catch{return}},createXHR(){return this.getXHRAPI()?this.createXMLHttpRequest():this.createMicrosoftXHR()},createXMLHttpRequest(){var d=this.getXHRAPI();return new d},createMicrosoftXHR(){return new ActiveXObject("Microsoft.XMLHTTP")},getNetwork(){return or},createWebSocket(d){var r=this.getWebSocketAPI();return new r(d)},createSocketRequest(d,r){if(this.isXHRSupported())return this.HTTPFactory.createXHR(d,r);if(this.isXDRSupported(r.indexOf("https:")===0))return this.HTTPFactory.createXDR(d,r);throw"Cross-origin HTTP requests are not supported"},isXHRSupported(){var d=this.getXHRAPI();return!!d&&new d().withCredentials!==void 0},isXDRSupported(d){var r=d?"https:":"http:",l=this.getProtocol();return!!window.XDomainRequest&&l===r},addUnloadListener(d){window.addEventListener!==void 0?window.addEventListener("unload",d,!1):window.attachEvent!==void 0&&window.attachEvent("onunload",d)},removeUnloadListener(d){window.addEventListener!==void 0?window.removeEventListener("unload",d,!1):window.detachEvent!==void 0&&window.detachEvent("onunload",d)},randomInt(d){return Math.floor(function(){return(window.crypto||window.msCrypto).getRandomValues(new Uint32Array(1))[0]/Math.pow(2,32)}()*d)}},Y=gs,Ut;(function(d){d[d.ERROR=3]="ERROR",d[d.INFO=6]="INFO",d[d.DEBUG=7]="DEBUG"})(Ut||(Ut={}));var qt=Ut;class ms{constructor(r,l,m){this.key=r,this.session=l,this.events=[],this.options=m||{},this.sent=0,this.uniqueID=0}log(r,l){r<=this.options.level&&(this.events.push(Ae({},l,{timestamp:Oe.now()})),this.options.limit&&this.events.length>this.options.limit&&this.events.shift())}error(r){this.log(qt.ERROR,r)}info(r){this.log(qt.INFO,r)}debug(r){this.log(qt.DEBUG,r)}isEmpty(){return this.events.length===0}send(r,l){var m=Ae({session:this.session,bundle:this.sent+1,key:this.key,lib:"js",version:this.options.version,cluster:this.options.cluster,features:this.options.features,timeline:this.events},this.options.params);return this.events=[],r(m,(v,T)=>{v||this.sent++,l&&l(v,T)}),!0}generateUniqueID(){return this.uniqueID++,this.uniqueID}}class ys{constructor(r,l,m,v){this.name=r,this.priority=l,this.transport=m,this.options=v||{}}isSupported(){return this.transport.isSupported({useTLS:this.options.useTLS})}connect(r,l){if(this.isSupported()){if(this.priority<r)return Rn(new K,l)}else return Rn(new ve,l);var m=!1,v=this.transport.createConnection(this.name,this.priority,this.options.key,this.options),T=null,B=function(){v.unbind("initialized",B),v.connect()},z=function(){T=Ve.createHandshake(v,function(pe){m=!0,re(),l(null,pe)})},X=function(pe){re(),l(pe)},se=function(){re();var pe;pe=bt(v),l(new _(pe))},re=function(){v.unbind("initialized",B),v.unbind("open",z),v.unbind("error",X),v.unbind("closed",se)};return v.bind("initialized",B),v.bind("open",z),v.bind("error",X),v.bind("closed",se),v.initialize(),{abort:()=>{m||(re(),T?T.close():v.close())},forceMinPriority:pe=>{m||this.priority<pe&&(T?T.close():v.close())}}}}function Rn(d,r){return Oe.defer(function(){r(d)}),{abort:function(){},forceMinPriority:function(){}}}const{Transports:bs}=Y;var Dt=function(d,r,l,m,v,T){var B=bs[l];if(!B)throw new ue(l);var z=(!d.enabledTransports||Zt(d.enabledTransports,r)!==-1)&&(!d.disabledTransports||Zt(d.disabledTransports,r)===-1),X;return z?(v=Object.assign({ignoreNullOrigin:d.ignoreNullOrigin},v),X=new ys(r,m,T?T.getAssistant(B):B,v)):X=Bt,X},Bt={isSupported:function(){return!1},connect:function(d,r){var l=Oe.defer(function(){r(new ve)});return{abort:function(){l.ensureAborted()},forceMinPriority:function(){}}}};function vs(d){if(d==null)throw"You must pass an options object";if(d.cluster==null)throw"Options object must provide a cluster";"disableStats"in d&&ae.warn("The disableStats option is deprecated in favor of enableStats")}const ws=(d,r)=>{var l="socket_id="+encodeURIComponent(d.socketId);for(var m in r.params)l+="&"+encodeURIComponent(m)+"="+encodeURIComponent(r.params[m]);if(r.paramsProvider!=null){let v=r.paramsProvider();for(var m in v)l+="&"+encodeURIComponent(m)+"="+encodeURIComponent(v[m])}return l};var Ar=d=>{if(typeof Y.getAuthorizers()[d.transport]>"u")throw`'${d.transport}' is not a recognized auth transport`;return(r,l)=>{const m=ws(r,d);Y.getAuthorizers()[d.transport](Y,m,d,U.UserAuthentication,l)}};const Cs=(d,r)=>{var l="socket_id="+encodeURIComponent(d.socketId);l+="&channel_name="+encodeURIComponent(d.channelName);for(var m in r.params)l+="&"+encodeURIComponent(m)+"="+encodeURIComponent(r.params[m]);if(r.paramsProvider!=null){let v=r.paramsProvider();for(var m in v)l+="&"+encodeURIComponent(m)+"="+encodeURIComponent(v[m])}return l};var Ct=d=>{if(typeof Y.getAuthorizers()[d.transport]>"u")throw`'${d.transport}' is not a recognized auth transport`;return(r,l)=>{const m=Cs(r,d);Y.getAuthorizers()[d.transport](Y,m,d,U.ChannelAuthorization,l)}};const Ye=(d,r,l)=>{const m={authTransport:r.transport,authEndpoint:r.endpoint,auth:{params:r.params,headers:r.headers}};return(v,T)=>{const B=d.channel(v.channelName);l(B,m).authorize(v.socketId,T)}};function Pr(d,r){let l={activityTimeout:d.activityTimeout||x.activityTimeout,cluster:d.cluster,httpPath:d.httpPath||x.httpPath,httpPort:d.httpPort||x.httpPort,httpsPort:d.httpsPort||x.httpsPort,pongTimeout:d.pongTimeout||x.pongTimeout,statsHost:d.statsHost||x.stats_host,unavailableTimeout:d.unavailableTimeout||x.unavailableTimeout,wsPath:d.wsPath||x.wsPath,wsPort:d.wsPort||x.wsPort,wssPort:d.wssPort||x.wssPort,enableStats:_s(d),httpHost:Ir(d),useTLS:xr(d),wsHost:Ss(d),userAuthenticator:Lr(d),channelAuthorizer:Ur(d,r)};return"disabledTransports"in d&&(l.disabledTransports=d.disabledTransports),"enabledTransports"in d&&(l.enabledTransports=d.enabledTransports),"ignoreNullOrigin"in d&&(l.ignoreNullOrigin=d.ignoreNullOrigin),"timelineParams"in d&&(l.timelineParams=d.timelineParams),"nacl"in d&&(l.nacl=d.nacl),l}function Ir(d){return d.httpHost?d.httpHost:d.cluster?`sockjs-${d.cluster}.pusher.com`:x.httpHost}function Ss(d){return d.wsHost?d.wsHost:Mr(d.cluster)}function Mr(d){return`ws-${d}.pusher.com`}function xr(d){return Y.getProtocol()==="https:"?!0:d.forceTLS!==!1}function _s(d){return"enableStats"in d?d.enableStats:"disableStats"in d?!d.disableStats:!1}function Lr(d){const r=Object.assign(Object.assign({},x.userAuthentication),d.userAuthentication);return"customHandler"in r&&r.customHandler!=null?r.customHandler:Ar(r)}function Nr(d,r){let l;return"channelAuthorization"in d?l=Object.assign(Object.assign({},x.channelAuthorization),d.channelAuthorization):(l={transport:d.authTransport||x.authTransport,endpoint:d.authEndpoint||x.authEndpoint},"auth"in d&&("params"in d.auth&&(l.params=d.auth.params),"headers"in d.auth&&(l.headers=d.auth.headers)),"authorizer"in d&&(l.customHandler=Ye(r,l,d.authorizer))),l}function Ur(d,r){const l=Nr(d,r);return"customHandler"in l&&l.customHandler!=null?l.customHandler:Ct(l)}class Rs extends Ge{constructor(r){super(function(l,m){ae.debug(`No callbacks on watchlist events for ${l}`)}),this.pusher=r,this.bindWatchlistInternalEvent()}handleEvent(r){r.data.events.forEach(l=>{this.emit(l.name,l)})}bindWatchlistInternalEvent(){this.pusher.connection.bind("message",r=>{var l=r.event;l==="pusher_internal:watchlist_events"&&this.handleEvent(r)})}}function qr(){let d,r;return{promise:new Promise((m,v)=>{d=m,r=v}),resolve:d,reject:r}}var On=qr;class Os extends Ge{constructor(r){super(function(l,m){ae.debug("No callbacks on user for "+l)}),this.signin_requested=!1,this.user_data=null,this.serverToUserChannel=null,this.signinDonePromise=null,this._signinDoneResolve=null,this._onAuthorize=(l,m)=>{if(l){ae.warn(`Error during signin: ${l}`),this._cleanup();return}this.pusher.send_event("pusher:signin",{auth:m.auth,user_data:m.user_data})},this.pusher=r,this.pusher.connection.bind("state_change",({previous:l,current:m})=>{l!=="connected"&&m==="connected"&&this._signin(),l==="connected"&&m!=="connected"&&(this._cleanup(),this._newSigninPromiseIfNeeded())}),this.watchlist=new Rs(r),this.pusher.connection.bind("message",l=>{var m=l.event;m==="pusher:signin_success"&&this._onSigninSuccess(l.data),this.serverToUserChannel&&this.serverToUserChannel.name===l.channel&&this.serverToUserChannel.handleEvent(l)})}signin(){this.signin_requested||(this.signin_requested=!0,this._signin())}_signin(){this.signin_requested&&(this._newSigninPromiseIfNeeded(),this.pusher.connection.state==="connected"&&this.pusher.config.userAuthenticator({socketId:this.pusher.connection.socket_id},this._onAuthorize))}_onSigninSuccess(r){try{this.user_data=JSON.parse(r.user_data)}catch{ae.error(`Failed parsing user data after signin: ${r.user_data}`),this._cleanup();return}if(typeof this.user_data.id!="string"||this.user_data.id===""){ae.error(`user_data doesn't contain an id. user_data: ${this.user_data}`),this._cleanup();return}this._signinDoneResolve(),this._subscribeChannels()}_subscribeChannels(){const r=l=>{l.subscriptionPending&&l.subscriptionCancelled?l.reinstateSubscription():!l.subscriptionPending&&this.pusher.connection.state==="connected"&&l.subscribe()};this.serverToUserChannel=new dn(`#server-to-user-${this.user_data.id}`,this.pusher),this.serverToUserChannel.bind_global((l,m)=>{l.indexOf("pusher_internal:")===0||l.indexOf("pusher:")===0||this.emit(l,m)}),r(this.serverToUserChannel)}_cleanup(){this.user_data=null,this.serverToUserChannel&&(this.serverToUserChannel.unbind_all(),this.serverToUserChannel.disconnect(),this.serverToUserChannel=null),this.signin_requested&&this._signinDoneResolve()}_newSigninPromiseIfNeeded(){if(!this.signin_requested||this.signinDonePromise&&!this.signinDonePromise.done)return;const{promise:r,resolve:l}=On();r.done=!1;const m=()=>{r.done=!0};r.then(m).catch(m),this.signinDonePromise=r,this._signinDoneResolve=l}}class fe{static ready(){fe.isReady=!0;for(var r=0,l=fe.instances.length;r<l;r++)fe.instances[r].connect()}static getClientFeatures(){return Jn(tn({ws:Y.Transports.ws},function(r){return r.isSupported({})}))}constructor(r,l){Dr(r),vs(l),this.key=r,this.config=Pr(l,this),this.channels=Ve.createChannels(),this.global_emitter=new Ge,this.sessionID=Y.randomInt(1e9),this.timeline=new ms(this.key,this.sessionID,{cluster:this.config.cluster,features:fe.getClientFeatures(),params:this.config.timelineParams||{},limit:50,level:qt.INFO,version:x.VERSION}),this.config.enableStats&&(this.timelineSender=Ve.createTimelineSender(this.timeline,{host:this.config.statsHost,path:"/timeline/v2/"+Y.TimelineTransport.name}));var m=v=>Y.getDefaultStrategy(this.config,v,Dt);this.connection=Ve.createConnectionManager(this.key,{getStrategy:m,timeline:this.timeline,activityTimeout:this.config.activityTimeout,pongTimeout:this.config.pongTimeout,unavailableTimeout:this.config.unavailableTimeout,useTLS:!!this.config.useTLS}),this.connection.bind("connected",()=>{this.subscribeAll(),this.timelineSender&&this.timelineSender.send(this.connection.isUsingTLS())}),this.connection.bind("message",v=>{var T=v.event,B=T.indexOf("pusher_internal:")===0;if(v.channel){var z=this.channel(v.channel);z&&z.handleEvent(v)}B||this.global_emitter.emit(v.event,v.data)}),this.connection.bind("connecting",()=>{this.channels.disconnect()}),this.connection.bind("disconnected",()=>{this.channels.disconnect()}),this.connection.bind("error",v=>{ae.warn(v)}),fe.instances.push(this),this.timeline.info({instances:fe.instances.length}),this.user=new Os(this),fe.isReady&&this.connect()}channel(r){return this.channels.find(r)}allChannels(){return this.channels.all()}connect(){if(this.connection.connect(),this.timelineSender&&!this.timelineSenderTimer){var r=this.connection.isUsingTLS(),l=this.timelineSender;this.timelineSenderTimer=new Zs(6e4,function(){l.send(r)})}}disconnect(){this.connection.disconnect(),this.timelineSenderTimer&&(this.timelineSenderTimer.ensureAborted(),this.timelineSenderTimer=null)}bind(r,l,m){return this.global_emitter.bind(r,l,m),this}unbind(r,l,m){return this.global_emitter.unbind(r,l,m),this}bind_global(r){return this.global_emitter.bind_global(r),this}unbind_global(r){return this.global_emitter.unbind_global(r),this}unbind_all(r){return this.global_emitter.unbind_all(),this}subscribeAll(){var r;for(r in this.channels.channels)this.channels.channels.hasOwnProperty(r)&&this.subscribe(r)}subscribe(r){var l=this.channels.add(r,this);return l.subscriptionPending&&l.subscriptionCancelled?l.reinstateSubscription():!l.subscriptionPending&&this.connection.state==="connected"&&l.subscribe(),l}unsubscribe(r){var l=this.channels.find(r);l&&l.subscriptionPending?l.cancelSubscription():(l=this.channels.remove(r),l&&l.subscribed&&l.unsubscribe())}send_event(r,l,m){return this.connection.send_event(r,l,m)}shouldUseTLS(){return this.config.useTLS}signin(){this.user.signin()}}fe.instances=[],fe.isReady=!1,fe.logToConsole=!1,fe.Runtime=Y,fe.ScriptReceivers=Y.ScriptReceivers,fe.DependenciesReceivers=Y.DependenciesReceivers,fe.auth_callbacks=Y.auth_callbacks;var ze=c.default=fe;function Dr(d){if(d==null)throw"You must pass your app key when you instantiate Pusher."}Y.setup(fe)}])})}(hi)),hi.exports}var du=hu();const fu=Xo(du);var Ds={exports:{}};/*@license Copyright 2015-2022 Ably Real-time Ltd (ably.com)

Ably JavaScript Library v2.6.3
https://github.com/ably/ably-js

Released under the Apache Licence v2.0*/var pu=Ds.exports,bo;function gu(){return bo||(bo=1,function(a,o){(function(h,c){a.exports=c()})(pu,()=>{var h={},c={exports:h},p=Object.defineProperty,y=Object.defineProperties,w=Object.getOwnPropertyDescriptor,k=Object.getOwnPropertyDescriptors,x=Object.getOwnPropertyNames,N=Object.getOwnPropertySymbols,I=Object.prototype.hasOwnProperty,D=Object.prototype.propertyIsEnumerable,F=(e,t,n)=>t in e?p(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,H=(e,t)=>{for(var n in t||(t={}))I.call(t,n)&&F(e,n,t[n]);if(N)for(var n of N(t))D.call(t,n)&&F(e,n,t[n]);return e},L=(e,t)=>y(e,k(t)),U=(e,t)=>{var n={};for(var s in e)I.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(e!=null&&N)for(var s of N(e))t.indexOf(s)<0&&D.call(e,s)&&(n[s]=e[s]);return n},R=(e,t)=>{for(var n in t)p(e,n,{get:t[n],enumerable:!0})},q=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of x(t))!I.call(e,i)&&i!==n&&p(e,i,{get:()=>t[i],enumerable:!(s=w(t,i))||s.enumerable});return e},W=e=>q(p({},"__esModule",{value:!0}),e),K={};R(K,{ErrorInfo:()=>A,Realtime:()=>Xr,Rest:()=>jt,default:()=>wc,msgpack:()=>ii,protocolMessageFromDeserialized:()=>As}),c.exports=W(K);var _=class{},ne=typeof pt<"u"?pt:typeof window<"u"?window:self;function ue(e,t){return`${e}`.padStart(t?3:2,"0")}function ve(e){return _.Config.logTimestamps?function(t){const n=new Date;e(ue(n.getHours())+":"+ue(n.getMinutes())+":"+ue(n.getSeconds())+"."+ue(n.getMilliseconds(),1)+" "+t)}:function(t){e(t)}}var we=()=>{var e;let t,n;return typeof((e=ne==null?void 0:ne.console)==null?void 0:e.log)=="function"?(t=function(...s){console.log.apply(console,s)},n=console.warn?function(...s){console.warn.apply(console,s)}:t):t=n=function(){},[t,n].map(ve)},ge=class qn{constructor(){this.deprecated=(t,n)=>{this.deprecationWarning(`${t} is deprecated and will be removed in a future version. ${n}`)},this.shouldLog=t=>t<=this.logLevel,this.setLog=(t,n)=>{t!==void 0&&(this.logLevel=t),n!==void 0&&(this.logHandler=this.logErrorHandler=n)},this.logLevel=qn.defaultLogLevel,this.logHandler=qn.defaultLogHandler,this.logErrorHandler=qn.defaultLogErrorHandler}static initLogHandlers(){const[t,n]=we();this.defaultLogHandler=t,this.defaultLogErrorHandler=n,this.defaultLogger=new qn}static logActionNoStrip(t,n,s,i){t.logAction(n,s,i)}logAction(t,n,s){this.shouldLog(t)&&(t===1?this.logErrorHandler:this.logHandler)("Ably: "+n+": "+s,t)}renamedClientOption(t,n){this.deprecationWarning(`The \`${t}\` client option has been renamed to \`${n}\`. Please update your code to use \`${n}\` instead. \`${t}\` will be removed in a future version.`)}renamedMethod(t,n,s){this.deprecationWarning(`\`${t}\`’s \`${n}\` method has been renamed to \`${s}\`. Please update your code to use \`${s}\` instead. \`${n}\` will be removed in a future version.`)}deprecationWarning(t){this.shouldLog(1)&&this.logErrorHandler(`Ably: Deprecation warning - ${t}`,1)}};ge.defaultLogLevel=1,ge.LOG_NONE=0,ge.LOG_ERROR=1,ge.LOG_MAJOR=2,ge.LOG_MINOR=3,ge.LOG_MICRO=4,ge.logAction=(e,t,n,s)=>{ge.logActionNoStrip(e,t,n,s)};var Ke=ge,f=Ke,nt={};R(nt,{Format:()=>Xn,allSame:()=>tn,allToLowerCase:()=>sn,allToUpperCase:()=>es,arrChooseN:()=>Zn,arrDeleteValue:()=>$n,arrEquals:()=>Ge,arrIntersect:()=>Zt,arrIntersectOb:()=>je,arrPopRandomElement:()=>At,arrSubtract:()=>Jn,arrWithoutValue:()=>mt,cheapRandStr:()=>ae,containsValue:()=>Ae,copy:()=>ot,createMissingPluginError:()=>Mt,dataSizeBytes:()=>Qn,decodeBody:()=>Me,encodeBody:()=>He,ensureArray:()=>Yt,forInOwnNonNullProperties:()=>en,getBackoffCoefficient:()=>Pt,getGlobalObject:()=>on,getJitterCoefficient:()=>It,getRetryTime:()=>rn,inherits:()=>Oe,inspectBody:()=>bt,inspectError:()=>oe,intersect:()=>Vn,isEmpty:()=>Ys,isErrorInfoOrPartialErrorInfo:()=>nn,isNil:()=>Ce,isObject:()=>at,keysArray:()=>ct,matchDerivedChannel:()=>ns,mixin:()=>Z,parseQueryString:()=>Et,prototypicalClone:()=>zn,randomString:()=>Yn,shallowClone:()=>Zs,shallowEquals:()=>ts,throwMissingPluginError:()=>be,toBase64:()=>lt,toQueryString:()=>yt,valuesArray:()=>Kn,whenPromiseSettles:()=>Ee,withTimeoutAsync:()=>ss});function gt(e){let t="["+e.constructor.name;return e.message&&(t+=": "+e.message),e.statusCode&&(t+="; statusCode="+e.statusCode),e.code&&(t+="; code="+e.code),e.cause&&(t+="; cause="+oe(e.cause)),e.href&&!(e.message&&e.message.indexOf("help.ably.io")>-1)&&(t+="; see "+e.href+" "),t+="]",t}var A=class vi extends Error{constructor(t,n,s,i){super(t),typeof Object.setPrototypeOf<"u"&&Object.setPrototypeOf(this,vi.prototype),this.code=n,this.statusCode=s,this.cause=i}toString(){return gt(this)}static fromValues(t){const{message:n,code:s,statusCode:i}=t;if(typeof n!="string"||typeof s!="number"||typeof i!="number")throw new Error("ErrorInfo.fromValues(): invalid values: "+_.Config.inspect(t));const u=Object.assign(new vi(n,s,i),t);return u.code&&!u.href&&(u.href="https://help.ably.io/error/"+u.code),u}},Re=class wi extends Error{constructor(t,n,s,i){super(t),typeof Object.setPrototypeOf<"u"&&Object.setPrototypeOf(this,wi.prototype),this.code=n,this.statusCode=s,this.cause=i}toString(){return gt(this)}static fromValues(t){const{message:n,code:s,statusCode:i}=t;if(typeof n!="string"||!Ce(s)&&typeof s!="number"||!Ce(i)&&typeof i!="number")throw new Error("PartialErrorInfo.fromValues(): invalid values: "+_.Config.inspect(t));const u=Object.assign(new wi(n,s,i),t);return u.code&&!u.href&&(u.href="https://help.ably.io/error/"+u.code),u}};function Qs(e){return Math.floor(Math.random()*e.length)}function Z(e,...t){for(let n=0;n<t.length;n++){const s=t[n];if(!s)break;for(const i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e}function ot(e){return Z({},e)}function Yt(e){return Ce(e)?[]:Array.isArray(e)?e:[e]}function at(e){return Object.prototype.toString.call(e)=="[object Object]"}function Ys(e){for(const t in e)return!1;return!0}function Ce(e){return e==null}function Zs(e){const t=new Object;for(const n in e)t[n]=e[n];return t}function zn(e,t){class n{}n.prototype=e;const s=new n;return t&&Z(s,t),s}var Oe=function(e,t){if(_.Config.inherits){_.Config.inherits(e,t);return}e.super_=t,e.prototype=zn(t.prototype,{constructor:e})};function Ae(e,t){for(const n in e)if(e[n]==t)return!0;return!1}function Vn(e,t){return Array.isArray(t)?Zt(e,t):je(e,t)}function Zt(e,t){const n=[];for(let s=0;s<e.length;s++){const i=e[s];t.indexOf(i)!=-1&&n.push(i)}return n}function je(e,t){const n=[];for(let s=0;s<e.length;s++){const i=e[s];i in t&&n.push(i)}return n}function Jn(e,t){const n=[];for(let s=0;s<e.length;s++){const i=e[s];t.indexOf(i)==-1&&n.push(i)}return n}function $n(e,t){const n=e.indexOf(t),s=n!=-1;return s&&e.splice(n,1),s}function mt(e,t){const n=e.slice();return $n(n,t),n}function ct(e,t){const n=[];for(const s in e)t&&!Object.prototype.hasOwnProperty.call(e,s)||n.push(s);return n}function Kn(e,t){const n=[];for(const s in e)t&&!Object.prototype.hasOwnProperty.call(e,s)||n.push(e[s]);return n}function en(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&e[n]&&t(n)}function tn(e,t){if(e.length===0)return!0;const n=e[0][t];return e.every(function(s){return s[t]===n})}var Xn=(e=>(e.msgpack="msgpack",e.json="json",e))(Xn||{});function At(e){return e.splice(Qs(e),1)[0]}function yt(e){const t=[];if(e)for(const n in e)t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.length?"?"+t.join("&"):""}function Et(e){let t;const n=/([^?&=]+)=?([^&]*)/g,s={};for(;t=n.exec(e);)s[decodeURIComponent(t[1])]=decodeURIComponent(t[2]);return s}function nn(e){return typeof e=="object"&&e!==null&&(e instanceof A||e instanceof Re)}function oe(e){var t,n;return e instanceof Error||((t=e==null?void 0:e.constructor)==null?void 0:t.name)==="ErrorInfo"||((n=e==null?void 0:e.constructor)==null?void 0:n.name)==="PartialErrorInfo"?e.toString():_.Config.inspect(e)}function bt(e){return _.BufferUtils.isBuffer(e)?e.toString():typeof e=="string"?e:_.Config.inspect(e)}function Qn(e){if(_.BufferUtils.isBuffer(e))return _.BufferUtils.byteLength(e);if(typeof e=="string")return _.Config.stringByteSize(e);throw new Error("Expected input of Utils.dataSizeBytes to be a buffer or string, but was: "+typeof e)}function ae(){return String(Math.random()).substr(2)}var Yn=async e=>{const t=await _.Config.getRandomArrayBuffer(e);return _.BufferUtils.base64Encode(t)};function Zn(e,t){const n=Math.min(t,e.length),s=e.slice(),i=[];for(let u=0;u<n;u++)i.push(At(s));return i}function Ee(e,t){e.then(n=>{t==null||t(null,n)}).catch(n=>{t==null||t(n)})}function Me(e,t,n){return n=="msgpack"?(t||be("MsgPack"),t.decode(e)):JSON.parse(String(e))}function He(e,t,n){return n=="msgpack"?(t||be("MsgPack"),t.encode(e,!0)):JSON.stringify(e)}function sn(e){return e.map(function(t){return t&&t.toLowerCase()})}function es(e){return e.map(function(t){return t&&t.toUpperCase()})}function Pt(e){return Math.min((e+2)/3,2)}function It(){return 1-Math.random()*.2}function rn(e,t){return e*Pt(t)*It()}function on(){return typeof pt<"u"?pt:typeof window<"u"?window:self}function ts(e,t){return Object.keys(e).every(n=>e[n]===t[n])&&Object.keys(t).every(n=>t[n]===e[n])}function ns(e){const t=/^(\[([^?]*)(?:(.*))\])?(.+)$/,n=e.match(t);if(!n||!n.length||n.length<5)throw new A("regex match failed",400,40010);if(n[2])throw new A(`cannot use a derived option with a ${n[2]} channel`,400,40010);return{qualifierParam:n[3]||"",channelName:n[4]}}function lt(e){const t=_.BufferUtils,n=t.utf8Encode(e);return t.base64Encode(n)}function Ge(e,t){return e.length===t.length&&e.every(function(n,s){return n===t[s]})}function Mt(e){return new A(`${e} plugin not provided`,40019,400)}function be(e){throw Mt(e)}async function ss(e,t=5e3,n="Timeout expired"){const s=new A(n,5e4,500);return Promise.race([e,new Promise((i,u)=>setTimeout(()=>u(s),t))])}var an="2.6.3",rs="ably-js/"+an,Se={ENVIRONMENT:"",REST_HOST:"rest.ably.io",REALTIME_HOST:"realtime.ably.io",FALLBACK_HOSTS:["A.ably-realtime.com","B.ably-realtime.com","C.ably-realtime.com","D.ably-realtime.com","E.ably-realtime.com"],PORT:80,TLS_PORT:443,TIMEOUTS:{disconnectedRetryTimeout:15e3,suspendedRetryTimeout:3e4,httpRequestTimeout:1e4,httpMaxRetryDuration:15e3,channelRetryTimeout:15e3,fallbackRetryTimeout:6e5,connectionStateTtl:12e4,realtimeRequestTimeout:1e4,recvTimeout:9e4,webSocketConnectTimeout:1e4,webSocketSlowTimeout:4e3},httpMaxRetryCount:3,maxMessageSize:65536,version:an,protocolVersion:3,agent:rs,getHost:cn,getPort:er,getHttpScheme:tr,environmentFallbackHosts:is,getFallbackHosts:vt,getHosts:nr,checkHost:ln,objectifyOptions:ir,normaliseOptions:or,defaultGetHeaders:ar,defaultPostHeaders:cr};function cn(e,t,n){return n?t=t==e.restHost&&e.realtimeHost||t||e.realtimeHost:t=t||e.restHost,t}function er(e,t){return t||e.tls?e.tlsPort:e.port}function tr(e){return e.tls?"https://":"http://"}function is(e){return[e+"-a-fallback.ably-realtime.com",e+"-b-fallback.ably-realtime.com",e+"-c-fallback.ably-realtime.com",e+"-d-fallback.ably-realtime.com",e+"-e-fallback.ably-realtime.com"]}function vt(e){const t=e.fallbackHosts,n=typeof e.httpMaxRetryCount<"u"?e.httpMaxRetryCount:Se.httpMaxRetryCount;return t?Zn(t,n):[]}function nr(e,t){const n=[e.restHost].concat(vt(e));return t?n.map(s=>cn(e,s,!0)):n}function ln(e){if(typeof e!="string")throw new A("host must be a string; was a "+typeof e,4e4,400);if(!e.length)throw new A("host must not be zero-length",4e4,400)}function sr(e,t,n,s){return e.realtimeHost?e.realtimeHost:e.restHost?(f.logAction(s,f.LOG_MINOR,"Defaults.normaliseOptions",'restHost is set to "'+e.restHost+'" but realtimeHost is not set, so setting realtimeHost to "'+e.restHost+'" too. If this is not what you want, please set realtimeHost explicitly.'),e.restHost):t?Se.REALTIME_HOST:n+"-"+Se.REALTIME_HOST}function rr(e){const t={};for(const n in Se.TIMEOUTS)t[n]=e[n]||Se.TIMEOUTS[n];return t}function un(e){let t=Se.agent;if(e.agents)for(var n in e.agents)t+=" "+n+"/"+e.agents[n];return t}function ir(e,t,n,s,i){if(e===void 0){const g=t?`${n} must be initialized with either a client options object, an Ably API key, or an Ably Token`:`${n} must be initialized with a client options object`;throw f.logAction(s,f.LOG_ERROR,`${n}()`,g),new Error(g)}let u;if(typeof e=="string")if(e.indexOf(":")==-1){if(!t){const g=`${n} cannot be initialized with just an Ably Token; you must provide a client options object with a \`plugins\` property. (Set this Ably Token as the object’s \`token\` property.)`;throw f.logAction(s,f.LOG_ERROR,`${n}()`,g),new Error(g)}u={token:e}}else{if(!t){const g=`${n} cannot be initialized with just an Ably API key; you must provide a client options object with a \`plugins\` property. (Set this Ably API key as the object’s \`key\` property.)`;throw f.logAction(s,f.LOG_ERROR,`${n}()`,g),new Error(g)}u={key:e}}else u=e;return i&&(u=L(H({},u),{plugins:H(H({},i),u.plugins)})),u}function or(e,t,n){const s=n??f.defaultLogger;typeof e.recover=="function"&&e.closeOnUnload===!0&&(f.logAction(s,f.LOG_ERROR,"Defaults.normaliseOptions","closeOnUnload was true and a session recovery function was set - these are mutually exclusive, so unsetting the latter"),e.recover=void 0),"closeOnUnload"in e||(e.closeOnUnload=!e.recover),"queueMessages"in e||(e.queueMessages=!0);const i=e.environment&&String(e.environment).toLowerCase()||Se.ENVIRONMENT,u=!i||i==="production";!e.fallbackHosts&&!e.restHost&&!e.realtimeHost&&!e.port&&!e.tlsPort&&(e.fallbackHosts=u?Se.FALLBACK_HOSTS:is(i));const g=e.restHost||(u?Se.REST_HOST:i+"-"+Se.REST_HOST),b=sr(e,u,i,s);(e.fallbackHosts||[]).concat(g,b).forEach(ln),e.port=e.port||Se.PORT,e.tlsPort=e.tlsPort||Se.TLS_PORT,"tls"in e||(e.tls=!0);const S=rr(e);t?"useBinaryProtocol"in e?e.useBinaryProtocol=_.Config.supportsBinary&&e.useBinaryProtocol:e.useBinaryProtocol=_.Config.preferBinary:e.useBinaryProtocol=!1;const C={};e.clientId&&(C["X-Ably-ClientId"]=_.BufferUtils.base64Encode(_.BufferUtils.utf8Encode(e.clientId))),"idempotentRestPublishing"in e||(e.idempotentRestPublishing=!0);let E=null,P=e.connectivityCheckUrl;if(e.connectivityCheckUrl){let[M,V]=e.connectivityCheckUrl.split("?");E=V?Et(V):{},M.indexOf("://")===-1&&(M="https://"+M),P=M}let j=e.wsConnectivityCheckUrl;return j&&j.indexOf("://")===-1&&(j="wss://"+j),L(H({},e),{realtimeHost:b,restHost:g,maxMessageSize:e.maxMessageSize||Se.maxMessageSize,timeouts:S,connectivityCheckParams:E,connectivityCheckUrl:P,wsConnectivityCheckUrl:j,headers:C})}function xt(e,t,n){const s=n||{};if(s.cipher){e||be("Crypto");const i=e.getCipher(s.cipher,t);s.cipher=i.cipherParams,s.channelCipher=i.cipher}else"cipher"in s&&(s.cipher=void 0,s.channelCipher=null);return s}var hn={json:"application/json",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack",text:"text/plain"},Fe={format:"json",protocolVersion:Se.protocolVersion};function ar(e,{format:t=Fe.format,protocolVersion:n=Fe.protocolVersion}={}){return{accept:hn[t],"X-Ably-Version":n.toString(),"Ably-Agent":un(e)}}function cr(e,{format:t=Fe.format,protocolVersion:n=Fe.protocolVersion}={}){let s;return{accept:s=hn[t],"content-type":s,"X-Ably-Version":n.toString(),"Ably-Agent":un(e)}}var $=Se;function dn(e){return Object.assign(Se,e)}var fn=class Qo{constructor(t,n){this.logger=t,this.members=n||[]}call(t,n){for(const s of this.members)if(s)try{s(t,n)}catch(i){f.logAction(this.logger,f.LOG_ERROR,"Multicaster multiple callback handler","Unexpected exception: "+i+"; stack = "+i.stack)}}push(...t){this.members.push(...t)}createPromise(){return new Promise((t,n)=>{this.push((s,i)=>{s?n(s):t(i)})})}resolveAll(t){this.call(null,t)}rejectAll(t){this.call(t)}static create(t,n){const s=new Qo(t,n);return Object.assign((i,u)=>s.call(i,u),{push:i=>s.push(i),createPromise:()=>s.createPromise(),resolveAll:i=>s.resolveAll(i),rejectAll:i=>s.rejectAll(i)})}},pn=fn,os=(e=>(e.Get="get",e.Delete="delete",e.Post="post",e.Put="put",e.Patch="patch",e))(os||{}),he=os,as=(e=>(e[e.Success=200]="Success",e[e.NoContent=204]="NoContent",e[e.BadRequest=400]="BadRequest",e[e.Unauthorized=401]="Unauthorized",e[e.Forbidden=403]="Forbidden",e[e.RequestTimeout=408]="RequestTimeout",e[e.InternalServerError=500]="InternalServerError",e))(as||{});function gn(e){return e>=200&&e<400}var Lt=as,mn=Math.pow(2,17);function lr(){return("000000"+Math.floor(Math.random()*1e16)).slice(-16)}function ur(e){return!!e.connection}function cs(e){return nn(e)?(e.code||(e.statusCode===403?e.code=40300:(e.code=40170,e.statusCode=401)),e):new A(oe(e),e.code||40170,e.statusCode||401)}var Ve=(e,t)=>{const n=_.BufferUtils,s=n.utf8Encode(e),i=n.utf8Encode(t),u=n.hmacSha256(s,i);return n.base64Encode(u)};function yn(e){if(!e)return"";typeof e=="string"&&(e=JSON.parse(e));const t=Object.create(null),n=ct(e,!0);if(!n)return"";n.sort();for(let s=0;s<n.length;s++)t[n[s]]=e[n[s]].sort();return JSON.stringify(t)}function Xe(e,t){if(e.authCallback)f.logAction(t,f.LOG_MINOR,"Auth()","using token auth with authCallback");else if(e.authUrl)f.logAction(t,f.LOG_MINOR,"Auth()","using token auth with authUrl");else if(e.key)f.logAction(t,f.LOG_MINOR,"Auth()","using token auth with client-side signing");else if(e.tokenDetails)f.logAction(t,f.LOG_MINOR,"Auth()","using token auth with supplied token only");else{const n="authOptions must include valid authentication parameters";throw f.logAction(t,f.LOG_ERROR,"Auth()",n),new Error(n)}}function bn(e){return"useTokenAuth"in e&&!e.useTokenAuth}function ls(e){return e.useTokenAuth||!bn(e)&&(e.authCallback||e.authUrl||e.token||e.tokenDetails)}function hr(e){return!e.key&&!e.authCallback&&!e.authUrl}var dr=0;function fr(){return dr++}var vn=class{constructor(e,t){if(this.authOptions={},this.client=e,this.tokenParams=t.defaultTokenParams||{},this.currentTokenRequestId=null,this.waitingForTokenRequest=null,ls(t))hr(t)&&f.logAction(this.logger,f.LOG_ERROR,"Auth()","Warning: library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),this._saveTokenOptions(t.defaultTokenParams,t),Xe(this.authOptions,this.logger);else{if(!t.key){const n="No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)";throw f.logAction(this.logger,f.LOG_ERROR,"Auth()",n),new A(n,40160,401)}f.logAction(this.logger,f.LOG_MINOR,"Auth()","anonymous, using basic auth"),this._saveBasicOptions(t)}}get logger(){return this.client.logger}async authorize(e,t){if(t&&t.key&&this.authOptions.key!==t.key)throw new A("Unable to update auth options with incompatible key",40102,401);try{let n=await this._forceNewToken(e??null,t??null);return ur(this.client)?new Promise((s,i)=>{this.client.connection.connectionManager.onAuthUpdated(n,(u,g)=>u?i(u):s(g))}):n}catch(n){throw this.client.connection&&n.statusCode===Lt.Forbidden&&this.client.connection.connectionManager.actOnErrorFromAuthorize(n),n}}async _forceNewToken(e,t){this.tokenDetails=null,this._saveTokenOptions(e,t),Xe(this.authOptions,this.logger);try{return this._ensureValidAuthCredentials(!0)}finally{delete this.tokenParams.timestamp,delete this.authOptions.queryTime}}async requestToken(e,t){const n=t||this.authOptions,s=e||ot(this.tokenParams);let i,u=this.client;if(n.authCallback)f.logAction(this.logger,f.LOG_MINOR,"Auth.requestToken()","using token auth with authCallback"),i=n.authCallback;else if(n.authUrl)f.logAction(this.logger,f.LOG_MINOR,"Auth.requestToken()","using token auth with authUrl"),i=(b,S)=>{const C=Z({accept:"application/json, text/plain"},n.authHeaders),E=n.authMethod&&n.authMethod.toLowerCase()==="post";let P;const j=n.authUrl.indexOf("?");j>-1&&(P=Et(n.authUrl.slice(j)),n.authUrl=n.authUrl.slice(0,j),E||(n.authParams=Z(P,n.authParams)));const M=Z({},n.authParams||{},b),V=G=>{var J,ie;let ce=(J=G.body)!=null?J:null,le=null;if(G.error)f.logAction(this.logger,f.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received Error: "+oe(G.error));else{const Pe=(ie=G.headers["content-type"])!=null?ie:null;Array.isArray(Pe)?le=Pe.join(", "):le=Pe,f.logAction(this.logger,f.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received; content-type: "+le+"; body: "+bt(ce))}if(G.error){S(G.error,null);return}if(G.unpacked){S(null,ce);return}if(_.BufferUtils.isBuffer(ce)&&(ce=ce.toString()),!le){S(new A("authUrl response is missing a content-type header",40170,401),null);return}const Q=le.indexOf("application/json")>-1,De=le.indexOf("text/plain")>-1||le.indexOf("application/jwt")>-1;if(!Q&&!De){S(new A("authUrl responded with unacceptable content-type "+le+", should be either text/plain, application/jwt or application/json",40170,401),null);return}if(Q){if(ce.length>mn){S(new A("authUrl response exceeded max permitted length",40170,401),null);return}try{ce=JSON.parse(ce)}catch(Pe){S(new A("Unexpected error processing authURL response; err = "+Pe.message,40170,401),null);return}}S(null,ce,le)};if(f.logAction(this.logger,f.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Requesting token from "+n.authUrl+"; Params: "+JSON.stringify(M)+"; method: "+(E?"POST":"GET")),E){const G=C||{};G["content-type"]="application/x-www-form-urlencoded";const J=yt(M).slice(1);Ee(this.client.http.doUri(he.Post,n.authUrl,G,J,P),(ie,ce)=>V(ie||ce))}else Ee(this.client.http.doUri(he.Get,n.authUrl,C||{},null,M),(G,J)=>V(G||J))};else if(n.key)f.logAction(this.logger,f.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing"),i=(b,S)=>{Ee(this.createTokenRequest(b,n),(C,E)=>S(C,E??null))};else{const b="Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)";throw f.logAction(this.logger,f.LOG_ERROR,"Auth()","library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),new A(b,40171,403)}"capability"in s&&(s.capability=yn(s.capability));const g=(b,S)=>{const C=b.keyName,E="/keys/"+C+"/requestToken",P=function(M){return u.baseUri(M)+E},j=$.defaultPostHeaders(this.client.options);n.requestHeaders&&Z(j,n.requestHeaders),f.logAction(this.logger,f.LOG_MICRO,"Auth.requestToken().requestToken","Sending POST to "+E+"; Token params: "+JSON.stringify(b)),Ee(this.client.http.do(he.Post,P,j,JSON.stringify(b),null),(M,V)=>M?S(M):S(V.error,V.body,V.unpacked))};return new Promise((b,S)=>{let C=!1,E=this.client.options.timeouts.realtimeRequestTimeout,P=setTimeout(()=>{C=!0;const j="Token request callback timed out after "+E/1e3+" seconds";f.logAction(this.logger,f.LOG_ERROR,"Auth.requestToken()",j),S(new A(j,40170,401))},E);i(s,(j,M,V)=>{if(C)return;if(clearTimeout(P),j){f.logAction(this.logger,f.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+oe(j)),S(cs(j));return}if(typeof M=="string"){M.length===0?S(new A("Token string is empty",40170,401)):M.length>mn?S(new A("Token string exceeded max permitted length (was "+M.length+" bytes)",40170,401)):M==="undefined"||M==="null"?S(new A("Token string was literal null/undefined",40170,401)):M[0]==="{"&&!(V&&V.indexOf("application/jwt")>-1)?S(new A("Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details",40170,401)):b({token:M});return}if(typeof M!="object"||M===null){const J="Expected token request callback to call back with a token string or token request/details object, but got a "+typeof M;f.logAction(this.logger,f.LOG_ERROR,"Auth.requestToken()",J),S(new A(J,40170,401));return}const G=JSON.stringify(M).length;if(G>mn&&!n.suppressMaxLengthCheck){S(new A("Token request/details object exceeded max permitted stringified size (was "+G+" bytes)",40170,401));return}if("issued"in M){b(M);return}if(!("keyName"in M)){const J="Expected token request callback to call back with a token string, token request object, or token details object";f.logAction(this.logger,f.LOG_ERROR,"Auth.requestToken()",J),S(new A(J,40170,401));return}g(M,(J,ie,ce)=>{if(J){f.logAction(this.logger,f.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+oe(J)),S(cs(J));return}ce||(ie=JSON.parse(ie)),f.logAction(this.logger,f.LOG_MINOR,"Auth.getToken()","token received"),b(ie)})})})}async createTokenRequest(e,t){t=t||this.authOptions,e=e||ot(this.tokenParams);const n=t.key;if(!n)throw new A("No key specified",40101,403);const s=n.split(":"),i=s[0],u=s[1];if(!u)throw new A("Invalid key specified",40101,403);if(e.clientId==="")throw new A("clientId can’t be an empty string",40012,400);"capability"in e&&(e.capability=yn(e.capability));const g=Z({keyName:i},e),b=e.clientId||"",S=e.ttl||"",C=e.capability||"";g.timestamp||(g.timestamp=await this.getTimestamp(t&&t.queryTime));const E=g.nonce||(g.nonce=lr()),P=g.timestamp,j=g.keyName+`
`+S+`
`+C+`
`+b+`
`+P+`
`+E+`
`;return g.mac=g.mac||Ve(j,u),f.logAction(this.logger,f.LOG_MINOR,"Auth.getTokenRequest()","generated signed request"),g}async getAuthParams(){if(this.method=="basic")return{key:this.key};{let e=await this._ensureValidAuthCredentials(!1);if(!e)throw new Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{access_token:e.token}}}async getAuthHeaders(){if(this.method=="basic")return{authorization:"Basic "+this.basicKey};{const e=await this._ensureValidAuthCredentials(!1);if(!e)throw new Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{authorization:"Bearer "+lt(e.token)}}}async getTimestamp(e){return!this.isTimeOffsetSet()&&(e||this.authOptions.queryTime)?this.client.time():this.getTimestampUsingOffset()}getTimestampUsingOffset(){return Date.now()+(this.client.serverTimeOffset||0)}isTimeOffsetSet(){return this.client.serverTimeOffset!==null}_saveBasicOptions(e){this.method="basic",this.key=e.key,this.basicKey=lt(e.key),this.authOptions=e||{},"clientId"in e&&this._userSetClientId(e.clientId)}_saveTokenOptions(e,t){this.method="token",e&&(this.tokenParams=e),t&&(t.token&&(t.tokenDetails=typeof t.token=="string"?{token:t.token}:t.token),t.tokenDetails&&(this.tokenDetails=t.tokenDetails),"clientId"in t&&this._userSetClientId(t.clientId),this.authOptions=t)}async _ensureValidAuthCredentials(e){const t=this.tokenDetails;if(t){if(this._tokenClientIdMismatch(t.clientId))throw new A("Mismatch between clientId in token ("+t.clientId+") and current clientId ("+this.clientId+")",40102,403);if(!this.isTimeOffsetSet()||!t.expires||t.expires>=this.getTimestampUsingOffset())return f.logAction(this.logger,f.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+t.expires),t;f.logAction(this.logger,f.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.tokenDetails=null}const n=(this.waitingForTokenRequest||(this.waitingForTokenRequest=pn.create(this.logger))).createPromise();if(this.currentTokenRequestId!==null&&!e)return n;const s=this.currentTokenRequestId=fr();let i,u=null;try{i=await this.requestToken(this.tokenParams,this.authOptions)}catch(b){u=b}if(this.currentTokenRequestId>s)return f.logAction(this.logger,f.LOG_MINOR,"Auth._ensureValidAuthCredentials()","Discarding token request response; overtaken by newer one"),n;this.currentTokenRequestId=null;const g=this.waitingForTokenRequest;return this.waitingForTokenRequest=null,u?(g==null||g.rejectAll(u),n):(g==null||g.resolveAll(this.tokenDetails=i),n)}_userSetClientId(e){if(typeof e=="string"||e===null){if(e==="*")throw new A('Can’t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, instantiate the library with {defaultTokenParams: {clientId: "*"}}), or if calling authorize(), pass it in as a tokenParam: authorize({clientId: "*"}, authOptions)',40012,400);{const t=this._uncheckedSetClientId(e);if(t)throw t}}else throw new A("clientId must be either a string or null",40012,400)}_uncheckedSetClientId(e){if(this._tokenClientIdMismatch(e)){const t="Unexpected clientId mismatch: client has "+this.clientId+", requested "+e,n=new A(t,40102,401);return f.logAction(this.logger,f.LOG_ERROR,"Auth._uncheckedSetClientId()",t),n}else return this.clientId=this.tokenParams.clientId=e,null}_tokenClientIdMismatch(e){return!!(this.clientId&&this.clientId!=="*"&&e&&e!=="*"&&this.clientId!==e)}static isTokenErr(e){return e.code&&e.code>=40140&&e.code<40150}revokeTokens(e,t){return this.client.rest.revokeTokens(e,t)}},Je=vn;function wn(e){const t=[];if(e)for(const n in e)t.push(n+"="+e[n]);return t.join("&")}function st(e,t){return e+(t?"?":"")+wn(t)}function Nt(e,t,n,s,i){e.error?f.logActionNoStrip(i,f.LOG_MICRO,"Http."+t+"()","Received Error; "+st(n,s)+"; Error: "+oe(e.error)):f.logActionNoStrip(i,f.LOG_MICRO,"Http."+t+"()","Received; "+st(n,s)+"; Headers: "+wn(e.headers)+"; StatusCode: "+e.statusCode+"; Body"+(_.BufferUtils.isBuffer(e.body)?" (Base64): "+_.BufferUtils.base64Encode(e.body):": "+e.body))}function wt(e,t,n,s,i){i.shouldLog(f.LOG_MICRO)&&f.logActionNoStrip(i,f.LOG_MICRO,"Http."+e+"()","Sending; "+st(t,s)+"; Body"+(_.BufferUtils.isBuffer(n)?" (Base64): "+_.BufferUtils.base64Encode(n):": "+n))}var Cn=class{constructor(e){this.client=e,this.platformHttp=new _.Http(e),this.checkConnectivity=this.platformHttp.checkConnectivity?()=>this.platformHttp.checkConnectivity():void 0}get logger(){var e,t;return(t=(e=this.client)==null?void 0:e.logger)!=null?t:f.defaultLogger}get supportsAuthHeaders(){return this.platformHttp.supportsAuthHeaders}get supportsLinkHeaders(){return this.platformHttp.supportsLinkHeaders}_getHosts(e){const t=e.connection,n=t&&t.connectionManager.host;return n?[n].concat($.getFallbackHosts(e.options)):$.getHosts(e.options)}async do(e,t,n,s,i){try{const u=this.client;if(!u)return{error:new A("http.do called without client",5e4,500)};const g=typeof t=="function"?t:function(P){return u.baseUri(P)+t},b=u._currentFallback;if(b)if(b.validUntil>Date.now()){const P=await this.doUri(e,g(b.host),n,s,i);return P.error&&this.platformHttp.shouldFallback(P.error)?(u._currentFallback=null,this.do(e,t,n,s,i)):P}else u._currentFallback=null;const S=this._getHosts(u);if(S.length===1)return this.doUri(e,g(S[0]),n,s,i);let C=null;const E=async(P,j)=>{const M=P.shift();C=C??new Date;const V=await this.doUri(e,g(M),n,s,i);return V.error&&this.platformHttp.shouldFallback(V.error)&&P.length?Date.now()-C.getTime()>u.options.timeouts.httpMaxRetryDuration?{error:new A(`Timeout for trying fallback hosts retries. Total elapsed time exceeded the ${u.options.timeouts.httpMaxRetryDuration}ms limit`,50003,500)}:E(P,!0):(j&&(u._currentFallback={host:M,validUntil:Date.now()+u.options.timeouts.fallbackRetryTimeout}),V)};return E(S)}catch(u){return{error:new A(`Unexpected error in Http.do: ${oe(u)}`,500,5e4)}}}async doUri(e,t,n,s,i){try{wt(e,t,s,i,this.logger);const u=await this.platformHttp.doUri(e,t,n,s,i);return this.logger.shouldLog(f.LOG_MICRO)&&Nt(u,e,t,i,this.logger),u}catch(u){return{error:new A(`Unexpected error in Http.doUri: ${oe(u)}`,500,5e4)}}}},ut=class{constructor(e){this.Platform=_,this.ErrorInfo=A,this.Logger=f,this.Defaults=$,this.Utils=nt;var t,n,s,i,u,g,b,S;this._additionalHTTPRequestImplementations=(t=e.plugins)!=null?t:null,this.logger=new f,this.logger.setLog(e.logLevel,e.logHandler),f.logAction(this.logger,f.LOG_MICRO,"BaseClient()","initialized with clientOptions "+_.Config.inspect(e)),this._MsgPack=(s=(n=e.plugins)==null?void 0:n.MsgPack)!=null?s:null;const C=this.options=$.normaliseOptions(e,this._MsgPack,this.logger);if(C.key){const E=C.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!E){const P="invalid key parameter";throw f.logAction(this.logger,f.LOG_ERROR,"BaseClient()",P),new A(P,40400,404)}C.keyName=E[1],C.keySecret=E[2]}if("clientId"in C)if(typeof C.clientId=="string"||C.clientId===null){if(C.clientId==="*")throw new A('Can’t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, use {defaultTokenParams: {clientId: "*"}})',40012,400)}else throw new A("clientId must be either a string or null",40012,400);f.logAction(this.logger,f.LOG_MINOR,"BaseClient()","started; version = "+$.version),this._currentFallback=null,this.serverTimeOffset=null,this.http=new Cn(this),this.auth=new Je(this,C),this._rest=(i=e.plugins)!=null&&i.Rest?new e.plugins.Rest(this):null,this._Crypto=(g=(u=e.plugins)==null?void 0:u.Crypto)!=null?g:null,this.__FilteredSubscriptions=(S=(b=e.plugins)==null?void 0:b.MessageInteractions)!=null?S:null}get rest(){return this._rest||be("Rest"),this._rest}get _FilteredSubscriptions(){return this.__FilteredSubscriptions||be("MessageInteractions"),this.__FilteredSubscriptions}get channels(){return this.rest.channels}get push(){return this.rest.push}get device(){var e;return(!((e=this.options.plugins)!=null&&e.Push)||!this.push.LocalDevice)&&be("Push"),this._device||(this._device=this.push.LocalDevice.load(this)),this._device}baseUri(e){return $.getHttpScheme(this.options)+e+":"+$.getPort(this.options,!1)}async stats(e){return this.rest.stats(e)}async time(e){return this.rest.time(e)}async request(e,t,n,s,i,u){return this.rest.request(e,t,n,s,i,u)}batchPublish(e){return this.rest.batchPublish(e)}batchPresence(e){return this.rest.batchPresence(e)}setLog(e){this.logger.setLog(e.level,e.handler)}};ut.Platform=_;var us=ut,pr=class $t{toJSON(){var t,n,s;return{id:this.id,deviceSecret:this.deviceSecret,platform:this.platform,formFactor:this.formFactor,clientId:this.clientId,metadata:this.metadata,deviceIdentityToken:this.deviceIdentityToken,push:{recipient:(t=this.push)==null?void 0:t.recipient,state:(n=this.push)==null?void 0:n.state,error:(s=this.push)==null?void 0:s.error}}}toString(){var t,n,s,i;let u="[DeviceDetails";return this.id&&(u+="; id="+this.id),this.platform&&(u+="; platform="+this.platform),this.formFactor&&(u+="; formFactor="+this.formFactor),this.clientId&&(u+="; clientId="+this.clientId),this.metadata&&(u+="; metadata="+this.metadata),this.deviceIdentityToken&&(u+="; deviceIdentityToken="+JSON.stringify(this.deviceIdentityToken)),(t=this.push)!=null&&t.recipient&&(u+="; push.recipient="+JSON.stringify(this.push.recipient)),(n=this.push)!=null&&n.state&&(u+="; push.state="+this.push.state),(s=this.push)!=null&&s.error&&(u+="; push.error="+JSON.stringify(this.push.error)),(i=this.push)!=null&&i.metadata&&(u+="; push.metadata="+this.push.metadata),u+="]",u}static toRequestBody(t,n,s){return He(t,n,s)}static fromResponseBody(t,n,s){return s&&(t=Me(t,n,s)),Array.isArray(t)?$t.fromValuesArray(t):$t.fromValues(t)}static fromValues(t){return t.error=t.error&&A.fromValues(t.error),Object.assign(new $t,t)}static fromLocalDevice(t){return Object.assign(new $t,t)}static fromValuesArray(t){const n=t.length,s=new Array(n);for(let i=0;i<n;i++)s[i]=$t.fromValues(t[i]);return s}},ht=pr;async function hs(e,t,n,s){if(e.http.supportsAuthHeaders){const i=await e.auth.getAuthHeaders();return s(Z(i,t),n)}else{const i=await e.auth.getAuthParams();return s(t,Z(i,n))}}function gr(e,t,n){if(e.err&&!e.body)return{err:e.err};if(e.statusCode===Lt.NoContent)return L(H({},e),{body:[],unpacked:!0});let s=e.body;if(!e.unpacked)try{s=Me(s,t,n)}catch(b){return nn(b)?{err:b}:{err:new Re(oe(b),null)}}if(!s)return{err:new Re("unenvelope(): Response body is missing",null)};const{statusCode:i,response:u,headers:g}=s;if(i===void 0)return L(H({},e),{body:s,unpacked:!0});if(i<200||i>=300){let b=u&&u.error||e.err;return b||(b=new Error("Error in unenveloping "+s),b.statusCode=i),{err:b,body:u,headers:g,unpacked:!0,statusCode:i}}return{err:e.err,body:u,headers:g,unpacked:!0,statusCode:i}}function mr(e,t,n,s,i){e.err?f.logAction(i,f.LOG_MICRO,"Resource."+t+"()","Received Error; "+st(n,s)+"; Error: "+oe(e.err)):f.logAction(i,f.LOG_MICRO,"Resource."+t+"()","Received; "+st(n,s)+"; Headers: "+wn(e.headers)+"; StatusCode: "+e.statusCode+"; Body: "+(_.BufferUtils.isBuffer(e.body)?" (Base64): "+_.BufferUtils.base64Encode(e.body):": "+_.Config.inspect(e.body)))}var yr=class Kt{static async get(t,n,s,i,u,g){return Kt.do(he.Get,t,n,null,s,i,u,g??!1)}static async delete(t,n,s,i,u,g){return Kt.do(he.Delete,t,n,null,s,i,u,g)}static async post(t,n,s,i,u,g,b){return Kt.do(he.Post,t,n,s,i,u,g,b)}static async patch(t,n,s,i,u,g,b){return Kt.do(he.Patch,t,n,s,i,u,g,b)}static async put(t,n,s,i,u,g,b){return Kt.do(he.Put,t,n,s,i,u,g,b)}static async do(t,n,s,i,u,g,b,S){b&&((g=g||{}).envelope=b);const C=n.logger;async function E(j,M){var V;if(C.shouldLog(f.LOG_MICRO)){let J=i;if(((V=j["content-type"])==null?void 0:V.indexOf("msgpack"))>0)try{n._MsgPack||be("MsgPack"),J=n._MsgPack.decode(i)}catch(ie){f.logAction(C,f.LOG_MICRO,"Resource."+t+"()","Sending MsgPack Decoding Error: "+oe(ie))}f.logAction(C,f.LOG_MICRO,"Resource."+t+"()","Sending; "+st(s,M)+"; Body: "+J)}const G=await n.http.do(t,s,j,i,M);return G.error&&Je.isTokenErr(G.error)?(await n.auth.authorize(null,null),hs(n,j,M,E)):{err:G.error,body:G.body,headers:G.headers,unpacked:G.unpacked,statusCode:G.statusCode}}let P=await hs(n,u,g,E);if(b&&(P=gr(P,n._MsgPack,b)),C.shouldLog(f.LOG_MICRO)&&mr(P,t,s,g,C),S){if(P.err)throw P.err;{const j=H({},P);return delete j.err,j}}return P}},de=yr;function rt(e){const t=e.match(/^\.\/(\w+)\?(.*)$/);return t&&t[2]&&Et(t[2])}function br(e){typeof e=="string"&&(e=e.split(","));const t={};for(let n=0;n<e.length;n++){const s=e[n].match(/^\s*<(.+)>;\s*rel="(\w+)"$/);if(s){const i=rt(s[1]);i&&(t[s[2]]=i)}}return t}function vr(e,t,n){return!(n&&(t||typeof e.code=="number"))}var wr=class{constructor(e,t,n,s,i,u){this.client=e,this.path=t,this.headers=n,this.envelope=s??null,this.bodyHandler=i,this.useHttpPaginatedResponse=u||!1}get logger(){return this.client.logger}async get(e){const t=await de.get(this.client,this.path,this.headers,e,this.envelope,!1);return this.handlePage(t)}async delete(e){const t=await de.delete(this.client,this.path,this.headers,e,this.envelope,!1);return this.handlePage(t)}async post(e,t){const n=await de.post(this.client,this.path,t,this.headers,e,this.envelope,!1);return this.handlePage(n)}async put(e,t){const n=await de.put(this.client,this.path,t,this.headers,e,this.envelope,!1);return this.handlePage(n)}async patch(e,t){const n=await de.patch(this.client,this.path,t,this.headers,e,this.envelope,!1);return this.handlePage(n)}async handlePage(e){if(e.err&&vr(e.err,e.body,this.useHttpPaginatedResponse))throw f.logAction(this.logger,f.LOG_ERROR,"PaginatedResource.handlePage()","Unexpected error getting resource: err = "+oe(e.err)),e.err;let t,n,s;try{t=e.statusCode==Lt.NoContent?[]:await this.bodyHandler(e.body,e.headers||{},e.unpacked)}catch(i){throw e.err||i}return e.headers&&(n=e.headers.Link||e.headers.link)&&(s=br(n)),this.useHttpPaginatedResponse?new fs(this,t,e.headers||{},e.statusCode,s,e.err):new ds(this,t,s)}},ds=class{constructor(e,t,n){this.resource=e,this.items=t;const s=this;n&&("first"in n&&(this.first=async function(){return s.get(n.first)}),"current"in n&&(this.current=async function(){return s.get(n.current)}),this.next=async function(){return"next"in n?s.get(n.next):null},this.hasNext=function(){return"next"in n},this.isLast=()=>{var i;return!((i=this.hasNext)!=null&&i.call(this))})}async get(e){const t=this.resource,n=await de.get(t.client,t.path,t.headers,e,t.envelope,!1);return t.handlePage(n)}},fs=class extends ds{constructor(e,t,n,s,i,u){super(e,t,i),this.statusCode=s,this.success=s<300&&s>=200,this.headers=n,this.errorCode=u&&u.code,this.errorMessage=u&&u.message}toJSON(){return{items:this.items,statusCode:this.statusCode,success:this.success,headers:this.headers,errorCode:this.errorCode,errorMessage:this.errorMessage}}},Qe=wr,Sn=class Dn{toJSON(){return{channel:this.channel,deviceId:this.deviceId,clientId:this.clientId}}toString(){let t="[PushChannelSubscription";return this.channel&&(t+="; channel="+this.channel),this.deviceId&&(t+="; deviceId="+this.deviceId),this.clientId&&(t+="; clientId="+this.clientId),t+="]",t}static fromResponseBody(t,n,s){return s&&(t=Me(t,n,s)),Array.isArray(t)?Dn.fromValuesArray(t):Dn.fromValues(t)}static fromValues(t){return Object.assign(new Dn,t)}static fromValuesArray(t){const n=t.length,s=new Array(n);for(let i=0;i<n;i++)s[i]=Dn.fromValues(t[i]);return s}};Sn.toRequestBody=He;var Cr=Sn,_n=Cr,Sr=class{constructor(e){var t;this.client=e,this.admin=new _r(e),_.Config.push&&((t=e.options.plugins)!=null&&t.Push)&&(this.stateMachine=new e.options.plugins.Push.ActivationStateMachine(e),this.LocalDevice=e.options.plugins.Push.localDeviceFactory(ht))}async activate(e,t){await new Promise((n,s)=>{var i;if(!((i=this.client.options.plugins)!=null&&i.Push)){s(Mt("Push"));return}if(!this.stateMachine){s(new A("This platform is not supported as a target of push notifications",4e4,400));return}if(this.stateMachine.activatedCallback){s(new A("Activation already in progress",4e4,400));return}this.stateMachine.activatedCallback=u=>{if(u){s(u);return}n()},this.stateMachine.updateFailedCallback=t,this.stateMachine.handleEvent(new this.client.options.plugins.Push.CalledActivate(this.stateMachine,e))})}async deactivate(e){await new Promise((t,n)=>{var s;if(!((s=this.client.options.plugins)!=null&&s.Push)){n(Mt("Push"));return}if(!this.stateMachine){n(new A("This platform is not supported as a target of push notifications",4e4,400));return}if(this.stateMachine.deactivatedCallback){n(new A("Deactivation already in progress",4e4,400));return}this.stateMachine.deactivatedCallback=i=>{if(i){n(i);return}t()},this.stateMachine.handleEvent(new this.client.options.plugins.Push.CalledDeactivate(this.stateMachine,e))})}},_r=class{constructor(e){this.client=e,this.deviceRegistrations=new Rr(e),this.channelSubscriptions=new Or(e)}async publish(e,t){const n=this.client,s=n.options.useBinaryProtocol?"msgpack":"json",i=$.defaultPostHeaders(n.options,{format:s}),u={},g=Z({recipient:e},t);Z(i,n.options.headers),n.options.pushFullWait&&Z(u,{fullWait:"true"});const b=He(g,n._MsgPack,s);await de.post(n,"/push/publish",b,i,u,null,!0)}},Rr=class{constructor(e){this.client=e}async save(e){const t=this.client,n=ht.fromValues(e),s=t.options.useBinaryProtocol?"msgpack":"json",i=$.defaultPostHeaders(t.options,{format:s}),u={};Z(i,t.options.headers),t.options.pushFullWait&&Z(u,{fullWait:"true"});const g=He(n,t._MsgPack,s),b=await de.put(t,"/push/deviceRegistrations/"+encodeURIComponent(e.id),g,i,u,null,!0);return ht.fromResponseBody(b.body,t._MsgPack,b.unpacked?void 0:s)}async get(e){const t=this.client,n=t.options.useBinaryProtocol?"msgpack":"json",s=$.defaultGetHeaders(t.options,{format:n}),i=e.id||e;if(typeof i!="string"||!i.length)throw new A("First argument to DeviceRegistrations#get must be a deviceId string or DeviceDetails",4e4,400);Z(s,t.options.headers);const u=await de.get(t,"/push/deviceRegistrations/"+encodeURIComponent(i),s,{},null,!0);return ht.fromResponseBody(u.body,t._MsgPack,u.unpacked?void 0:n)}async list(e){const t=this.client,n=t.options.useBinaryProtocol?"msgpack":"json",s=this.client.http.supportsLinkHeaders?void 0:n,i=$.defaultGetHeaders(t.options,{format:n});return Z(i,t.options.headers),new Qe(t,"/push/deviceRegistrations",i,s,async function(u,g,b){return ht.fromResponseBody(u,t._MsgPack,b?void 0:n)}).get(e)}async remove(e){const t=this.client,n=t.options.useBinaryProtocol?"msgpack":"json",s=$.defaultGetHeaders(t.options,{format:n}),i={},u=e.id||e;if(typeof u!="string"||!u.length)throw new A("First argument to DeviceRegistrations#remove must be a deviceId string or DeviceDetails",4e4,400);Z(s,t.options.headers),t.options.pushFullWait&&Z(i,{fullWait:"true"}),await de.delete(t,"/push/deviceRegistrations/"+encodeURIComponent(u),s,i,null,!0)}async removeWhere(e){const t=this.client,n=t.options.useBinaryProtocol?"msgpack":"json",s=$.defaultGetHeaders(t.options,{format:n});Z(s,t.options.headers),t.options.pushFullWait&&Z(e,{fullWait:"true"}),await de.delete(t,"/push/deviceRegistrations",s,e,null,!0)}},Or=class Yo{constructor(t){this.remove=Yo.prototype.removeWhere,this.client=t}async save(t){const n=this.client,s=_n.fromValues(t),i=n.options.useBinaryProtocol?"msgpack":"json",u=$.defaultPostHeaders(n.options,{format:i}),g={};Z(u,n.options.headers),n.options.pushFullWait&&Z(g,{fullWait:"true"});const b=He(s,n._MsgPack,i),S=await de.post(n,"/push/channelSubscriptions",b,u,g,null,!0);return _n.fromResponseBody(S.body,n._MsgPack,S.unpacked?void 0:i)}async list(t){const n=this.client,s=n.options.useBinaryProtocol?"msgpack":"json",i=this.client.http.supportsLinkHeaders?void 0:s,u=$.defaultGetHeaders(n.options,{format:s});return Z(u,n.options.headers),new Qe(n,"/push/channelSubscriptions",u,i,async function(g,b,S){return _n.fromResponseBody(g,n._MsgPack,S?void 0:s)}).get(t)}async removeWhere(t){const n=this.client,s=n.options.useBinaryProtocol?"msgpack":"json",i=$.defaultGetHeaders(n.options,{format:s});Z(i,n.options.headers),n.options.pushFullWait&&Z(t,{fullWait:"true"}),await de.delete(n,"/push/channelSubscriptions",i,t,null,!0)}async listChannels(t){const n=this.client,s=n.options.useBinaryProtocol?"msgpack":"json",i=this.client.http.supportsLinkHeaders?void 0:s,u=$.defaultGetHeaders(n.options,{format:s});return Z(u,n.options.headers),n.options.pushFullWait&&Z(t,{fullWait:"true"}),new Qe(n,"/push/channels",u,i,async function(g,b,S){const C=!S&&s?Me(g,n._MsgPack,s):g;for(let E=0;E<C.length;E++)C[E]=String(C[E]);return C}).get(t)}},kr=Sr,ee={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16,AUTH:17,ACTIVATE:18},ps=[];Object.keys(ee).forEach(function(e){ps[ee[e]]=e});var We={HAS_PRESENCE:1,HAS_BACKLOG:2,RESUMED:4,TRANSIENT:16,ATTACH_RESUME:32,PRESENCE:65536,PUBLISH:1<<17,SUBSCRIBE:1<<18,PRESENCE_SUBSCRIBE:1<<19},Tr=Object.keys(We);We.MODE_ALL=We.PRESENCE|We.PUBLISH|We.SUBSCRIBE|We.PRESENCE_SUBSCRIBE;var gs=["PRESENCE","PUBLISH","SUBSCRIBE","PRESENCE_SUBSCRIBE"];function Y(e){return!e||!e.channelOptions?{channelOptions:e,plugins:{},baseEncodedPreviousPayload:void 0}:e}function Ut(e,t,n){if(n&&n.cipher){e||be("Crypto");const s=e.getCipher(n.cipher,t);return{cipher:s.cipherParams,channelCipher:s.cipher}}return n??{}}async function qt(e,t){let n=e.data,s=e.encoding,i=t.channelCipher;s=s?s+"/":"",_.BufferUtils.isBuffer(n)||(n=_.BufferUtils.utf8Encode(String(n)),s=s+"utf-8/");const u=await i.encrypt(n);return e.data=u,e.encoding=s+"cipher+"+i.algorithm,e}async function ms(e,t){const n=e.data;if(!(typeof n=="string"||_.BufferUtils.isBuffer(n)||n===null||n===void 0))if(at(n)||Array.isArray(n))e.data=JSON.stringify(n),e.encoding=e.encoding?e.encoding+"/json":"json";else throw new A("Data type is unsupported",40013,400);return t!=null&&t.cipher?qt(e,t):e}async function ys(e,t){const n=Y(t);let s=e.data;const i=e.encoding;if(i){const u=i.split("/");let g,b=u.length,S=e.data,C="";try{for(;(g=b)>0;){const E=u[--b].match(/([-\w]+)(\+([\w-]+))?/);if(!E)break;switch(C=E[1],C){case"base64":S=_.BufferUtils.base64Decode(String(S)),g==u.length&&(s=S);continue;case"utf-8":S=_.BufferUtils.utf8Decode(S);continue;case"json":S=JSON.parse(S);continue;case"cipher":if(n.channelOptions!=null&&n.channelOptions.cipher&&n.channelOptions.channelCipher){const P=E[3],j=n.channelOptions.channelCipher;if(P!=j.algorithm)throw new Error("Unable to decrypt message with given cipher; incompatible cipher params");S=await j.decrypt(S);continue}else throw new Error("Unable to decrypt message; not an encrypted channel");case"vcdiff":if(!n.plugins||!n.plugins.vcdiff)throw new A("Missing Vcdiff decoder (https://github.com/ably-forks/vcdiff-decoder)",40019,400);if(typeof Uint8Array>"u")throw new A("Delta decoding not supported on this browser (need ArrayBuffer & Uint8Array)",40020,400);try{let P=n.baseEncodedPreviousPayload;typeof P=="string"&&(P=_.BufferUtils.utf8Encode(P));const j=_.BufferUtils.toBuffer(P);S=_.BufferUtils.toBuffer(S),S=_.BufferUtils.arrayBufferViewToBuffer(n.plugins.vcdiff.decode(S,j)),s=S}catch(P){throw new A("Vcdiff delta decode failed with "+P,40018,400)}continue;default:throw new Error("Unknown encoding")}}}catch(E){const P=E;throw new A("Error processing the "+C+" encoding, decoder returned ‘"+P.message+"’",P.code||40013,400)}finally{e.encoding=g<=0?null:u.slice(0,g).join("/"),e.data=S}}n.baseEncodedPreviousPayload=s}function Rn(...e){let t=this.encoding,n=this.data;return n&&_.BufferUtils.isBuffer(n)&&(e.length>0?(t=t?t+"/base64":"base64",n=_.BufferUtils.base64Encode(n)):n=_.BufferUtils.toBuffer(n)),Object.assign({},this,{encoding:t,data:n})}function bs(e){const{id:t,connectionId:n,timestamp:s,channelSerial:i}=e;let u;switch(e.action){case ee.MESSAGE:{u=e.messages;for(let g=0;g<u.length;g++){const b=e.messages[g];i&&!b.version&&(b.version=i+":"+g.toString().padStart(3,"0"))}break}case ee.PRESENCE:case ee.SYNC:u=e.presence;break;default:throw new A("Unexpected action "+e.action,4e4,400)}for(let g=0;g<u.length;g++){const b=u[g];b.connectionId||(b.connectionId=n),b.timestamp||(b.timestamp=s),t&&!b.id&&(b.id=t+":"+g)}}function Dt(e,t){let n="["+t;for(const s in e)s==="data"?typeof e.data=="string"?n+="; data="+e.data:_.BufferUtils.isBuffer(e.data)?n+="; data (buffer)="+_.BufferUtils.base64Encode(e.data):n+="; data (json)="+JSON.stringify(e.data):s&&(s==="extras"||s==="operation")?n+="; "+s+"="+JSON.stringify(e[s]):e[s]!==void 0&&(n+="; "+s+"="+e[s]);return n+="]",n}var Bt=class{},vs=["absent","present","enter","leave","update"];async function ws(e,t,n,s){const i=Ut(t,e,s??null);return Ct.fromValues(n).decode(i,e)}async function Ii(e,t,n,s){return Promise.all(n.map(function(i){return ws(e,t,i,s)}))}async function Ar(e,t){return Ct.fromValues(e).decode(t.channelOptions,t.logger)}async function Cs(e,t){return Promise.all(e.map(function(n){return Ar(n,t)}))}var Er=class Bn extends Bt{isSynthesized(){return!this.id||!this.connectionId?!0:this.id.substring(this.connectionId.length,0)!==this.connectionId}parseId(){if(!this.id)throw new Error("parseId(): Presence message does not contain an id");const t=this.id.split(":");return{connectionId:t[0],msgSerial:parseInt(t[1],10),index:parseInt(t[2],10)}}async encode(t){const n=Object.assign(new Ct,this,{action:vs.indexOf(this.action||"present")});return ms(n,t)}static fromValues(t){return Object.assign(new Bn,t)}static fromValuesArray(t){return t.map(n=>Bn.fromValues(n))}static fromData(t){return t instanceof Bn?t:Bn.fromValues({data:t})}toString(){return Dt(this,"PresenceMessage")}},Ct=class Ci extends Bt{toJSON(...t){return Rn.call(this,...t)}static fromValues(t){return Object.assign(new Ci,t)}static fromValuesArray(t){return t.map(n=>Ci.fromValues(n))}async decode(t,n){const s=Object.assign(new Er,L(H({},this),{action:vs[this.action]}));try{await ys(s,t)}catch(i){f.logAction(n,f.LOG_ERROR,"WirePresenceMessage.decode()",oe(i))}return s}toString(){return Dt(this,"WirePresenceMessage")}},Ye=Er,Pr=class{constructor(e){this.channel=e}get logger(){return this.channel.logger}async get(e){f.logAction(this.logger,f.LOG_MICRO,"RestPresence.get()","channel = "+this.channel.name);const t=this.channel.client,n=t.options.useBinaryProtocol?"msgpack":"json",s=this.channel.client.http.supportsLinkHeaders?void 0:n,i=$.defaultGetHeaders(t.options,{format:n});return Z(i,t.options.headers),new Qe(t,this.channel.client.rest.presenceMixin.basePath(this),i,s,async(u,g,b)=>{const S=b?u:Me(u,t._MsgPack,n);return Cs(S,this.channel)}).get(e)}async history(e){return f.logAction(this.logger,f.LOG_MICRO,"RestPresence.history()","channel = "+this.channel.name),this.channel.client.rest.presenceMixin.history(this,e)}},Ir=Pr,Ss=["message.create","message.update","message.delete","meta.occupancy","message.summary"];function Mr(e){return Ss[e||0]||"unknown"}function xr(e){let t=0;return e.name&&(t+=e.name.length),e.clientId&&(t+=e.clientId.length),e.extras&&(t+=JSON.stringify(e.extras).length),e.data&&(t+=Qn(e.data)),t}async function _s(e,t,n,s){const i=Ut(t,e,s??null);return fe.fromValues(n).decode(i,e)}async function Lr(e,t,n,s){return Promise.all(n.map(function(i){return _s(e,t,i,s)}))}async function Nr(e,t){return fe.fromValues(e).decode(t.channelOptions,t.logger)}async function Ur(e,t){return Promise.all(e.map(function(n){return Nr(n,t)}))}async function Rs(e,t){return Promise.all(e.map(n=>n.encode(t)))}var qr=He;function On(e){let t,n=0;for(let s=0;s<e.length;s++)t=e[s],n+=t.size||(t.size=xr(t));return n}var Os=class Si extends Bt{expandFields(){this.action==="message.create"&&(this.version&&!this.serial&&(this.serial=this.version),this.timestamp&&!this.createdAt&&(this.createdAt=this.timestamp))}async encode(t){const n=Object.assign(new fe,this,{action:Ss.indexOf(this.action||"message.create")});return ms(n,t)}static fromValues(t){return Object.assign(new Si,t)}static fromValuesArray(t){return t.map(n=>Si.fromValues(n))}toString(){return Dt(this,"Message")}},fe=class _i extends Bt{toJSON(...t){return Rn.call(this,...t)}static fromValues(t){return Object.assign(new _i,t)}static fromValuesArray(t){return t.map(n=>_i.fromValues(n))}async decodeWithErr(t,n){const s=Object.assign(new Os,L(H({},this),{action:Mr(this.action)}));let i;try{await ys(s,t)}catch(u){f.logAction(n,f.LOG_ERROR,"WireMessage.decode()",oe(u)),i=u}return s.expandFields(),{decoded:s,err:i}}async decode(t,n){const{decoded:s}=await this.decodeWithErr(t,n);return s}toString(){return Dt(this,"WireMessage")}},ze=Os,Dr=9;function d(e){return e.every(function(t){return!t.id})}var r=class{constructor(e,t,n){var s,i;f.logAction(e.logger,f.LOG_MINOR,"RestChannel()","started; name = "+t),this.name=t,this.client=e,this.presence=new Ir(this),this.channelOptions=xt((s=e._Crypto)!=null?s:null,this.logger,n),(i=e.options.plugins)!=null&&i.Push&&(this._push=new e.options.plugins.Push.PushChannel(this))}get push(){return this._push||be("Push"),this._push}get logger(){return this.client.logger}setOptions(e){var t;this.channelOptions=xt((t=this.client._Crypto)!=null?t:null,this.logger,e)}async history(e){return f.logAction(this.logger,f.LOG_MICRO,"RestChannel.history()","channel = "+this.name),this.client.rest.channelMixin.history(this,e)}async publish(...e){const t=e[0],n=e[1];let s,i;if(typeof t=="string"||t===null)s=[ze.fromValues({name:t,data:n})],i=e[2];else if(at(t))s=[ze.fromValues(t)],i=e[1];else if(Array.isArray(t))s=ze.fromValuesArray(t),i=e[1];else throw new A("The single-argument form of publish() expects a message object or an array of message objects",40013,400);i||(i={});const u=this.client,g=u.options,b=g.useBinaryProtocol?"msgpack":"json",S=u.options.idempotentRestPublishing,C=$.defaultPostHeaders(u.options,{format:b});if(Z(C,g.headers),S&&d(s)){const M=await Yn(Dr);s.forEach(function(V,G){V.id=M+":"+G.toString()})}const E=await Rs(s,this.channelOptions),P=On(E),j=g.maxMessageSize;if(P>j)throw new A("Maximum size of messages that can be published at once exceeded ( was "+P+" bytes; limit is "+j+" bytes)",40009,400);await this._publish(qr(E,u._MsgPack,b),C,i)}async _publish(e,t,n){await de.post(this.client,this.client.rest.channelMixin.basePath(this)+"/messages",e,t,n,null,!0)}async status(){return this.client.rest.channelMixin.status(this)}},l=r,m=class Zo{constructor(t){this.entries=t&&t.entries||void 0,this.schema=t&&t.schema||void 0,this.appId=t&&t.appId||void 0,this.inProgress=t&&t.inProgress||void 0,this.unit=t&&t.unit||void 0,this.intervalId=t&&t.intervalId||void 0}static fromValues(t){return new Zo(t)}},v=m,T=class{static basePath(e){return"/channels/"+encodeURIComponent(e.name)}static history(e,t){const n=e.client,s=n.options.useBinaryProtocol?"msgpack":"json",i=e.client.http.supportsLinkHeaders?void 0:s,u=$.defaultGetHeaders(n.options,{format:s});return Z(u,n.options.headers),new Qe(n,this.basePath(e)+"/messages",u,i,async function(g,b,S){const C=S?g:Me(g,n._MsgPack,s);return Ur(C,e)}).get(t)}static async status(e){const t=e.client.options.useBinaryProtocol?"msgpack":"json",n=$.defaultPostHeaders(e.client.options,{format:t});return(await de.get(e.client,this.basePath(e),n,{},t,!0)).body}},B=class{static basePath(e){return T.basePath(e.channel)+"/presence"}static async history(e,t){const n=e.channel.client,s=n.options.useBinaryProtocol?"msgpack":"json",i=e.channel.client.http.supportsLinkHeaders?void 0:s,u=$.defaultGetHeaders(n.options,{format:s});return Z(u,n.options.headers),new Qe(n,this.basePath(e)+"/history",u,i,async(g,b,S)=>{const C=S?g:Me(g,n._MsgPack,s);return Cs(C,e.channel)}).get(t)}},z=class{constructor(e){this.channelMixin=T,this.presenceMixin=B,this.Resource=de,this.DeviceDetails=ht,this.client=e,this.channels=new X(this.client),this.push=new kr(this.client)}async stats(e){const t=$.defaultGetHeaders(this.client.options),n=this.client.options.useBinaryProtocol?"msgpack":"json",s=this.client.http.supportsLinkHeaders?void 0:n;return Z(t,this.client.options.headers),new Qe(this.client,"/stats",t,s,function(i,u,g){const b=g?i:JSON.parse(i);for(let S=0;S<b.length;S++)b[S]=v.fromValues(b[S]);return b}).get(e)}async time(e){const t=$.defaultGetHeaders(this.client.options);this.client.options.headers&&Z(t,this.client.options.headers);const n=b=>this.client.baseUri(b)+"/time";let{error:s,body:i,unpacked:u}=await this.client.http.do(he.Get,n,t,null,e);if(s)throw s;u||(i=JSON.parse(i));const g=i[0];if(!g)throw new A("Internal error (unexpected result type from GET /time)",5e4,500);return this.client.serverTimeOffset=g-Date.now(),g}async request(e,t,n,s,i,u){var g;const[b,S,C]=this.client.options.useBinaryProtocol?(this.client._MsgPack||be("MsgPack"),[this.client._MsgPack.encode,this.client._MsgPack.decode,"msgpack"]):[JSON.stringify,JSON.parse,"json"],E=this.client.http.supportsLinkHeaders?void 0:C;s=s||{};const P=e.toLowerCase(),j=P=="get"?$.defaultGetHeaders(this.client.options,{format:C,protocolVersion:n}):$.defaultPostHeaders(this.client.options,{format:C,protocolVersion:n});typeof i!="string"&&(i=(g=b(i))!=null?g:null),Z(j,this.client.options.headers),u&&Z(j,u);const M=new Qe(this.client,t,j,E,async function(V,G,J){return Yt(J?V:S(V))},!0);if(!_.Http.methods.includes(P))throw new A("Unsupported method "+P,40500,405);return _.Http.methodsWithBody.includes(P)?M[P](s,i):M[P](s)}async batchPublish(e){let t,n;Array.isArray(e)?(t=e,n=!1):(t=[e],n=!0);const s=this.client.options.useBinaryProtocol?"msgpack":"json",i=$.defaultPostHeaders(this.client.options,{format:s});this.client.options.headers&&Z(i,this.client.options.headers);const u=He(t,this.client._MsgPack,s),g=await de.post(this.client,"/messages",u,i,{},null,!0),b=g.unpacked?g.body:Me(g.body,this.client._MsgPack,s);return n?b[0]:b}async batchPresence(e){const t=this.client.options.useBinaryProtocol?"msgpack":"json",n=$.defaultPostHeaders(this.client.options,{format:t});this.client.options.headers&&Z(n,this.client.options.headers);const s=e.join(","),i=await de.get(this.client,"/presence",n,{channels:s},null,!0);return i.unpacked?i.body:Me(i.body,this.client._MsgPack,t)}async revokeTokens(e,t){if(ls(this.client.options))throw new A("Cannot revoke tokens when using token auth",40162,401);const n=this.client.options.keyName;let s=t??{};const i=H({targets:e.map(C=>`${C.type}:${C.value}`)},s),u=this.client.options.useBinaryProtocol?"msgpack":"json",g=$.defaultPostHeaders(this.client.options,{format:u});this.client.options.headers&&Z(g,this.client.options.headers);const b=He(i,this.client._MsgPack,u),S=await de.post(this.client,`/keys/${n}/revokeTokens`,b,g,{},null,!0);return S.unpacked?S.body:Me(S.body,this.client._MsgPack,u)}},X=class{constructor(e){this.client=e,this.all=Object.create(null)}get(e,t){e=String(e);let n=this.all[e];return n?t&&n.setOptions(t):this.all[e]=n=new l(this.client,e,t),n}release(e){delete this.all[String(e)]}},se=class extends us{constructor(e){super($.objectifyOptions(e,!1,"BaseRest",f.defaultLogger,{Rest:z}))}},re={Rest:z},pe=class extends ze{static async fromEncoded(e,t){return _s(f.defaultLogger,_.Crypto,e,t)}static async fromEncodedArray(e,t){return Lr(f.defaultLogger,_.Crypto,e,t)}static fromValues(e){return ze.fromValues(e)}},St=class extends Ye{static async fromEncoded(e,t){return ws(f.defaultLogger,_.Crypto,e,t)}static async fromEncodedArray(e,t){return Ii(f.defaultLogger,_.Crypto,e,t)}static fromValues(e){return Ye.fromValues(e)}},dt=class Bs extends se{constructor(t){var n,s;if(!Bs._MsgPack)throw new Error("Expected DefaultRest._MsgPack to have been set");super($.objectifyOptions(t,!0,"Rest",f.defaultLogger,L(H({},re),{Crypto:(n=Bs.Crypto)!=null?n:void 0,MsgPack:(s=Bs._MsgPack)!=null?s:void 0})))}static get Crypto(){if(this._Crypto===null)throw new Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto(t){this._Crypto=t}};dt._Crypto=null,dt.Message=pe,dt.PresenceMessage=St,dt._MsgPack=null,dt._Http=Cn;var jt=dt;function Br(e,t,n,s){try{n.apply(t,s)}catch(i){f.logAction(e,f.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+i+"; stack = "+(i&&i.stack))}}function Ht(e,t,n){let s,i,u;for(let g=0;g<e.length;g++)if(s=e[g],n&&(s=s[n]),Array.isArray(s)){for(;(i=s.indexOf(t))!==-1;)s.splice(i,1);n&&s.length===0&&delete e[g][n]}else if(at(s))for(u in s)Object.prototype.hasOwnProperty.call(s,u)&&Array.isArray(s[u])&&Ht([s],t,u)}var jr=class{constructor(e){this.logger=e,this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null)}on(...e){if(e.length===1){const t=e[0];if(typeof t=="function")this.any.push(t);else throw new Error("EventListener.on(): Invalid arguments: "+_.Config.inspect(e))}if(e.length===2){const[t,n]=e;if(typeof n!="function")throw new Error("EventListener.on(): Invalid arguments: "+_.Config.inspect(e));if(Ce(t))this.any.push(n);else if(Array.isArray(t))t.forEach(s=>{this.on(s,n)});else{if(typeof t!="string")throw new Error("EventListener.on(): Invalid arguments: "+_.Config.inspect(e));(this.events[t]||(this.events[t]=[])).push(n)}}}off(...e){if(e.length==0||Ce(e[0])&&Ce(e[1])){this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null);return}const[t,n]=e;let s=null,i=null;if(e.length===1||!n)typeof t=="function"?s=t:i=t;else{if(typeof n!="function")throw new Error("EventEmitter.off(): invalid arguments:"+_.Config.inspect(e));[i,s]=[t,n]}if(s&&Ce(i)){Ht([this.any,this.events,this.anyOnce,this.eventsOnce],s);return}if(Array.isArray(i)){i.forEach(u=>{this.off(u,s)});return}if(typeof i!="string")throw new Error("EventEmitter.off(): invalid arguments:"+_.Config.inspect(e));s?Ht([this.events,this.eventsOnce],s,i):(delete this.events[i],delete this.eventsOnce[i])}listeners(e){if(e){const t=this.events[e]||[];return this.eventsOnce[e]&&Array.prototype.push.apply(t,this.eventsOnce[e]),t.length?t:null}return this.any.length?this.any:null}emit(e,...t){const n={event:e},s=[];this.anyOnce.length&&(Array.prototype.push.apply(s,this.anyOnce),this.anyOnce=[]),this.any.length&&Array.prototype.push.apply(s,this.any);const i=this.eventsOnce[e];i&&(Array.prototype.push.apply(s,i),delete this.eventsOnce[e]);const u=this.events[e];u&&Array.prototype.push.apply(s,u),s.forEach(g=>{Br(this.logger,n,g,t)})}once(...e){const t=e.length;if(t===0||t===1&&typeof e[0]!="function"){const i=e[0];return new Promise(u=>{this.once(i,u)})}const[n,s]=e;if(e.length===1&&typeof n=="function")this.anyOnce.push(n);else if(Ce(n)){if(typeof s!="function")throw new Error("EventEmitter.once(): Invalid arguments:"+_.Config.inspect(e));this.anyOnce.push(s)}else if(Array.isArray(n)){const i=this,u=function(){const g=Array.prototype.slice.call(arguments);if(n.forEach(function(b){i.off(b,u)}),typeof s!="function")throw new Error("EventEmitter.once(): Invalid arguments:"+_.Config.inspect(e));s.apply(this,g)};n.forEach(function(g){i.on(g,u)})}else{if(typeof n!="string")throw new Error("EventEmitter.once(): Invalid arguments:"+_.Config.inspect(e));const i=this.eventsOnce[n]||(this.eventsOnce[n]=[]);if(s){if(typeof s!="function")throw new Error("EventEmitter.once(): Invalid arguments:"+_.Config.inspect(e));i.push(s)}}}async whenState(e,t){if(typeof e!="string"||typeof t!="string")throw new Error("whenState requires a valid state String argument");return e===t?null:this.once(e)}},_e=jr,Hr=He;function ks(e){const t=[];if(e)for(let n=0;n<e.length;n++)t.push(e[n].toString());return"[ "+t.join(", ")+" ]"}function Ts(e,t,n,s){const i=Me(e,t,s);return Gt(i,n)}function Gt(e,t){let n;e.error&&(n=A.fromValues(e.error));let s;e.messages&&(s=fe.fromValuesArray(e.messages));let i;return t&&e.presence&&(i=t.WirePresenceMessage.fromValuesArray(e.presence)),Object.assign(new Ft,L(H({},e),{presence:i,messages:s,error:n}))}function As(e){return Gt(e,{WirePresenceMessage:Ct})}function xe(e){return Object.assign(new Ft,e)}function _t(e,t){let n="[ProtocolMessage";e.action!==void 0&&(n+="; action="+ps[e.action]||e.action);const s=["id","channel","channelSerial","connectionId","count","msgSerial","timestamp"];let i;for(let u=0;u<s.length;u++)i=s[u],e[i]!==void 0&&(n+="; "+i+"="+e[i]);if(e.messages&&(n+="; messages="+ks(fe.fromValuesArray(e.messages))),e.presence&&t&&(n+="; presence="+ks(t.WirePresenceMessage.fromValuesArray(e.presence))),e.error&&(n+="; error="+A.fromValues(e.error).toString()),e.auth&&e.auth.accessToken&&(n+="; token="+e.auth.accessToken),e.flags&&(n+="; flags="+Tr.filter(e.hasFlag).join(",")),e.params){let u="";en(e.params,function(g){u.length>0&&(u+="; "),u+=g+"="+e.params[g]}),u.length>0&&(n+="; params=["+u+"]")}return n+="]",n}var Ft=class{constructor(){this.hasFlag=e=>(this.flags&We[e])>0}setFlag(e){return this.flags=this.flags|We[e]}getMode(){return this.flags&&this.flags&We.MODE_ALL}encodeModesToFlags(e){e.forEach(t=>this.setFlag(t))}decodeModesFromFlags(){const e=[];return gs.forEach(t=>{this.hasFlag(t)&&e.push(t)}),e.length>0?e:void 0}},Es=Ft,Gr=class extends _e{constructor(e){super(e),this.messages=[]}count(){return this.messages.length}push(e){this.messages.push(e)}shift(){return this.messages.shift()}last(){return this.messages[this.messages.length-1]}copyAll(){return this.messages.slice()}append(e){this.messages.push.apply(this.messages,e)}prepend(e){this.messages.unshift.apply(this.messages,e)}completeMessages(e,t,n){f.logAction(this.logger,f.LOG_MICRO,"MessageQueue.completeMessages()","serial = "+e+"; count = "+t),n=n||null;const s=this.messages;if(s.length===0)throw new Error("MessageQueue.completeMessages(): completeMessages called on any empty MessageQueue");const i=s[0];if(i){const u=i.message.msgSerial,g=e+t;if(g>u){const b=s.splice(0,g-u);for(const S of b)S.callback(n)}s.length==0&&this.emit("idle")}}completeAllMessages(e){this.completeMessages(0,Number.MAX_SAFE_INTEGER||Number.MAX_VALUE,e)}resetSendAttempted(){for(let e of this.messages)e.sendAttempted=!1}clear(){f.logAction(this.logger,f.LOG_MICRO,"MessageQueue.clear()","clearing "+this.messages.length+" messages"),this.messages=[],this.emit("idle")}},Ps=Gr,Is=class{constructor(e,t){this.message=e,this.callback=t,this.merged=!1;const n=e.action;this.sendAttempted=!1,this.ackRequired=n==ee.MESSAGE||n==ee.PRESENCE}},Ms=class extends _e{constructor(e){super(e.logger),this.transport=e,this.messageQueue=new Ps(this.logger),e.on("ack",(t,n)=>{this.onAck(t,n)}),e.on("nack",(t,n,s)=>{this.onNack(t,n,s)})}onAck(e,t){f.logAction(this.logger,f.LOG_MICRO,"Protocol.onAck()","serial = "+e+"; count = "+t),this.messageQueue.completeMessages(e,t)}onNack(e,t,n){f.logAction(this.logger,f.LOG_ERROR,"Protocol.onNack()","serial = "+e+"; count = "+t+"; err = "+oe(n)),n||(n=new A("Unable to send message; channel not responding",50001,500)),this.messageQueue.completeMessages(e,t,n)}onceIdle(e){const t=this.messageQueue;if(t.count()===0){e();return}t.once("idle",e)}send(e){e.ackRequired&&this.messageQueue.push(e),this.logger.shouldLog(f.LOG_MICRO)&&f.logActionNoStrip(this.logger,f.LOG_MICRO,"Protocol.send()","sending msg; "+_t(e.message,this.transport.connectionManager.realtime._RealtimePresence)),e.sendAttempted=!0,this.transport.send(e.message)}getTransport(){return this.transport}getPendingMessages(){return this.messageQueue.copyAll()}clearPendingMessages(){return this.messageQueue.clear()}finish(){const e=this.transport;this.onceIdle(function(){e.disconnect()})}},ra=Ms,ia=class{constructor(e,t,n,s){this.previous=e,this.current=t,n&&(this.retryIn=n),s&&(this.reason=s)}},xs=ia,ft={DISCONNECTED:80003,SUSPENDED:80002,FAILED:8e4,CLOSING:80017,CLOSED:80017,UNKNOWN_CONNECTION_ERR:50002,UNKNOWN_CHANNEL_ERR:50001},oa={disconnected:()=>A.fromValues({statusCode:400,code:ft.DISCONNECTED,message:"Connection to server temporarily unavailable"}),suspended:()=>A.fromValues({statusCode:400,code:ft.SUSPENDED,message:"Connection to server unavailable"}),failed:()=>A.fromValues({statusCode:400,code:ft.FAILED,message:"Connection failed or disconnected by server"}),closing:()=>A.fromValues({statusCode:400,code:ft.CLOSING,message:"Connection closing"}),closed:()=>A.fromValues({statusCode:400,code:ft.CLOSED,message:"Connection closed"}),unknownConnectionErr:()=>A.fromValues({statusCode:500,code:ft.UNKNOWN_CONNECTION_ERR,message:"Internal connection error"}),unknownChannelErr:()=>A.fromValues({statusCode:500,code:ft.UNKNOWN_CONNECTION_ERR,message:"Internal channel error"})};function aa(e){return!e.statusCode||!e.code||e.statusCode>=500?!0:Object.values(ft).includes(e.code)}var Rt=oa,ca=xe({action:ee.CLOSE}),la=xe({action:ee.DISCONNECT}),ua=class extends _e{constructor(e,t,n,s){super(e.logger),s&&(n.format=void 0,n.heartbeats=!0),this.connectionManager=e,this.auth=t,this.params=n,this.timeouts=n.options.timeouts,this.format=n.format,this.isConnected=!1,this.isFinished=!1,this.isDisposed=!1,this.maxIdleInterval=null,this.idleTimer=null,this.lastActivity=null}connect(){}close(){this.isConnected&&this.requestClose(),this.finish("closed",Rt.closed())}disconnect(e){this.isConnected&&this.requestDisconnect(),this.finish("disconnected",e||Rt.disconnected())}fail(e){this.isConnected&&this.requestDisconnect(),this.finish("failed",e||Rt.failed())}finish(e,t){var n;this.isFinished||(this.isFinished=!0,this.isConnected=!1,this.maxIdleInterval=null,clearTimeout((n=this.idleTimer)!=null?n:void 0),this.idleTimer=null,this.emit(e,t),this.dispose())}onProtocolMessage(e){switch(this.logger.shouldLog(f.LOG_MICRO)&&f.logActionNoStrip(this.logger,f.LOG_MICRO,"Transport.onProtocolMessage()","received on "+this.shortName+": "+_t(e,this.connectionManager.realtime._RealtimePresence)+"; connectionId = "+this.connectionManager.connectionId),this.onActivity(),e.action){case ee.HEARTBEAT:f.logActionNoStrip(this.logger,f.LOG_MICRO,"Transport.onProtocolMessage()",this.shortName+" heartbeat; connectionId = "+this.connectionManager.connectionId),this.emit("heartbeat",e.id);break;case ee.CONNECTED:this.onConnect(e),this.emit("connected",e.error,e.connectionId,e.connectionDetails,e);break;case ee.CLOSED:this.onClose(e);break;case ee.DISCONNECTED:this.onDisconnect(e);break;case ee.ACK:this.emit("ack",e.msgSerial,e.count);break;case ee.NACK:this.emit("nack",e.msgSerial,e.count,e.error);break;case ee.SYNC:this.connectionManager.onChannelMessage(e,this);break;case ee.ACTIVATE:break;case ee.AUTH:Ee(this.auth.authorize(),t=>{t&&f.logAction(this.logger,f.LOG_ERROR,"Transport.onProtocolMessage()","Ably requested re-authentication, but unable to obtain a new token: "+oe(t))});break;case ee.ERROR:if(f.logAction(this.logger,f.LOG_MINOR,"Transport.onProtocolMessage()","received error action; connectionId = "+this.connectionManager.connectionId+"; err = "+_.Config.inspect(e.error)+(e.channel?", channel: "+e.channel:"")),e.channel===void 0){this.onFatalError(e);break}this.connectionManager.onChannelMessage(e,this);break;default:this.connectionManager.onChannelMessage(e,this)}}onConnect(e){if(this.isConnected=!0,!e.connectionDetails)throw new Error("Transport.onConnect(): Connect message recieved without connectionDetails");const t=e.connectionDetails.maxIdleInterval;t&&(this.maxIdleInterval=t+this.timeouts.realtimeRequestTimeout,this.onActivity())}onDisconnect(e){const t=e&&e.error;f.logAction(this.logger,f.LOG_MINOR,"Transport.onDisconnect()","err = "+oe(t)),this.finish("disconnected",t)}onFatalError(e){const t=e&&e.error;f.logAction(this.logger,f.LOG_MINOR,"Transport.onFatalError()","err = "+oe(t)),this.finish("failed",t)}onClose(e){const t=e&&e.error;f.logAction(this.logger,f.LOG_MINOR,"Transport.onClose()","err = "+oe(t)),this.finish("closed",t)}requestClose(){f.logAction(this.logger,f.LOG_MINOR,"Transport.requestClose()",""),this.send(ca)}requestDisconnect(){f.logAction(this.logger,f.LOG_MINOR,"Transport.requestDisconnect()",""),this.send(la)}ping(e){const t={action:ee.HEARTBEAT};e&&(t.id=e),this.send(xe(t))}dispose(){f.logAction(this.logger,f.LOG_MINOR,"Transport.dispose()",""),this.isDisposed=!0,this.off()}onActivity(){this.maxIdleInterval&&(this.lastActivity=this.connectionManager.lastActivity=Date.now(),this.setIdleTimer(this.maxIdleInterval+100))}setIdleTimer(e){this.idleTimer||(this.idleTimer=setTimeout(()=>{this.onIdleTimerExpire()},e))}onIdleTimerExpire(){if(!this.lastActivity||!this.maxIdleInterval)throw new Error("Transport.onIdleTimerExpire(): lastActivity/maxIdleInterval not set");this.idleTimer=null;const e=Date.now()-this.lastActivity,t=this.maxIdleInterval-e;if(t<=0){const n="No activity seen from realtime in "+e+"ms; assuming connection has dropped";f.logAction(this.logger,f.LOG_ERROR,"Transport.onIdleTimerExpire()",n),this.disconnect(new A(n,80003,408))}else this.setIdleTimer(t+100)}static tryConnect(e,t,n,s,i){const u=new e(t,n,s);let g;const b=function(C){clearTimeout(g),i({event:this.event,error:C})},S=t.options.timeouts.realtimeRequestTimeout;return g=setTimeout(()=>{u.off(["preconnect","disconnected","failed"]),u.dispose(),b.call({event:"disconnected"},new A("Timeout waiting for transport to indicate itself viable",5e4,500))},S),u.on(["failed","disconnected"],b),u.on("preconnect",function(){f.logAction(t.logger,f.LOG_MINOR,"Transport.tryConnect()","viable transport "+u),clearTimeout(g),u.off(["failed","disconnected"],b),i(null,u)}),u.connect(),u}static isAvailable(){throw new A("isAvailable not implemented for transport",5e4,500)}},Wt=ua,Le;(e=>{e.WebSocket="web_socket",e.Comet="comet",e.XhrPolling="xhr_polling"})(Le||(Le={}));var ha=typeof pt<"u"?pt:typeof window<"u"?window:self,Fr=()=>{var e;return typeof _.WebStorage<"u"&&((e=_.WebStorage)==null?void 0:e.localSupported)},kn=()=>{var e;return typeof _.WebStorage<"u"&&((e=_.WebStorage)==null?void 0:e.sessionSupported)},Mi=function(){},Wr="ably-transport-preference";function da(e,t,n){let s;if(e.channel!==t.channel||(s=e.action)!==ee.PRESENCE&&s!==ee.MESSAGE||s!==t.action)return!1;const i=s===ee.PRESENCE?"presence":"messages",u=e[i].concat(t[i]);return On(u)>n||!tn(u,"clientId")||!u.every(function(b){return!b.id})?!1:(e[i]=u,!0)}function zr(e){try{return JSON.parse(e)}catch{return null}}var fa=class{constructor(e,t,n,s){this.options=e,this.host=t,this.mode=n,this.connectionKey=s,this.format=e.useBinaryProtocol?"msgpack":"json"}getConnectParams(e){const t=e?ot(e):{},n=this.options;switch(this.mode){case"resume":t.resume=this.connectionKey;break;case"recover":{const s=zr(n.recover);s&&(t.recover=s.connectionKey);break}}return n.clientId!==void 0&&(t.clientId=n.clientId),n.echoMessages===!1&&(t.echo="false"),this.format!==void 0&&(t.format=this.format),this.stream!==void 0&&(t.stream=this.stream),this.heartbeats!==void 0&&(t.heartbeats=this.heartbeats),t.v=$.protocolVersion,t.agent=un(this.options),n.transportParams!==void 0&&Z(t,n.transportParams),t}toString(){let e="[mode="+this.mode;return this.host&&(e+=",host="+this.host),this.connectionKey&&(e+=",connectionKey="+this.connectionKey),this.format&&(e+=",format="+this.format),e+="]",e}},pa=class ea extends _e{constructor(t,n){super(t.logger),this.supportedTransports={},this.disconnectedRetryCount=0,this.pendingChannelMessagesState={isProcessing:!1,queue:[]},this.realtime=t,this.initTransports(),this.options=n;const s=n.timeouts,i=s.webSocketConnectTimeout+s.realtimeRequestTimeout;if(this.states={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1,failState:"disconnected"},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:i,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:s.disconnectedRetryTimeout,failState:"disconnected"},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:s.suspendedRetryTimeout,failState:"suspended"},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:s.realtimeRequestTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"closed"},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"failed"}},this.state=this.states.initialized,this.errorReason=null,this.queuedMessages=new Ps(this.logger),this.msgSerial=0,this.connectionDetails=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.connectionStateTtl=s.connectionStateTtl,this.maxIdleInterval=null,this.transports=Vn(n.transports||$.defaultTransports,this.supportedTransports),this.transportPreference=null,this.transports.includes(Le.WebSocket)&&(this.webSocketTransportAvailable=!0),this.transports.includes(Le.XhrPolling)?this.baseTransport=Le.XhrPolling:this.transports.includes(Le.Comet)&&(this.baseTransport=Le.Comet),this.httpHosts=$.getHosts(n),this.wsHosts=$.getHosts(n,!0),this.activeProtocol=null,this.host=null,this.lastAutoReconnectAttempt=null,this.lastActivity=null,this.forceFallbackHost=!1,this.connectCounter=0,this.wsCheckResult=null,this.webSocketSlowTimer=null,this.webSocketGiveUpTimer=null,this.abandonedWebSocket=!1,f.logAction(this.logger,f.LOG_MINOR,"Realtime.ConnectionManager()","started"),f.logAction(this.logger,f.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(n.transports||$.defaultTransports)+"]"),f.logAction(this.logger,f.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]"),f.logAction(this.logger,f.LOG_MICRO,"Realtime.ConnectionManager()","http hosts = ["+this.httpHosts+"]"),!this.transports.length){const g="no requested transports available";throw f.logAction(this.logger,f.LOG_ERROR,"realtime.ConnectionManager()",g),new Error(g)}const u=_.Config.addEventListener;u&&(kn()&&typeof n.recover=="function"&&u("beforeunload",this.persistConnection.bind(this)),n.closeOnUnload===!0&&u("beforeunload",()=>{f.logAction(this.logger,f.LOG_MAJOR,"Realtime.ConnectionManager()","beforeunload event has triggered the connection to close as closeOnUnload is true"),this.requestState({state:"closing"})}),u("online",()=>{var g;this.state==this.states.disconnected||this.state==this.states.suspended?(f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager caught browser ‘online’ event","reattempting connection"),this.requestState({state:"connecting"})):this.state==this.states.connecting&&((g=this.pendingTransport)==null||g.off(),this.disconnectAllTransports(),this.startConnect())}),u("offline",()=>{this.state==this.states.connected&&(f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager caught browser ‘offline’ event","disconnecting active transport"),this.disconnectAllTransports())}))}static supportedTransports(t){const n={supportedTransports:{}};return this.initTransports(t,n),n.supportedTransports}static initTransports(t,n){const s=H(H({},_.Transports.bundledImplementations),t);[Le.WebSocket,..._.Transports.order].forEach(i=>{const u=s[i];u&&u.isAvailable()&&(n.supportedTransports[i]=u)})}initTransports(){ea.initTransports(this.realtime._additionalTransportImplementations,this)}createTransportParams(t,n){return new fa(this.options,t,n,this.connectionKey)}getTransportParams(t){(s=>{if(this.connectionKey){s("resume");return}if(typeof this.options.recover=="string"){s("recover");return}const i=this.options.recover,u=this.getSessionRecoverData(),g=this.sessionRecoveryName();if(u&&typeof i=="function"){f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.getTransportParams()","Calling clientOptions-provided recover function with last session data (recovery scope: "+g+")"),i(u,b=>{b?(this.options.recover=u.recoveryKey,s("recover")):s("clean")});return}s("clean")})(s=>{const i=this.createTransportParams(null,s);if(s==="recover"){f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport recovery mode = recover; recoveryKey = "+this.options.recover);const u=zr(this.options.recover);u&&(this.msgSerial=u.msgSerial)}else f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport params = "+i.toString());t(i)})}tryATransport(t,n,s){f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.tryATransport()","trying "+n),this.proposedTransport=Wt.tryConnect(this.supportedTransports[n],this,this.realtime.auth,t,(i,u)=>{const g=this.state;if(g==this.states.closing||g==this.states.closed||g==this.states.failed){u&&(f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.tryATransport()","connection "+g.state+" while we were attempting the transport; closing "+u),u.close()),s(!0);return}if(i){f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.tryATransport()","transport "+n+" "+i.event+", err: "+i.error.toString()),Je.isTokenErr(i.error)&&!(this.errorReason&&Je.isTokenErr(this.errorReason))?(this.errorReason=i.error,Ee(this.realtime.auth._forceNewToken(null,null),b=>{if(b){this.actOnErrorFromAuthorize(b);return}this.tryATransport(t,n,s)})):i.event==="failed"?(this.notifyState({state:"failed",error:i.error}),s(!0)):i.event==="disconnected"&&(aa(i.error)?s(!1):(this.notifyState({state:this.states.connecting.failState,error:i.error}),s(!0)));return}f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.tryATransport()","viable transport "+n+"; setting pending"),this.setTransportPending(u,t),s(null,u)})}setTransportPending(t,n){const s=n.mode;f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+t+"; mode = "+s),this.pendingTransport=t,this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),t.once("connected",(u,g,b)=>{this.activateTransport(u,t,g,b),s==="recover"&&this.options.recover&&(delete this.options.recover,this.unpersistConnection())});const i=this;t.on(["disconnected","closed","failed"],function(u){i.deactivateTransport(t,this.event,u)}),this.emit("transport.pending",t)}activateTransport(t,n,s,i){f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+n),t&&f.logAction(this.logger,f.LOG_ERROR,"ConnectionManager.activateTransport()","error = "+t),s&&f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.activateTransport()","connectionId =  "+s),i&&f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.activateTransport()","connectionDetails =  "+JSON.stringify(i)),this.persistTransportPreference(n);const u=this.state,g=this.states.connected.state;if(f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.activateTransport()","current state = "+u.state),u.state==this.states.closing.state||u.state==this.states.closed.state||u.state==this.states.failed.state)return f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.activateTransport()","Disconnecting transport and abandoning"),n.disconnect(),!1;if(delete this.pendingTransport,!n.isConnected)return f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.activateTransport()","Declining to activate transport "+n+" since it appears to no longer be connected"),!1;const b=this.activeProtocol;this.activeProtocol=new ra(n),this.host=n.params.host;const S=i.connectionKey;if(S&&this.connectionKey!=S&&this.setConnection(s,i,!!t),this.onConnectionDetailsUpdate(i,n),_.Config.nextTick(()=>{n.on("connected",(C,E,P)=>{this.onConnectionDetailsUpdate(P,n),this.emit("update",new xs(g,g,null,C))})}),u.state===this.states.connected.state?t&&(this.errorReason=this.realtime.connection.errorReason=t,this.emit("update",new xs(g,g,null,t))):(this.notifyState({state:"connected",error:t}),this.errorReason=this.realtime.connection.errorReason=t||null),this.emit("transport.active",n),b)if(b.messageQueue.count()>0&&f.logAction(this.logger,f.LOG_ERROR,"ConnectionManager.activateTransport()","Previous active protocol (for transport "+b.transport.shortName+", new one is "+n.shortName+") finishing with "+b.messageQueue.count()+" messages still pending"),b.transport===n){const C="Assumption violated: activating a transport that was also the transport for the previous active protocol; transport = "+n.shortName+"; stack = "+new Error().stack;f.logAction(this.logger,f.LOG_ERROR,"ConnectionManager.activateTransport()",C)}else b.finish();return!0}deactivateTransport(t,n,s){const i=this.activeProtocol,u=i&&i.getTransport()===t,g=t===this.pendingTransport,b=this.noTransportsScheduledForActivation();if(f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+t),f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.deactivateTransport()","state = "+n+(u?"; was active":g?"; was pending":"")+(b?"":"; another transport is scheduled for activation")),s&&s.message&&f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.deactivateTransport()","reason =  "+s.message),u&&(f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.deactivateTransport()","Getting, clearing, and requeuing "+this.activeProtocol.messageQueue.count()+" pending messages"),this.queuePendingMessages(i.getPendingMessages()),i.clearPendingMessages(),this.activeProtocol=this.host=null),this.emit("transport.inactive",t),u&&b||u&&n==="failed"||n==="closed"||i===null&&g){if(n==="disconnected"&&s&&s.statusCode>500&&this.httpHosts.length>1){this.unpersistTransportPreference(),this.forceFallbackHost=!0,this.notifyState({state:n,error:s,retryImmediately:!0});return}const S=n==="failed"&&Je.isTokenErr(s)?"disconnected":n;this.notifyState({state:S,error:s});return}}noTransportsScheduledForActivation(){return!this.pendingTransport||!this.pendingTransport.isConnected}setConnection(t,n,s){const i=this.connectionId;(i&&i!==t||!i&&s)&&(f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.setConnection()","Resetting msgSerial"),this.msgSerial=0,this.queuedMessages.resetSendAttempted()),this.connectionId!==t&&f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.setConnection()","New connectionId; reattaching any attached channels"),this.realtime.connection.id=this.connectionId=t,this.realtime.connection.key=this.connectionKey=n.connectionKey}clearConnection(){this.realtime.connection.id=this.connectionId=void 0,this.realtime.connection.key=this.connectionKey=void 0,this.msgSerial=0,this.unpersistConnection()}createRecoveryKey(){return this.connectionKey?JSON.stringify({connectionKey:this.connectionKey,msgSerial:this.msgSerial,channelSerials:this.realtime.channels.channelSerials()}):null}checkConnectionStateFreshness(){if(!this.lastActivity||!this.connectionId)return;const t=Date.now()-this.lastActivity;t>this.connectionStateTtl+this.maxIdleInterval&&(f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.checkConnectionStateFreshness()","Last known activity from realtime was "+t+"ms ago; discarding connection state"),this.clearConnection(),this.states.connecting.failState="suspended")}persistConnection(){if(kn()){const t=this.createRecoveryKey();t&&this.setSessionRecoverData({recoveryKey:t,disconnectedAt:Date.now(),location:ha.location,clientId:this.realtime.auth.clientId})}}unpersistConnection(){this.clearSessionRecoverData()}getError(){if(this.errorReason){const t=Re.fromValues(this.errorReason);return t.cause=this.errorReason,t}return this.getStateError()}getStateError(){var t,n;return(n=(t=Rt)[this.state.state])==null?void 0:n.call(t)}activeState(){return this.state.queueEvents||this.state.sendEvents}enactStateChange(t){const n="Connection state",s=t.current+(t.reason?"; reason: "+t.reason:"");t.current==="failed"?f.logAction(this.logger,f.LOG_ERROR,n,s):f.logAction(this.logger,f.LOG_MAJOR,n,s),f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+t.current+"; reason = "+(t.reason&&t.reason.message));const i=this.state=this.states[t.current];t.reason&&(this.errorReason=t.reason,this.realtime.connection.errorReason=t.reason),(i.terminal||i.state==="suspended")&&this.clearConnection(),this.emit("connectionstate",t)}startTransitionTimer(t){f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+t.state),this.transitionTimer&&(f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.startTransitionTimer()","clearing already-running timer"),clearTimeout(this.transitionTimer)),this.transitionTimer=setTimeout(()=>{this.transitionTimer&&(this.transitionTimer=null,f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager "+t.state+" timer expired","requesting new state: "+t.failState),this.notifyState({state:t.failState}))},t.retryDelay)}cancelTransitionTimer(){f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()",""),this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=null)}startSuspendTimer(){this.suspendTimer||(this.suspendTimer=setTimeout(()=>{this.suspendTimer&&(this.suspendTimer=null,f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),this.states.connecting.failState="suspended",this.notifyState({state:"suspended"}))},this.connectionStateTtl))}checkSuspendTimer(t){t!=="disconnected"&&t!=="suspended"&&t!=="connecting"&&this.cancelSuspendTimer()}cancelSuspendTimer(){this.states.connecting.failState="disconnected",this.suspendTimer&&(clearTimeout(this.suspendTimer),this.suspendTimer=null)}startRetryTimer(t){this.retryTimer=setTimeout(()=>{f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager retry timer expired","retrying"),this.retryTimer=null,this.requestState({state:"connecting"})},t)}cancelRetryTimer(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)}startWebSocketSlowTimer(){this.webSocketSlowTimer=setTimeout(()=>{f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager WebSocket slow timer","checking connectivity"),this.checkWsConnectivity().then(()=>{f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager WebSocket slow timer","ws connectivity check succeeded"),this.wsCheckResult=!0}).catch(()=>{f.logAction(this.logger,f.LOG_MAJOR,"ConnectionManager WebSocket slow timer","ws connectivity check failed"),this.wsCheckResult=!1}),this.realtime.http.checkConnectivity&&Ee(this.realtime.http.checkConnectivity(),(t,n)=>{t||!n?(f.logAction(this.logger,f.LOG_MAJOR,"ConnectionManager WebSocket slow timer","http connectivity check failed"),this.cancelWebSocketGiveUpTimer(),this.notifyState({state:"disconnected",error:new A("Unable to connect (network unreachable)",80003,404)})):f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager WebSocket slow timer","http connectivity check succeeded")})},this.options.timeouts.webSocketSlowTimeout)}cancelWebSocketSlowTimer(){this.webSocketSlowTimer&&(clearTimeout(this.webSocketSlowTimer),this.webSocketSlowTimer=null)}startWebSocketGiveUpTimer(t){this.webSocketGiveUpTimer=setTimeout(()=>{var n,s;this.wsCheckResult||(f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager WebSocket give up timer","websocket connection took more than 10s; "+(this.baseTransport?"trying base transport":"")),this.baseTransport?(this.abandonedWebSocket=!0,(n=this.proposedTransport)==null||n.dispose(),(s=this.pendingTransport)==null||s.dispose(),this.connectBase(t,++this.connectCounter)):f.logAction(this.logger,f.LOG_MAJOR,"ConnectionManager WebSocket give up timer","websocket connectivity appears to be unavailable but no other transports to try"))},this.options.timeouts.webSocketConnectTimeout)}cancelWebSocketGiveUpTimer(){this.webSocketGiveUpTimer&&(clearTimeout(this.webSocketGiveUpTimer),this.webSocketGiveUpTimer=null)}notifyState(t){var n,s;const i=t.state,u=i==="disconnected"&&(this.state===this.states.connected||t.retryImmediately||this.state===this.states.connecting&&t.error&&Je.isTokenErr(t.error)&&!(this.errorReason&&Je.isTokenErr(this.errorReason)));if(f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+i+(u?"; will retry connection immediately":"")),i==this.state.state||(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.checkSuspendTimer(t.state),(i==="suspended"||i==="connected")&&(this.disconnectedRetryCount=0),this.state.terminal))return;const g=this.states[t.state];let b=g.retryDelay;g.state==="disconnected"&&(this.disconnectedRetryCount++,b=rn(g.retryDelay,this.disconnectedRetryCount));const S=new xs(this.state.state,g.state,b,t.error||((s=(n=Rt)[g.state])==null?void 0:s.call(n)));if(u){const C=()=>{this.state===this.states.disconnected&&(this.lastAutoReconnectAttempt=Date.now(),this.requestState({state:"connecting"}))},E=this.lastAutoReconnectAttempt&&Date.now()-this.lastAutoReconnectAttempt+1;E&&E<1e3?(f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.notifyState()","Last reconnect attempt was only "+E+"ms ago, waiting another "+(1e3-E)+"ms before trying again"),setTimeout(C,1e3-E)):_.Config.nextTick(C)}else(i==="disconnected"||i==="suspended")&&this.startRetryTimer(b);(i==="disconnected"&&!u||i==="suspended"||g.terminal)&&_.Config.nextTick(()=>{this.disconnectAllTransports()}),i=="connected"&&!this.activeProtocol&&f.logAction(this.logger,f.LOG_ERROR,"ConnectionManager.notifyState()","Broken invariant: attempted to go into connected state, but there is no active protocol"),this.enactStateChange(S),this.state.sendEvents?this.sendQueuedMessages():this.state.queueEvents||(this.realtime.channels.propogateConnectionInterruption(i,S.reason),this.failQueuedMessages(S.reason))}requestState(t){var n,s;const i=t.state;if(f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+i+"; current state: "+this.state.state),i==this.state.state||(this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(i),i=="connecting"&&this.state.state=="connected")||i=="closing"&&this.state.state=="closed")return;const u=this.states[i],g=new xs(this.state.state,u.state,null,t.error||((s=(n=Rt)[u.state])==null?void 0:s.call(n)));this.enactStateChange(g),i=="connecting"&&_.Config.nextTick(()=>{this.startConnect()}),i=="closing"&&this.closeImpl()}startConnect(){if(this.state!==this.states.connecting){f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.startConnect()","Must be in connecting state to connect, but was "+this.state.state);return}const t=this.realtime.auth,n=++this.connectCounter,s=()=>{this.checkConnectionStateFreshness(),this.getTransportParams(i=>{if(i.mode==="recover"&&i.options.recover){const u=zr(i.options.recover);u&&this.realtime.channels.recoverChannels(u.channelSerials)}n===this.connectCounter&&this.connectImpl(i,n)})};if(f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.startConnect()","starting connection"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),t.method==="basic")s();else{const i=u=>{n===this.connectCounter&&(u?this.actOnErrorFromAuthorize(u):s())};this.errorReason&&Je.isTokenErr(this.errorReason)?Ee(t._forceNewToken(null,null),i):Ee(t._ensureValidAuthCredentials(!1),i)}}connectImpl(t,n){const s=this.state.state;if(s!==this.states.connecting.state){f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.connectImpl()","Must be in connecting state to connect, but was "+s);return}const i=this.getTransportPreference();i&&i===this.baseTransport&&this.webSocketTransportAvailable&&this.checkWsConnectivity().then(()=>{this.unpersistTransportPreference(),this.state===this.states.connecting&&(f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.connectImpl():","web socket connectivity available, cancelling connection attempt with "+this.baseTransport),this.disconnectAllTransports(),this.connectWs(t,++this.connectCounter))}).catch(Mi),i&&i===this.baseTransport||this.baseTransport&&!this.webSocketTransportAvailable?this.connectBase(t,n):this.connectWs(t,n)}connectWs(t,n){f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.connectWs()"),this.wsCheckResult=null,this.abandonedWebSocket=!1,this.startWebSocketSlowTimer(),this.startWebSocketGiveUpTimer(t),this.tryTransportWithFallbacks("web_socket",t,!0,n,()=>this.wsCheckResult!==!1&&!this.abandonedWebSocket)}connectBase(t,n){f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.connectBase()"),this.baseTransport?this.tryTransportWithFallbacks(this.baseTransport,t,!1,n,()=>!0):this.notifyState({state:"disconnected",error:new A("No transports left to try",8e4,404)})}tryTransportWithFallbacks(t,n,s,i,u){f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.tryTransportWithFallbacks()",t);const g=P=>{this.notifyState({state:this.states.connecting.failState,error:P})},b=s?this.wsHosts.slice():this.httpHosts.slice(),S=(P,j)=>{if(i===this.connectCounter){if(!u()){j&&j.dispose();return}!j&&!P&&E()}},C=b.shift();if(!C){g(new A("Unable to connect (no available host)",80003,404));return}n.host=C;const E=()=>{if(!b.length){g(new A("Unable to connect (and no more fallback hosts to try)",80003,404));return}if(!this.realtime.http.checkConnectivity){g(new Re("Internal error: Http.checkConnectivity not set",null,500));return}Ee(this.realtime.http.checkConnectivity(),(P,j)=>{if(i===this.connectCounter&&u()){if(P){g(P);return}if(!j){g(new A("Unable to connect (network unreachable)",80003,404));return}n.host=At(b),this.tryATransport(n,t,S)}})};if(this.forceFallbackHost&&b.length){this.forceFallbackHost=!1,E();return}this.tryATransport(n,t,S)}closeImpl(){f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection"),this.cancelSuspendTimer(),this.startTransitionTimer(this.states.closing),this.pendingTransport&&(f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.closeImpl()","Closing pending transport: "+this.pendingTransport),this.pendingTransport.close()),this.activeProtocol&&(f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.closeImpl()","Closing active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().close()),this.notifyState({state:"closed"})}onAuthUpdated(t,n){var s;switch(this.state.state){case"connected":{f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Sending AUTH message on active transport");const i=(s=this.activeProtocol)==null?void 0:s.getTransport();i&&i.onAuthUpdated&&i.onAuthUpdated(t);const u=xe({action:ee.AUTH,auth:{accessToken:t.token}});this.send(u);const g=()=>{this.off(b),n(null,t)},b=S=>{S.current==="failed"&&(this.off(g),this.off(b),n(S.reason||this.getStateError()))};this.once("connectiondetails",g),this.on("connectionstate",b);break}case"connecting":f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Aborting current connection attempts in order to start again with the new auth details"),this.disconnectAllTransports();default:{f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Connection state is "+this.state.state+"; waiting until either connected or failed");const i=u=>{switch(u.current){case"connected":this.off(i),n(null,t);break;case"failed":case"closed":case"suspended":this.off(i),n(u.reason||this.getStateError());break}};this.on("connectionstate",i),this.state.state==="connecting"?this.startConnect():this.requestState({state:"connecting"})}}}disconnectAllTransports(){f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","Disconnecting all transports"),this.connectCounter++,this.pendingTransport&&(f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting pending transport: "+this.pendingTransport),this.pendingTransport.disconnect()),delete this.pendingTransport,this.proposedTransport&&(f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting proposed transport: "+this.pendingTransport),this.proposedTransport.disconnect()),delete this.pendingTransport,this.activeProtocol&&(f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().disconnect())}send(t,n,s){s=s||Mi;const i=this.state;if(i.sendEvents){f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.send()","sending event"),this.sendImpl(new Is(t,s));return}if(!(n&&i.queueEvents)){const g="rejecting event, queueEvent was "+n+", state was "+i.state;f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.send()",g),s(this.errorReason||new A(g,9e4,400));return}this.logger.shouldLog(f.LOG_MICRO)&&f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.send()","queueing msg; "+_t(t,this.realtime._RealtimePresence)),this.queue(t,s)}sendImpl(t){const n=t.message;t.ackRequired&&!t.sendAttempted&&(n.msgSerial=this.msgSerial++);try{this.activeProtocol.send(t)}catch(s){f.logAction(this.logger,f.LOG_ERROR,"ConnectionManager.sendImpl()","Unexpected exception in transport.send(): "+s.stack)}}queue(t,n){f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.queue()","queueing event");const s=this.queuedMessages.last(),i=this.options.maxMessageSize;s&&!s.sendAttempted&&da(s.message,t,i)?(s.merged||(s.callback=pn.create(this.logger,[s.callback]),s.merged=!0),s.callback.push(n)):this.queuedMessages.push(new Is(t,n))}sendQueuedMessages(){f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.count()+" queued messages");let t;for(;t=this.queuedMessages.shift();)this.sendImpl(t)}queuePendingMessages(t){t&&t.length&&(f.logAction(this.logger,f.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+t.length+" pending messages"),this.queuedMessages.prepend(t))}failQueuedMessages(t){const n=this.queuedMessages.count();n>0&&(f.logAction(this.logger,f.LOG_ERROR,"ConnectionManager.failQueuedMessages()","failing "+n+" queued messages, err = "+oe(t)),this.queuedMessages.completeAllMessages(t))}onChannelMessage(t,n){this.pendingChannelMessagesState.queue.push({message:t,transport:n}),this.pendingChannelMessagesState.isProcessing||this.processNextPendingChannelMessage()}processNextPendingChannelMessage(){if(this.pendingChannelMessagesState.queue.length>0){this.pendingChannelMessagesState.isProcessing=!0;const t=this.pendingChannelMessagesState.queue.shift();this.processChannelMessage(t.message).catch(n=>{f.logAction(this.logger,f.LOG_ERROR,"ConnectionManager.processNextPendingChannelMessage() received error ",n)}).finally(()=>{this.pendingChannelMessagesState.isProcessing=!1,this.processNextPendingChannelMessage()})}}async processChannelMessage(t){await this.realtime.channels.processChannelMessage(t)}async ping(){var t;if(this.state.state!=="connected")throw new A("Unable to ping service; not connected",4e4,400);const n=(t=this.activeProtocol)==null?void 0:t.getTransport();if(!n)throw this.getStateError();f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.ping()","transport = "+n);const s=Date.now(),i=ae();return ss(new Promise(u=>{const g=b=>{b===i&&(n.off("heartbeat",g),u(Date.now()-s))};n.on("heartbeat",g),n.ping(i)}),this.options.timeouts.realtimeRequestTimeout,"Timeout waiting for heartbeat response")}abort(t){this.activeProtocol.getTransport().fail(t)}getTransportPreference(){var t,n;return this.transportPreference||Fr()&&((n=(t=_.WebStorage)==null?void 0:t.get)==null?void 0:n.call(t,Wr))}persistTransportPreference(t){var n,s;this.transportPreference=t.shortName,Fr()&&((s=(n=_.WebStorage)==null?void 0:n.set)==null||s.call(n,Wr,t.shortName))}unpersistTransportPreference(){var t,n;this.transportPreference=null,Fr()&&((n=(t=_.WebStorage)==null?void 0:t.remove)==null||n.call(t,Wr))}actOnErrorFromAuthorize(t){if(t.code===40171)this.notifyState({state:"failed",error:t});else if(t.code===40102)this.notifyState({state:"failed",error:t});else if(t.statusCode===Lt.Forbidden){const n="Client configured authentication provider returned 403; failing the connection";f.logAction(this.logger,f.LOG_ERROR,"ConnectionManager.actOnErrorFromAuthorize()",n),this.notifyState({state:"failed",error:new A(n,80019,403,t)})}else{const n="Client configured authentication provider request failed";f.logAction(this.logger,f.LOG_MINOR,"ConnectionManager.actOnErrorFromAuthorize",n),this.notifyState({state:this.state.failState,error:new A(n,80019,401,t)})}}onConnectionDetailsUpdate(t,n){if(!t)return;this.connectionDetails=t,t.maxMessageSize&&(this.options.maxMessageSize=t.maxMessageSize);const s=t.clientId;if(s){const u=this.realtime.auth._uncheckedSetClientId(s);if(u){f.logAction(this.logger,f.LOG_ERROR,"ConnectionManager.onConnectionDetailsUpdate()",u.message),n.fail(u);return}}const i=t.connectionStateTtl;i&&(this.connectionStateTtl=i),this.maxIdleInterval=t.maxIdleInterval,this.emit("connectiondetails",t)}checkWsConnectivity(){const t=this.options.wsConnectivityCheckUrl||$.wsConnectivityCheckUrl,n=new _.Config.WebSocket(t);return new Promise((s,i)=>{let u=!1;n.onopen=()=>{u||(u=!0,s(),n.close())},n.onclose=n.onerror=()=>{u||(u=!0,i())}})}sessionRecoveryName(){return this.options.recoveryKeyStorageName||"ably-connection-recovery"}getSessionRecoverData(){var t,n;return kn()&&((n=(t=_.WebStorage)==null?void 0:t.getSession)==null?void 0:n.call(t,this.sessionRecoveryName()))}setSessionRecoverData(t){var n,s;return kn()&&((s=(n=_.WebStorage)==null?void 0:n.setSession)==null?void 0:s.call(n,this.sessionRecoveryName(),t))}clearSessionRecoverData(){var t,n;return kn()&&((n=(t=_.WebStorage)==null?void 0:t.removeSession)==null?void 0:n.call(t,this.sessionRecoveryName()))}},xi=pa,ga=class extends _e{constructor(e,t){super(e.logger),this.whenState=n=>_e.prototype.whenState.call(this,n,this.state),this.ably=e,this.connectionManager=new xi(e,t),this.state=this.connectionManager.state.state,this.key=void 0,this.id=void 0,this.errorReason=null,this.connectionManager.on("connectionstate",n=>{const s=this.state=n.current;_.Config.nextTick(()=>{this.emit(s,n)})}),this.connectionManager.on("update",n=>{_.Config.nextTick(()=>{this.emit("update",n)})})}connect(){f.logAction(this.logger,f.LOG_MINOR,"Connection.connect()",""),this.connectionManager.requestState({state:"connecting"})}async ping(){return f.logAction(this.logger,f.LOG_MINOR,"Connection.ping()",""),this.connectionManager.ping()}close(){f.logAction(this.logger,f.LOG_MINOR,"Connection.close()","connectionKey = "+this.key),this.connectionManager.requestState({state:"closing"})}get recoveryKey(){return this.logger.deprecationWarning("The `Connection.recoveryKey` attribute has been replaced by the `Connection.createRecoveryKey()` method. Replace your usage of `recoveryKey` with the return value of `createRecoveryKey()`. `recoveryKey` will be removed in a future version."),this.createRecoveryKey()}createRecoveryKey(){return this.connectionManager.createRecoveryKey()}},ma=ga,ya=class{constructor(e,t,n,s,i){this.previous=e,this.current=t,t==="attached"&&(this.resumed=n,this.hasBacklog=s),i&&(this.reason=i)}},Vr=ya,Li=function(){};function ba(e){if(e&&"params"in e&&!at(e.params))return new A("options.params must be an object",4e4,400);if(e&&"modes"in e){if(!Array.isArray(e.modes))return new A("options.modes must be an array",4e4,400);for(let t=0;t<e.modes.length;t++){const n=e.modes[t];if(!n||typeof n!="string"||!gs.includes(String.prototype.toUpperCase.call(n)))return new A("Invalid channel mode: "+n,4e4,400)}}}var va=class Ri extends _e{constructor(t,n,s){var i,u;super(t.logger),this.retryCount=0,this.history=async function(g){f.logAction(this.logger,f.LOG_MICRO,"RealtimeChannel.history()","channel = "+this.name);const b=this.client.rest.channelMixin;if(g&&g.untilAttach){if(this.state!=="attached")throw new A("option untilAttach requires the channel to be attached",4e4,400);if(!this.properties.attachSerial)throw new A("untilAttach was specified and channel is attached, but attachSerial is not defined",4e4,400);delete g.untilAttach,g.from_serial=this.properties.attachSerial}return b.history(this,g)},this.whenState=g=>_e.prototype.whenState.call(this,g,this.state),f.logAction(this.logger,f.LOG_MINOR,"RealtimeChannel()","started; name = "+n),this.name=n,this.channelOptions=xt((i=t._Crypto)!=null?i:null,this.logger,s),this.client=t,this._presence=t._RealtimePresence?new t._RealtimePresence.RealtimePresence(this):null,this.connectionManager=t.connection.connectionManager,this.state="initialized",this.subscriptions=new _e(this.logger),this.syncChannelSerial=void 0,this.properties={attachSerial:void 0,channelSerial:void 0},this.setOptions(s),this.errorReason=null,this._mode=null,this._attachResume=!1,this._decodingContext={channelOptions:this.channelOptions,plugins:t.options.plugins||{},baseEncodedPreviousPayload:void 0},this._lastPayload={messageId:null,protocolMessageChannelSerial:null,decodeFailureRecoveryInProgress:null},this._allChannelChanges=new _e(this.logger),(u=t.options.plugins)!=null&&u.Push&&(this._push=new t.options.plugins.Push.PushChannel(this))}get presence(){return this._presence||be("RealtimePresence"),this._presence}get push(){return this._push||be("Push"),this._push}invalidStateError(){return new A("Channel operation failed as channel state is "+this.state,90001,400,this.errorReason||void 0)}static processListenerArgs(t){return t=Array.prototype.slice.call(t),typeof t[0]=="function"&&t.unshift(null),t}async setOptions(t){var n;const s=this.channelOptions,i=ba(t);if(i)throw i;if(this.channelOptions=xt((n=this.client._Crypto)!=null?n:null,this.logger,t),this._decodingContext&&(this._decodingContext.channelOptions=this.channelOptions),this._shouldReattachToSetOptions(t,s))return this.attachImpl(),new Promise((u,g)=>{this._allChannelChanges.once(["attached","update","detached","failed"],function(b){switch(this.event){case"update":case"attached":u();break;default:g(b.reason)}})})}_shouldReattachToSetOptions(t,n){if(!(this.state==="attached"||this.state==="attaching"))return!1;if(t!=null&&t.params){const s=Ni(t.params),i=Ni(n.params);if(Object.keys(s).length!==Object.keys(i).length||!ts(i,s))return!0}return!!(t!=null&&t.modes&&(!n.modes||!Ge(t.modes,n.modes)))}async publish(...t){let n,s=t.length;if(!this.connectionManager.activeState())throw this.connectionManager.getError();if(s==1)if(at(t[0]))n=[ze.fromValues(t[0])];else if(Array.isArray(t[0]))n=ze.fromValuesArray(t[0]);else throw new A("The single-argument form of publish() expects a message object or an array of message objects",40013,400);else n=[ze.fromValues({name:t[0],data:t[1]})];const i=this.client.options.maxMessageSize,u=await Rs(n,this.channelOptions),g=On(u);if(g>i)throw new A("Maximum size of messages that can be published at once exceeded ( was "+g+" bytes; limit is "+i+" bytes)",40009,400);return new Promise((b,S)=>{this._publish(u,C=>C?S(C):b())})}_publish(t,n){f.logAction(this.logger,f.LOG_MICRO,"RealtimeChannel.publish()","message count = "+t.length);const s=this.state;switch(s){case"failed":case"suspended":n(A.fromValues(this.invalidStateError()));break;default:{f.logAction(this.logger,f.LOG_MICRO,"RealtimeChannel.publish()","sending message; channel state is "+s);const i=new Es;i.action=ee.MESSAGE,i.channel=this.name,i.messages=t,this.sendMessage(i,n);break}}}onEvent(t){f.logAction(this.logger,f.LOG_MICRO,"RealtimeChannel.onEvent()","received message");const n=this.subscriptions;for(let s=0;s<t.length;s++){const i=t[s];n.emit(i.name,i)}}async attach(){return this.state==="attached"?null:new Promise((t,n)=>{this._attach(!1,null,(s,i)=>s?n(s):t(i))})}_attach(t,n,s){s||(s=u=>{u&&f.logAction(this.logger,f.LOG_ERROR,"RealtimeChannel._attach()","Channel attach failed: "+u.toString())});const i=this.connectionManager;if(!i.activeState()){s(i.getError());return}(this.state!=="attaching"||t)&&this.requestState("attaching",n),this.once(function(u){switch(this.event){case"attached":s==null||s(null,u);break;case"detached":case"suspended":case"failed":s==null||s(u.reason||i.getError()||new A("Unable to attach; reason unknown; state = "+this.event,9e4,500));break;case"detaching":s==null||s(new A("Attach request superseded by a subsequent detach request",9e4,409));break}})}attachImpl(){f.logAction(this.logger,f.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message");const t=xe({action:ee.ATTACH,channel:this.name,params:this.channelOptions.params,channelSerial:this.properties.channelSerial});this.channelOptions.modes&&t.encodeModesToFlags(es(this.channelOptions.modes)),this._attachResume&&t.setFlag("ATTACH_RESUME"),this._lastPayload.decodeFailureRecoveryInProgress&&(t.channelSerial=this._lastPayload.protocolMessageChannelSerial),this.sendMessage(t,Li)}async detach(){const t=this.connectionManager;if(!t.activeState())throw t.getError();switch(this.state){case"suspended":this.notifyState("detached");return;case"detached":return;case"failed":throw new A("Unable to detach; channel state = failed",90001,400);default:this.requestState("detaching");case"detaching":return new Promise((n,s)=>{this.once(function(i){switch(this.event){case"detached":n();break;case"attached":case"suspended":case"failed":s(i.reason||t.getError()||new A("Unable to detach; reason unknown; state = "+this.event,9e4,500));break;case"attaching":s(new A("Detach request superseded by a subsequent attach request",9e4,409));break}})})}}detachImpl(t){f.logAction(this.logger,f.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message");const n=xe({action:ee.DETACH,channel:this.name});this.sendMessage(n,t||Li)}async subscribe(...t){const[n,s]=Ri.processListenerArgs(t);if(this.state==="failed")throw A.fromValues(this.invalidStateError());return n&&typeof n=="object"&&!Array.isArray(n)?this.client._FilteredSubscriptions.subscribeFilter(this,n,s):this.subscriptions.on(n,s),this.channelOptions.attachOnSubscribe!==!1?this.attach():null}unsubscribe(...t){var n;const[s,i]=Ri.processListenerArgs(t);if(typeof s=="object"&&!i||(n=this.filteredSubscriptions)!=null&&n.has(i)){this.client._FilteredSubscriptions.getAndDeleteFilteredSubscriptions(this,s,i).forEach(u=>this.subscriptions.off(u));return}this.subscriptions.off(s,i)}sync(){switch(this.state){case"initialized":case"detaching":case"detached":throw new Re("Unable to sync to channel; not attached",4e4)}const t=this.connectionManager;if(!t.activeState())throw t.getError();const n=xe({action:ee.SYNC,channel:this.name});this.syncChannelSerial&&(n.channelSerial=this.syncChannelSerial),t.send(n)}sendMessage(t,n){this.connectionManager.send(t,this.client.options.queueMessages,n)}sendPresence(t,n){const s=xe({action:ee.PRESENCE,channel:this.name,presence:t});this.sendMessage(s,n)}async processMessage(t){(t.action===ee.ATTACHED||t.action===ee.MESSAGE||t.action===ee.PRESENCE)&&this.setChannelSerial(t.channelSerial);let n,s=!1;switch(t.action){case ee.ATTACHED:{this.properties.attachSerial=t.channelSerial,this._mode=t.getMode(),this.params=t.params||{};const i=t.decodeModesFromFlags();this.modes=i&&sn(i)||void 0;const u=t.hasFlag("RESUMED"),g=t.hasFlag("HAS_PRESENCE"),b=t.hasFlag("HAS_BACKLOG");if(this.state==="attached"){u||this._presence&&this._presence.onAttached(g);const S=new Vr(this.state,this.state,u,b,t.error);this._allChannelChanges.emit("update",S),(!u||this.channelOptions.updateOnAttached)&&this.emit("update",S)}else this.state==="detaching"?this.checkPendingState():this.notifyState("attached",t.error,u,g,b);break}case ee.DETACHED:{const i=t.error?A.fromValues(t.error):new A("Channel detached",90001,404);this.state==="detaching"?this.notifyState("detached",i):this.state==="attaching"?this.notifyState("suspended",i):(this.state==="attached"||this.state==="suspended")&&this.requestState("attaching",i);break}case ee.SYNC:if(s=!0,n=this.syncChannelSerial=t.channelSerial,!t.presence)break;case ee.PRESENCE:{if(!t.presence)break;bs(t);const i=this.channelOptions;if(this._presence){const u=await Promise.all(t.presence.map(g=>g.decode(i,this.logger)));this._presence.setPresence(u,s,n)}break}case ee.MESSAGE:{if(this.state!=="attached"){f.logAction(this.logger,f.LOG_MAJOR,"RealtimeChannel.processMessage()",'Message "'+t.id+'" skipped as this channel "'+this.name+'" state is not "attached" (state is "'+this.state+'").');return}bs(t);const i=t.messages,u=i[0],g=i[i.length-1];if(u.extras&&u.extras.delta&&u.extras.delta.from!==this._lastPayload.messageId){const S='Delta message decode failure - previous message not available for message "'+t.id+'" on this channel "'+this.name+'".';f.logAction(this.logger,f.LOG_ERROR,"RealtimeChannel.processMessage()",S),this._startDecodeFailureRecovery(new A(S,40018,400));break}let b=[];for(let S=0;S<i.length;S++){const{decoded:C,err:E}=await i[S].decodeWithErr(this._decodingContext,this.logger);if(b[S]=C,E)switch(E.code){case 40018:this._startDecodeFailureRecovery(E);return;case 40019:case 40021:this.notifyState("failed",E);return}}this._lastPayload.messageId=g.id,this._lastPayload.protocolMessageChannelSerial=t.channelSerial,this.onEvent(b);break}case ee.ERROR:{const i=t.error;i&&i.code==80016?this.checkPendingState():this.notifyState("failed",A.fromValues(i));break}default:f.logAction(this.logger,f.LOG_MAJOR,"RealtimeChannel.processMessage()","Protocol error: unrecognised message action ("+t.action+")")}}_startDecodeFailureRecovery(t){this._lastPayload.decodeFailureRecoveryInProgress||(f.logAction(this.logger,f.LOG_MAJOR,"RealtimeChannel.processMessage()","Starting decode failure recovery process."),this._lastPayload.decodeFailureRecoveryInProgress=!0,this._attach(!0,t,()=>{this._lastPayload.decodeFailureRecoveryInProgress=!1}))}onAttached(){f.logAction(this.logger,f.LOG_MINOR,"RealtimeChannel.onAttached","activating channel; name = "+this.name)}notifyState(t,n,s,i,u){if(f.logAction(this.logger,f.LOG_MICRO,"RealtimeChannel.notifyState","name = "+this.name+", current state = "+this.state+", notifying state "+t),this.clearStateTimer(),["detached","suspended","failed"].includes(t)&&(this.properties.channelSerial=null),t===this.state)return;this._presence&&this._presence.actOnChannelState(t,i,n),t==="suspended"&&this.connectionManager.state.sendEvents?this.startRetryTimer():this.cancelRetryTimer(),n&&(this.errorReason=n);const g=new Vr(this.state,t,s,u,n),b='Channel state for channel "'+this.name+'"',S=t+(n?"; reason: "+n:"");t==="failed"?f.logAction(this.logger,f.LOG_ERROR,b,S):f.logAction(this.logger,f.LOG_MAJOR,b,S),t!=="attaching"&&t!=="suspended"&&(this.retryCount=0),t==="attached"&&this.onAttached(),t==="attached"?this._attachResume=!0:(t==="detaching"||t==="failed")&&(this._attachResume=!1),this.state=t,this._allChannelChanges.emit(t,g),this.emit(t,g)}requestState(t,n){f.logAction(this.logger,f.LOG_MINOR,"RealtimeChannel.requestState","name = "+this.name+", state = "+t),this.notifyState(t,n),this.checkPendingState()}checkPendingState(){if(!this.connectionManager.state.sendEvents){f.logAction(this.logger,f.LOG_MINOR,"RealtimeChannel.checkPendingState","sendEvents is false; state is "+this.connectionManager.state.state);return}switch(f.logAction(this.logger,f.LOG_MINOR,"RealtimeChannel.checkPendingState","name = "+this.name+", state = "+this.state),this.state){case"attaching":this.startStateTimerIfNotRunning(),this.attachImpl();break;case"detaching":this.startStateTimerIfNotRunning(),this.detachImpl();break;case"attached":this.sync();break}}timeoutPendingState(){switch(this.state){case"attaching":{const t=new A("Channel attach timed out",90007,408);this.notifyState("suspended",t);break}case"detaching":{const t=new A("Channel detach timed out",90007,408);this.notifyState("attached",t);break}default:this.checkPendingState();break}}startStateTimerIfNotRunning(){this.stateTimer||(this.stateTimer=setTimeout(()=>{f.logAction(this.logger,f.LOG_MINOR,"RealtimeChannel.startStateTimerIfNotRunning","timer expired"),this.stateTimer=null,this.timeoutPendingState()},this.client.options.timeouts.realtimeRequestTimeout))}clearStateTimer(){const t=this.stateTimer;t&&(clearTimeout(t),this.stateTimer=null)}startRetryTimer(){if(this.retryTimer)return;this.retryCount++;const t=rn(this.client.options.timeouts.channelRetryTimeout,this.retryCount);this.retryTimer=setTimeout(()=>{this.state==="suspended"&&this.connectionManager.state.sendEvents&&(this.retryTimer=null,f.logAction(this.logger,f.LOG_MINOR,"RealtimeChannel retry timer expired","attempting a new attach"),this.requestState("attaching"))},t)}cancelRetryTimer(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)}getReleaseErr(){const t=this.state;return t==="initialized"||t==="detached"||t==="failed"?null:new A("Can only release a channel in a state where there is no possibility of further updates from the server being received (initialized, detached, or failed); was "+t,90001,400)}setChannelSerial(t){f.logAction(this.logger,f.LOG_MICRO,"RealtimeChannel.setChannelSerial()","Updating channel serial; serial = "+t+"; previous = "+this.properties.channelSerial),t&&(this.properties.channelSerial=t)}async status(){return this.client.rest.channelMixin.status(this)}};function Ni(e){const t=e||{},{agent:n}=t;return U(t,["agent"])}var Jr=va,Ui=class ta extends us{constructor(t){var n,s;if(super($.objectifyOptions(t,!1,"BaseRealtime",f.defaultLogger)),f.logAction(this.logger,f.LOG_MINOR,"Realtime()",""),typeof EdgeRuntime=="string")throw new A(`Ably.Realtime instance cannot be used in Vercel Edge runtime. If you are running Vercel Edge functions, please replace your "new Ably.Realtime()" with "new Ably.Rest()" and use Ably Rest API instead of the Realtime API. If you are server-rendering your application in the Vercel Edge runtime, please use the condition "if (typeof EdgeRuntime === 'string')" to prevent instantiating Ably.Realtime instance during SSR in the Vercel Edge runtime.`,4e4,400);this._additionalTransportImplementations=ta.transportImplementationsFromPlugins(this.options.plugins),this._RealtimePresence=(s=(n=this.options.plugins)==null?void 0:n.RealtimePresence)!=null?s:null,this.connection=new ma(this,this.options),this._channels=new Ca(this),this.options.autoConnect!==!1&&this.connect()}static transportImplementationsFromPlugins(t){const n={};return t!=null&&t.WebSocketTransport&&(n[Le.WebSocket]=t.WebSocketTransport),t!=null&&t.XHRPolling&&(n[Le.XhrPolling]=t.XHRPolling),n}get channels(){return this._channels}connect(){f.logAction(this.logger,f.LOG_MINOR,"Realtime.connect()",""),this.connection.connect()}close(){f.logAction(this.logger,f.LOG_MINOR,"Realtime.close()",""),this.connection.close()}};Ui.EventEmitter=_e;var wa=Ui,Ca=class extends _e{constructor(e){super(e.logger),this.realtime=e,this.all=Object.create(null),e.connection.connectionManager.on("transport.active",()=>{this.onTransportActive()})}channelSerials(){let e={};for(const t of ct(this.all,!0)){const n=this.all[t];n.properties.channelSerial&&(e[t]=n.properties.channelSerial)}return e}recoverChannels(e){for(const t of ct(e,!0)){const n=this.get(t);n.properties.channelSerial=e[t]}}async processChannelMessage(e){const t=e.channel;if(t===void 0){f.logAction(this.logger,f.LOG_ERROR,"Channels.processChannelMessage()","received event unspecified channel, action = "+e.action);return}const n=this.all[t];if(!n){f.logAction(this.logger,f.LOG_ERROR,"Channels.processChannelMessage()","received event for non-existent channel: "+t);return}await n.processMessage(e)}onTransportActive(){for(const e in this.all){const t=this.all[e];t.state==="attaching"||t.state==="detaching"?t.checkPendingState():t.state==="suspended"?t._attach(!1,null):t.state==="attached"&&t.requestState("attaching")}}propogateConnectionInterruption(e,t){const n={closing:"detached",closed:"detached",failed:"failed",suspended:"suspended"},s=["attaching","attached","detaching","suspended"],i=n[e];for(const u in this.all){const g=this.all[u];s.includes(g.state)&&g.notifyState(i,t)}}get(e,t){e=String(e);let n=this.all[e];if(!n)n=this.all[e]=new Jr(this.realtime,e,t);else if(t){if(n._shouldReattachToSetOptions(t,n.channelOptions))throw new A("Channels.get() cannot be used to set channel options that would cause the channel to reattach. Please, use RealtimeChannel.setOptions() instead.",4e4,400);n.setOptions(t)}return n}getDerived(e,t,n){if(t.filter){const s=lt(t.filter),i=ns(e);e=`[filter=${s}${i.qualifierParam}]${i.channelName}`}return this.get(e,n)}release(e){e=String(e);const t=this.all[e];if(!t)return;const n=t.getReleaseErr();if(n)throw n;delete this.all[e]}},Sa=wa;function _a(e,t){if(e.isSynthesized()||t.isSynthesized())return e.timestamp>=t.timestamp;const n=e.parseId(),s=t.parseId();return n.msgSerial===s.msgSerial?n.index>s.index:n.msgSerial>s.msgSerial}var $r=class extends _e{constructor(e,t,n=_a){super(e.logger),this.presence=e,this.map=Object.create(null),this.syncInProgress=!1,this.residualMembers=null,this.memberKey=t,this.newerThan=n}get(e){return this.map[e]}getClient(e){const t=this.map,n=[];for(const s in t){const i=t[s];i.clientId==e&&i.action!="absent"&&n.push(i)}return n}list(e){const t=this.map,n=e&&e.clientId,s=e&&e.connectionId,i=[];for(const u in t){const g=t[u];g.action!=="absent"&&(n&&n!=g.clientId||s&&s!=g.connectionId||i.push(g))}return i}put(e){(e.action==="enter"||e.action==="update")&&(e=Ye.fromValues(e),e.action="present");const t=this.map,n=this.memberKey(e);this.residualMembers&&delete this.residualMembers[n];const s=t[n];return s&&!this.newerThan(e,s)?!1:(t[n]=e,!0)}values(){const e=this.map,t=[];for(const n in e){const s=e[n];s.action!="absent"&&t.push(s)}return t}remove(e){const t=this.map,n=this.memberKey(e),s=t[n];return s&&!this.newerThan(e,s)?!1:(this.syncInProgress?(e=Ye.fromValues(e),e.action="absent",t[n]=e):delete t[n],!!s)}startSync(){const e=this.map,t=this.syncInProgress;f.logAction(this.logger,f.LOG_MINOR,"PresenceMap.startSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+t),this.syncInProgress||(this.residualMembers=ot(e),this.setInProgress(!0))}endSync(){const e=this.map,t=this.syncInProgress;if(f.logAction(this.logger,f.LOG_MINOR,"PresenceMap.endSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+t),t){for(const n in e)e[n].action==="absent"&&delete e[n];this.presence._synthesizeLeaves(Kn(this.residualMembers));for(const n in this.residualMembers)delete e[n];this.residualMembers=null,this.setInProgress(!1)}this.emit("sync")}waitSync(e){const t=this.syncInProgress;if(f.logAction(this.logger,f.LOG_MINOR,"PresenceMap.waitSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+t),!t){e();return}this.once("sync",e)}clear(){this.map={},this.setInProgress(!1),this.residualMembers=null}setInProgress(e){f.logAction(this.logger,f.LOG_MICRO,"PresenceMap.setInProgress()","inProgress = "+e),this.syncInProgress=e,this.presence.syncComplete=!e}};function Ra(e){return e.channel.client.auth.clientId}function Kr(e){const t=e.channel.client,n=t.auth.clientId;return(!n||n==="*")&&t.connection.state==="connected"}function Oa(e,t,n){switch(e.state){case"attached":case"suspended":n();break;case"initialized":case"detached":case"detaching":case"attaching":Ee(e.attach(),function(s){s?t(s):n()});break;default:t(A.fromValues(e.invalidStateError()))}}var ka=class extends _e{constructor(e){super(e.logger),this.channel=e,this.syncComplete=!1,this.members=new $r(this,t=>t.clientId+":"+t.connectionId),this._myMembers=new $r(this,t=>t.clientId),this.subscriptions=new _e(this.logger),this.pendingPresence=[]}async enter(e){if(Kr(this))throw new A("clientId must be specified to enter a presence channel",40012,400);return this._enterOrUpdateClient(void 0,void 0,e,"enter")}async update(e){if(Kr(this))throw new A("clientId must be specified to update presence data",40012,400);return this._enterOrUpdateClient(void 0,void 0,e,"update")}async enterClient(e,t){return this._enterOrUpdateClient(void 0,e,t,"enter")}async updateClient(e,t){return this._enterOrUpdateClient(void 0,e,t,"update")}async _enterOrUpdateClient(e,t,n,s){const i=this.channel;if(!i.connectionManager.activeState())throw i.connectionManager.getError();f.logAction(this.logger,f.LOG_MICRO,"RealtimePresence."+s+"Client()","channel = "+i.name+", id = "+e+", client = "+(t||"(implicit) "+Ra(this)));const u=Ye.fromData(n);u.action=s,e&&(u.id=e),t&&(u.clientId=t);const g=await u.encode(i.channelOptions);switch(i.state){case"attached":return new Promise((b,S)=>{i.sendPresence([g],C=>C?S(C):b())});case"initialized":case"detached":i.attach();case"attaching":return new Promise((b,S)=>{this.pendingPresence.push({presence:g,callback:C=>C?S(C):b()})});default:{const b=new Re("Unable to "+s+" presence channel while in "+i.state+" state",90001);throw b.code=90001,b}}}async leave(e){if(Kr(this))throw new A("clientId must have been specified to enter or leave a presence channel",40012,400);return this.leaveClient(void 0,e)}async leaveClient(e,t){const n=this.channel;if(!n.connectionManager.activeState())throw n.connectionManager.getError();f.logAction(this.logger,f.LOG_MICRO,"RealtimePresence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+e);const s=Ye.fromData(t);s.action="leave",e&&(s.clientId=e);const i=await s.encode(n.channelOptions);return new Promise((u,g)=>{switch(n.state){case"attached":n.sendPresence([i],b=>b?g(b):u());break;case"attaching":this.pendingPresence.push({presence:i,callback:b=>b?g(b):u()});break;case"initialized":case"failed":{const b=new Re("Unable to leave presence channel (incompatible state)",90001);g(b);break}default:g(n.invalidStateError())}})}async get(e){const t=!e||("waitForSync"in e?e.waitForSync:!0);return new Promise((n,s)=>{function i(u){n(e?u.list(e):u.values())}if(this.channel.state==="suspended"){t?s(A.fromValues({statusCode:400,code:91005,message:"Presence state is out of sync due to channel being in the SUSPENDED state"})):i(this.members);return}Oa(this.channel,u=>s(u),()=>{const u=this.members;t?u.waitSync(function(){i(u)}):i(u)})})}async history(e){f.logAction(this.logger,f.LOG_MICRO,"RealtimePresence.history()","channel = "+this.name);const t=this.channel.client.rest.presenceMixin;if(e&&e.untilAttach)if(this.channel.state==="attached")delete e.untilAttach,e.from_serial=this.channel.properties.attachSerial;else throw new A("option untilAttach requires the channel to be attached, was: "+this.channel.state,4e4,400);return t.history(this,e)}setPresence(e,t,n){f.logAction(this.logger,f.LOG_MICRO,"RealtimePresence.setPresence()","received presence for "+e.length+" participants; syncChannelSerial = "+n);let s,i;const u=this.members,g=this._myMembers,b=[],S=this.channel.connectionManager.connectionId;t&&(this.members.startSync(),n&&(i=n.match(/^[\w-]+:(.*)$/))&&(s=i[1]));for(let C of e)switch(C.action){case"leave":u.remove(C)&&b.push(C),C.connectionId===S&&!C.isSynthesized()&&g.remove(C);break;case"enter":case"present":case"update":u.put(C)&&b.push(C),C.connectionId===S&&g.put(C);break}t&&!s&&(u.endSync(),this.channel.syncChannelSerial=null);for(let C=0;C<b.length;C++){const E=b[C];this.subscriptions.emit(E.action,E)}}onAttached(e){f.logAction(this.logger,f.LOG_MINOR,"RealtimePresence.onAttached()","channel = "+this.channel.name+", hasPresence = "+e),e?this.members.startSync():(this._synthesizeLeaves(this.members.values()),this.members.clear()),this._ensureMyMembersPresent();const t=this.pendingPresence,n=t.length;if(n){this.pendingPresence=[];const s=[],i=pn.create(this.logger);f.logAction(this.logger,f.LOG_MICRO,"RealtimePresence.onAttached","sending "+n+" queued presence messages");for(let u=0;u<n;u++){const g=t[u];s.push(g.presence),i.push(g.callback)}this.channel.sendPresence(s,i)}}actOnChannelState(e,t,n){switch(e){case"attached":this.onAttached(t);break;case"detached":case"failed":this._clearMyMembers(),this.members.clear();case"suspended":this.failPendingPresence(n);break}}failPendingPresence(e){if(this.pendingPresence.length){f.logAction(this.logger,f.LOG_MINOR,"RealtimeChannel.failPendingPresence","channel; name = "+this.channel.name+", err = "+oe(e));for(let t=0;t<this.pendingPresence.length;t++)try{this.pendingPresence[t].callback(e)}catch{}this.pendingPresence=[]}}_clearMyMembers(){this._myMembers.clear()}_ensureMyMembersPresent(){const e=this._myMembers,t=this.channel.connectionManager.connectionId;for(const n in e.map){const s=e.map[n];f.logAction(this.logger,f.LOG_MICRO,"RealtimePresence._ensureMyMembersPresent()",'Auto-reentering clientId "'+s.clientId+'" into the presence set');const i=s.connectionId===t?s.id:void 0;this._enterOrUpdateClient(i,s.clientId,s.data,"enter").catch(u=>{const g=new A("Presence auto re-enter failed",91004,400,u);f.logAction(this.logger,f.LOG_ERROR,"RealtimePresence._ensureMyMembersPresent()","Presence auto re-enter failed; reason = "+oe(u));const b=new Vr(this.channel.state,this.channel.state,!0,!1,g);this.channel.emit("update",b)})}}_synthesizeLeaves(e){const t=this.subscriptions;e.forEach(function(n){const s=Ye.fromValues({action:"leave",connectionId:n.connectionId,clientId:n.clientId,data:n.data,encoding:n.encoding,timestamp:Date.now()});t.emit("leave",s)})}async subscribe(...e){const t=Jr.processListenerArgs(e),n=t[0],s=t[1],i=this.channel;if(i.state==="failed")throw A.fromValues(i.invalidStateError());this.subscriptions.on(n,s),i.channelOptions.attachOnSubscribe!==!1&&await i.attach()}unsubscribe(...e){const t=Jr.processListenerArgs(e),n=t[0],s=t[1];this.subscriptions.off(n,s)}},Ta=ka,Aa=Le.WebSocket;function Ea(e){return!!e.on}var Pa=class extends Wt{constructor(e,t,n){super(e,t,n),this.shortName=Aa,n.heartbeats=_.Config.useProtocolHeartbeats,this.wsHost=n.host}static isAvailable(){return!!_.Config.WebSocket}createWebSocket(e,t){return this.uri=e+yt(t),new _.Config.WebSocket(this.uri)}toString(){return"WebSocketTransport; uri="+this.uri}connect(){f.logAction(this.logger,f.LOG_MINOR,"WebSocketTransport.connect()","starting"),Wt.prototype.connect.call(this);const e=this,t=this.params,n=t.options,i=(n.tls?"wss://":"ws://")+this.wsHost+":"+$.getPort(n)+"/";f.logAction(this.logger,f.LOG_MINOR,"WebSocketTransport.connect()","uri: "+i),Ee(this.auth.getAuthParams(),function(u,g){if(e.isDisposed)return;let b="";for(const C in g)b+=" "+C+": "+g[C]+";";if(f.logAction(e.logger,f.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+b+" err: "+u),u){e.disconnect(u);return}const S=t.getConnectParams(g);try{const C=e.wsConnection=e.createWebSocket(i,S);C.binaryType=_.Config.binaryType,C.onopen=function(){e.onWsOpen()},C.onclose=function(E){e.onWsClose(E)},C.onmessage=function(E){e.onWsData(E.data)},C.onerror=function(E){e.onWsError(E)},Ea(C)&&C.on("ping",function(){e.onActivity()})}catch(C){f.logAction(e.logger,f.LOG_ERROR,"WebSocketTransport.connect()","Unexpected exception creating websocket: err = "+(C.stack||C.message)),e.disconnect(C)}})}send(e){const t=this.wsConnection;if(!t){f.logAction(this.logger,f.LOG_ERROR,"WebSocketTransport.send()","No socket connection");return}try{t.send(Hr(e,this.connectionManager.realtime._MsgPack,this.params.format))}catch(n){const s="Exception from ws connection when trying to send: "+oe(n);f.logAction(this.logger,f.LOG_ERROR,"WebSocketTransport.send()",s),this.finish("disconnected",new A(s,5e4,500))}}onWsData(e){f.logAction(this.logger,f.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+e.length+"; type = "+typeof e);try{this.onProtocolMessage(Ts(e,this.connectionManager.realtime._MsgPack,this.connectionManager.realtime._RealtimePresence,this.format))}catch(t){f.logAction(this.logger,f.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+t.stack)}}onWsOpen(){f.logAction(this.logger,f.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket"),this.emit("preconnect")}onWsClose(e){let t,n;if(typeof e=="object"?(n=e.code,t=e.wasClean||n===1e3):(n=e,t=n==1e3),delete this.wsConnection,t){f.logAction(this.logger,f.LOG_MINOR,"WebSocketTransport.onWsClose()","Cleanly closed WebSocket");const s=new A("Websocket closed",80003,400);this.finish("disconnected",s)}else{const s="Unclean disconnection of WebSocket ; code = "+n,i=new A(s,80003,400);f.logAction(this.logger,f.LOG_MINOR,"WebSocketTransport.onWsClose()",s),this.finish("disconnected",i)}this.emit("disposed")}onWsError(e){f.logAction(this.logger,f.LOG_MINOR,"WebSocketTransport.onError()","Error from WebSocket: "+e.message),_.Config.nextTick(()=>{this.disconnect(Error(e.message))})}dispose(){f.logAction(this.logger,f.LOG_MINOR,"WebSocketTransport.dispose()",""),this.isDisposed=!0;const e=this.wsConnection;e&&(e.onmessage=function(){},delete this.wsConnection,_.Config.nextTick(()=>{if(f.logAction(this.logger,f.LOG_MICRO,"WebSocketTransport.dispose()","closing websocket"),!e)throw new Error("WebSocketTransport.dispose(): wsConnection is not defined");e.close()}))}},qi=Pa,Ia=class{static subscribeFilter(e,t,n){const s=i=>{var u,g,b,S,C,E;const P={name:i.name,refTimeserial:(g=(u=i.extras)==null?void 0:u.ref)==null?void 0:g.timeserial,refType:(S=(b=i.extras)==null?void 0:b.ref)==null?void 0:S.type,isRef:!!((E=(C=i.extras)==null?void 0:C.ref)!=null&&E.timeserial),clientId:i.clientId};Object.entries(t).find(([j,M])=>M!==void 0?P[j]!==M:!1)||n(i)};this.addFilteredSubscription(e,t,n,s),e.subscriptions.on(s)}static addFilteredSubscription(e,t,n,s){var i;if(e.filteredSubscriptions||(e.filteredSubscriptions=new Map),e.filteredSubscriptions.has(n)){const u=e.filteredSubscriptions.get(n);u.set(t,((i=u==null?void 0:u.get(t))==null?void 0:i.concat(s))||[s])}else e.filteredSubscriptions.set(n,new Map([[t,[s]]]))}static getAndDeleteFilteredSubscriptions(e,t,n){if(!e.filteredSubscriptions)return[];if(!n&&t)return Array.from(e.filteredSubscriptions.entries()).map(([u,g])=>{var b;let S=g.get(t);return g.delete(t),g.size===0&&((b=e.filteredSubscriptions)==null||b.delete(u)),S}).reduce((u,g)=>g?u.concat(...g):u,[]);if(!n||!e.filteredSubscriptions.has(n))return[];const s=e.filteredSubscriptions.get(n);if(!t){const u=Array.from(s.values()).reduce((g,b)=>g.concat(...b),[]);return e.filteredSubscriptions.delete(n),u}let i=s.get(t);return s.delete(t),i||[]}},Ze=class Oi extends Sa{constructor(t){var n;const s=Oi._MsgPack;if(!s)throw new Error("Expected DefaultRealtime._MsgPack to have been set");super($.objectifyOptions(t,!0,"Realtime",f.defaultLogger,L(H({},re),{Crypto:(n=Oi.Crypto)!=null?n:void 0,MsgPack:s,RealtimePresence:{RealtimePresence:Ta,PresenceMessage:Ye,WirePresenceMessage:Ct},WebSocketTransport:qi,MessageInteractions:Ia})))}static get Crypto(){if(this._Crypto===null)throw new Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto(t){this._Crypto=t}};Ze.Utils=nt,Ze.ConnectionManager=xi,Ze.ProtocolMessage=Es,Ze._Crypto=null,Ze.Message=pe,Ze.PresenceMessage=St,Ze._MsgPack=null,Ze._Http=Cn,Ze._PresenceMap=$r;var Xr=Ze,Qr=Uint8Array,Tn=Uint32Array,Yr=Math.pow,Di=new Tn(8),Bi=[],An=new Tn(64);function ji(e){return(e-(e|0))*Yr(2,32)|0}for(var En=2,Pn=0;Pn<64;){for(Zr=!0,Ls=2;Ls<=En/2;Ls++)En%Ls===0&&(Zr=!1);Zr&&(Pn<8&&(Di[Pn]=ji(Yr(En,1/2))),Bi[Pn]=ji(Yr(En,1/3)),Pn++),En++}var Zr,Ls,Ma=!!new Qr(new Tn([1]).buffer)[0];function ei(e){return Ma?e>>>24|(e>>>16&255)<<8|(e&65280)<<8|e<<24:e}function et(e,t){return e>>>t|e<<32-t}function ti(e){var t=Di.slice(),n=e.length,s=n*8,i=512-(s+64)%512-1+s+65,u=new Qr(i/8),g=new Tn(u.buffer);u.set(e,0),u[n]=128,g[g.length-1]=ei(s);for(var b,S=0;S<i/32;S+=16){var C=t.slice();for(b=0;b<64;b++){var E;if(b<16)E=ei(g[S+b]);else{var P=An[b-15],j=An[b-2];E=An[b-7]+An[b-16]+(et(P,7)^et(P,18)^P>>>3)+(et(j,17)^et(j,19)^j>>>10)}An[b]=E|=0;for(var M=(et(C[4],6)^et(C[4],11)^et(C[4],25))+(C[4]&C[5]^~C[4]&C[6])+C[7]+E+Bi[b],V=(et(C[0],2)^et(C[0],13)^et(C[0],22))+(C[0]&C[1]^C[2]&(C[0]^C[1])),G=7;G>0;G--)C[G]=C[G-1];C[0]=M+V|0,C[4]=C[4]+M|0}for(b=0;b<8;b++)t[b]=t[b]+C[b]|0}return new Qr(new Tn(t.map(function(J){return ei(J)})).buffer)}function xa(e,t){if(e.length>64&&(e=ti(e)),e.length<64){const b=new Uint8Array(64);b.set(e,0),e=b}for(var n=new Uint8Array(64),s=new Uint8Array(64),i=0;i<64;i++)n[i]=54^e[i],s[i]=92^e[i];var u=new Uint8Array(t.length+64);u.set(n,0),u.set(t,64);var g=new Uint8Array(96);return g.set(s,0),g.set(ti(u),64),ti(g)}var La=class{constructor(){this.base64CharSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",this.hexCharSet="0123456789abcdef"}uint8ViewToBase64(e){let t="";const n=this.base64CharSet,s=e.byteLength,i=s%3,u=s-i;let g,b,S,C,E;for(let P=0;P<u;P=P+3)E=e[P]<<16|e[P+1]<<8|e[P+2],g=(E&16515072)>>18,b=(E&258048)>>12,S=(E&4032)>>6,C=E&63,t+=n[g]+n[b]+n[S]+n[C];return i==1?(E=e[u],g=(E&252)>>2,b=(E&3)<<4,t+=n[g]+n[b]+"=="):i==2&&(E=e[u]<<8|e[u+1],g=(E&64512)>>10,b=(E&1008)>>4,S=(E&15)<<2,t+=n[g]+n[b]+n[S]+"="),t}base64ToArrayBuffer(e){const t=atob==null?void 0:atob(e),n=t.length,s=new Uint8Array(n);for(let i=0;i<n;i++){const u=t.charCodeAt(i);s[i]=u}return this.toArrayBuffer(s)}isBuffer(e){return e instanceof ArrayBuffer||ArrayBuffer.isView(e)}toBuffer(e){if(!ArrayBuffer)throw new Error("Can't convert to Buffer: browser does not support the necessary types");if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(this.toArrayBuffer(e));throw new Error("BufferUtils.toBuffer expected an ArrayBuffer or a view onto one")}toArrayBuffer(e){if(!ArrayBuffer)throw new Error("Can't convert to ArrayBuffer: browser does not support the necessary types");if(e instanceof ArrayBuffer)return e;if(ArrayBuffer.isView(e))return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);throw new Error("BufferUtils.toArrayBuffer expected an ArrayBuffer or a view onto one")}base64Encode(e){return this.uint8ViewToBase64(this.toBuffer(e))}base64Decode(e){if(ArrayBuffer&&_.Config.atob)return this.base64ToArrayBuffer(e);throw new Error("Expected ArrayBuffer to exist and Platform.Config.atob to be configured")}hexEncode(e){return this.toBuffer(e).reduce((n,s)=>n+s.toString(16).padStart(2,"0"),"")}hexDecode(e){if(e.length%2!==0)throw new Error("Can't create a byte array from a hex string of odd length");const t=new Uint8Array(e.length/2);for(let n=0;n<t.length;n++)t[n]=parseInt(e.slice(2*n,2*(n+1)),16);return this.toArrayBuffer(t)}utf8Encode(e){if(_.Config.TextEncoder){const t=new _.Config.TextEncoder().encode(e);return this.toArrayBuffer(t)}else throw new Error("Expected TextEncoder to be configured")}utf8Decode(e){if(!this.isBuffer(e))throw new Error("Expected input of utf8decode to be an arraybuffer or typed array");if(TextDecoder)return new TextDecoder().decode(e);throw new Error("Expected TextDecoder to be configured")}areBuffersEqual(e,t){if(!e||!t)return!1;const n=this.toArrayBuffer(e),s=this.toArrayBuffer(t);if(n.byteLength!=s.byteLength)return!1;const i=new Uint8Array(n),u=new Uint8Array(s);for(var g=0;g<i.length;g++)if(i[g]!=u[g])return!1;return!0}byteLength(e){return e instanceof ArrayBuffer||ArrayBuffer.isView(e)?e.byteLength:-1}arrayBufferViewToBuffer(e){return this.toArrayBuffer(e)}hmacSha256(e,t){const n=xa(this.toBuffer(t),this.toBuffer(e));return this.toArrayBuffer(n)}},Hi=new La,Na=function(e,t){var n="aes",s=256,i="cbc",u=16;function g(j){if(j.algorithm==="aes"&&j.mode==="cbc"){if(j.keyLength===128||j.keyLength===256)return;throw new Error("Unsupported key length "+j.keyLength+" for aes-cbc encryption. Encryption key must be 128 or 256 bits (16 or 32 ASCII characters)")}}function b(j){return j.replace("_","/").replace("-","+")}function S(j){return j instanceof C}class C{constructor(M,V,G,J){this.algorithm=M,this.keyLength=V,this.mode=G,this.key=J}}class E{static getDefaultParams(M){var V;if(!M.key)throw new Error("Crypto.getDefaultParams: a key is required");typeof M.key=="string"?V=t.toArrayBuffer(t.base64Decode(b(M.key))):M.key instanceof ArrayBuffer?V=M.key:V=t.toArrayBuffer(M.key);var G=M.algorithm||n,J=V.byteLength*8,ie=M.mode||i,ce=new C(G,J,ie,V);if(M.keyLength&&M.keyLength!==ce.keyLength)throw new Error("Crypto.getDefaultParams: a keyLength of "+M.keyLength+" was specified, but the key actually has length "+ce.keyLength);return g(ce),ce}static async generateRandomKey(M){try{return e.getRandomArrayBuffer((M||s)/8)}catch(V){throw new A("Failed to generate random key: "+V.message,400,5e4,V)}}static getCipher(M,V){var G,J=S(M)?M:this.getDefaultParams(M);return{cipherParams:J,cipher:new P(J,(G=M.iv)!=null?G:null,V)}}}E.CipherParams=C;class P{constructor(M,V,G){if(this.logger=G,!crypto.subtle)throw isSecureContext?new Error("Crypto operations are not possible since the browser’s SubtleCrypto class is unavailable (reason unknown)."):new Error("Crypto operations are is not possible since the current environment is a non-secure context and hence the browser’s SubtleCrypto class is not available.");this.algorithm=M.algorithm+"-"+String(M.keyLength)+"-"+M.mode,this.webCryptoAlgorithm=M.algorithm+"-"+M.mode,this.key=t.toArrayBuffer(M.key),this.iv=V?t.toArrayBuffer(V):null}concat(M,V){const G=new ArrayBuffer(M.byteLength+V.byteLength),J=new DataView(G),ie=new DataView(t.toArrayBuffer(M));for(let le=0;le<ie.byteLength;le++)J.setInt8(le,ie.getInt8(le));const ce=new DataView(t.toArrayBuffer(V));for(let le=0;le<ce.byteLength;le++)J.setInt8(ie.byteLength+le,ce.getInt8(le));return G}async encrypt(M){f.logAction(this.logger,f.LOG_MICRO,"CBCCipher.encrypt()","");const V=await this.getIv(),G=await crypto.subtle.importKey("raw",this.key,this.webCryptoAlgorithm,!1,["encrypt"]),J=await crypto.subtle.encrypt({name:this.webCryptoAlgorithm,iv:V},G,M);return this.concat(V,J)}async decrypt(M){f.logAction(this.logger,f.LOG_MICRO,"CBCCipher.decrypt()","");const V=t.toArrayBuffer(M),G=V.slice(0,u),J=V.slice(u),ie=await crypto.subtle.importKey("raw",this.key,this.webCryptoAlgorithm,!1,["decrypt"]);return crypto.subtle.decrypt({name:this.webCryptoAlgorithm,iv:G},ie,J)}async getIv(){if(this.iv){var M=this.iv;return this.iv=null,M}const V=await e.getRandomArrayBuffer(u);return t.toArrayBuffer(V)}}return E},Gi=(e=>(e[e.REQ_SEND=0]="REQ_SEND",e[e.REQ_RECV=1]="REQ_RECV",e[e.REQ_RECV_POLL=2]="REQ_RECV_POLL",e[e.REQ_RECV_STREAM=3]="REQ_RECV_STREAM",e))(Gi||{}),it=Gi;function Fi(){return new A("No HTTP request plugin provided. Provide at least one of the FetchRequest or XHRRequest plugins.",400,4e4)}var In,Wi=(In=class{constructor(e){this.checksInProgress=null,this.checkConnectivity=void 0,this.supportsAuthHeaders=!1,this.supportsLinkHeaders=!1;var t;this.client=e??null;const n=(e==null?void 0:e.options.connectivityCheckUrl)||$.connectivityCheckUrl,s=(t=e==null?void 0:e.options.connectivityCheckParams)!=null?t:null,i=!(e!=null&&e.options.connectivityCheckUrl),u=H(H({},Wi.bundledRequestImplementations),e==null?void 0:e._additionalHTTPRequestImplementations),g=u.XHRRequest,b=u.FetchRequest,S=!!(g||b);if(!S)throw Fi();_.Config.xhrSupported&&g?(this.supportsAuthHeaders=!0,this.Request=async function(C,E,P,j,M){return new Promise(V=>{var G;const J=g.createRequest(E,P,j,M,it.REQ_SEND,(G=e&&e.options.timeouts)!=null?G:null,this.logger,C);J.once("complete",(ie,ce,le,Q,De)=>V({error:ie,body:ce,headers:le,unpacked:Q,statusCode:De})),J.exec()})},e!=null&&e.options.disableConnectivityCheck?this.checkConnectivity=async function(){return!0}:this.checkConnectivity=async function(){var C;f.logAction(this.logger,f.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Sending; "+n);const E=await this.doUri(he.Get,n,null,null,s);let P=!1;return i?P=!E.error&&((C=E.body)==null?void 0:C.replace(/\n/,""))=="yes":P=!E.error&&gn(E.statusCode),f.logAction(this.logger,f.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Result: "+P),P}):_.Config.fetchSupported&&b?(this.supportsAuthHeaders=!0,this.Request=async(C,E,P,j,M)=>b(C,e??null,E,P,j,M),e!=null&&e.options.disableConnectivityCheck?this.checkConnectivity=async function(){return!0}:this.checkConnectivity=async function(){var C;f.logAction(this.logger,f.LOG_MICRO,"(Fetch)Http.checkConnectivity()","Sending; "+n);const E=await this.doUri(he.Get,n,null,null,null),P=!E.error&&((C=E.body)==null?void 0:C.replace(/\n/,""))=="yes";return f.logAction(this.logger,f.LOG_MICRO,"(Fetch)Http.checkConnectivity()","Result: "+P),P}):this.Request=async()=>({error:S?new Re("no supported HTTP transports available",null,400):Fi()})}get logger(){var e,t;return(t=(e=this.client)==null?void 0:e.logger)!=null?t:f.defaultLogger}async doUri(e,t,n,s,i){return this.Request?this.Request(e,t,n,i,s):{error:new Re("Request invoked before assigned to",null,500)}}shouldFallback(e){const t=e.statusCode;return t===408&&!e.code||t===400&&!e.code||t>=500&&t<=504}},In.methods=[he.Get,he.Delete,he.Post,he.Put,he.Patch],In.methodsWithoutBody=[he.Get,he.Delete],In.methodsWithBody=[he.Post,he.Put,he.Patch],In),zi=Wi,zt="ablyjs-storage-test",Vt=typeof pt<"u"?pt:typeof window<"u"?window:self,Ua=class{constructor(){try{Vt.sessionStorage.setItem(zt,zt),Vt.sessionStorage.removeItem(zt),this.sessionSupported=!0}catch{this.sessionSupported=!1}try{Vt.localStorage.setItem(zt,zt),Vt.localStorage.removeItem(zt),this.localSupported=!0}catch{this.localSupported=!1}}get(e){return this._get(e,!1)}getSession(e){return this._get(e,!0)}remove(e){return this._remove(e,!1)}removeSession(e){return this._remove(e,!0)}set(e,t,n){return this._set(e,t,n,!1)}setSession(e,t,n){return this._set(e,t,n,!0)}_set(e,t,n,s){const i={value:t};return n&&(i.expires=Date.now()+n),this.storageInterface(s).setItem(e,JSON.stringify(i))}_get(e,t){if(t&&!this.sessionSupported)throw new Error("Session Storage not supported");if(!t&&!this.localSupported)throw new Error("Local Storage not supported");const n=this.storageInterface(t).getItem(e);if(!n)return null;const s=JSON.parse(n);return s.expires&&s.expires<Date.now()?(this.storageInterface(t).removeItem(e),null):s.value}_remove(e,t){return this.storageInterface(t).removeItem(e)}storageInterface(e){return e?Vt.sessionStorage:Vt.localStorage}},Vi=new Ua,me=on(),qa=typeof EdgeRuntime=="string";typeof Window>"u"&&typeof WorkerGlobalScope>"u"&&!qa&&console.log("Warning: this distribution of Ably is intended for browsers. On nodejs, please use the 'ably' package on npm");function Da(){const e=me.location;return!me.WebSocket||!e||!e.origin||e.origin.indexOf("http")>-1}function Ba(){return typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope}var ja=me.navigator&&me.navigator.userAgent.toString(),Ha=me.location&&me.location.href,Ga={agent:"browser",logTimestamps:!0,userAgent:ja,currentUrl:Ha,binaryType:"arraybuffer",WebSocket:me.WebSocket,fetchSupported:!!me.fetch,xhrSupported:me.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,allowComet:Da(),useProtocolHeartbeats:!0,supportsBinary:!!me.TextDecoder,preferBinary:!1,ArrayBuffer:me.ArrayBuffer,atob:me.atob,nextTick:typeof me.setImmediate<"u"?me.setImmediate.bind(me):function(e){setTimeout(e,0)},addEventListener:me.addEventListener,inspect:JSON.stringify,stringByteSize:function(e){return me.TextDecoder&&new me.TextEncoder().encode(e).length||e.length},TextEncoder:me.TextEncoder,TextDecoder:me.TextDecoder,getRandomArrayBuffer:async function(e){const t=new Uint8Array(e);return me.crypto.getRandomValues(t),t.buffer},isWebworker:Ba(),push:{platform:"browser",formFactor:"desktop",storage:Vi}},Ji=Ga;function Fa(e){const t=[80015,80017,80030];return e.code?Je.isTokenErr(e)?!1:t.includes(e.code)?!0:e.code>=4e4&&e.code<5e4:!1}function ni(e){return Fa(e)?[xe({action:ee.ERROR,error:e})]:[xe({action:ee.DISCONNECTED,error:e})]}var Wa=class extends Wt{constructor(e,t,n){super(e,t,n,!0),this.onAuthUpdated=s=>{this.authParams={access_token:s.token}},this.stream="stream"in n?n.stream:!0,this.sendRequest=null,this.recvRequest=null,this.pendingCallback=null,this.pendingItems=null}connect(){f.logAction(this.logger,f.LOG_MINOR,"CometTransport.connect()","starting"),Wt.prototype.connect.call(this);const e=this.params,t=e.options,n=$.getHost(t,e.host),s=$.getPort(t),i=t.tls?"https://":"http://";this.baseUri=i+n+":"+s+"/comet/";const u=this.baseUri+"connect";f.logAction(this.logger,f.LOG_MINOR,"CometTransport.connect()","uri: "+u),Ee(this.auth.getAuthParams(),(g,b)=>{if(g){this.disconnect(g);return}if(this.isDisposed)return;this.authParams=b;const S=this.params.getConnectParams(b);"stream"in S&&(this.stream=S.stream),f.logAction(this.logger,f.LOG_MINOR,"CometTransport.connect()","connectParams:"+yt(S));let C=!1;const E=this.recvRequest=this.createRequest(u,null,S,null,this.stream?it.REQ_RECV_STREAM:it.REQ_RECV);E.on("data",P=>{this.recvRequest&&(C||(C=!0,this.emit("preconnect")),this.onData(P))}),E.on("complete",P=>{if(this.recvRequest||(P=P||new A("Request cancelled",80003,400)),this.recvRequest=null,!C&&!P&&(C=!0,this.emit("preconnect")),this.onActivity(),P){P.code?this.onData(ni(P)):this.disconnect(P);return}_.Config.nextTick(()=>{this.recv()})}),E.exec()})}requestClose(){f.logAction(this.logger,f.LOG_MINOR,"CometTransport.requestClose()"),this._requestCloseOrDisconnect(!0)}requestDisconnect(){f.logAction(this.logger,f.LOG_MINOR,"CometTransport.requestDisconnect()"),this._requestCloseOrDisconnect(!1)}_requestCloseOrDisconnect(e){const t=e?this.closeUri:this.disconnectUri;if(t){const n=this.createRequest(t,null,this.authParams,null,it.REQ_SEND);n.on("complete",s=>{s&&(f.logAction(this.logger,f.LOG_ERROR,"CometTransport.request"+(e?"Close()":"Disconnect()"),"request returned err = "+oe(s)),this.finish("disconnected",s))}),n.exec()}}dispose(){f.logAction(this.logger,f.LOG_MINOR,"CometTransport.dispose()",""),this.isDisposed||(this.isDisposed=!0,this.recvRequest&&(f.logAction(this.logger,f.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null),this.finish("disconnected",Rt.disconnected()),_.Config.nextTick(()=>{this.emit("disposed")}))}onConnect(e){var t;if(this.isDisposed)return;const n=(t=e.connectionDetails)==null?void 0:t.connectionKey;Wt.prototype.onConnect.call(this,e);const s=this.baseUri+n;f.logAction(this.logger,f.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+s),this.sendUri=s+"/send",this.recvUri=s+"/recv",this.closeUri=s+"/close",this.disconnectUri=s+"/disconnect"}send(e){if(this.sendRequest){this.pendingItems=this.pendingItems||[],this.pendingItems.push(e);return}const t=this.pendingItems||[];t.push(e),this.pendingItems=null,this.sendItems(t)}sendAnyPending(){const e=this.pendingItems;e&&(this.pendingItems=null,this.sendItems(e))}sendItems(e){const t=this.sendRequest=this.createRequest(this.sendUri,null,this.authParams,this.encodeRequest(e),it.REQ_SEND);t.on("complete",(n,s)=>{if(n&&f.logAction(this.logger,f.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+oe(n)),this.sendRequest=null,n){n.code?this.onData(ni(n)):this.disconnect(n);return}s&&this.onData(s),this.pendingItems&&_.Config.nextTick(()=>{this.sendRequest||this.sendAnyPending()})}),t.exec()}recv(){if(this.recvRequest||!this.isConnected)return;const e=this.recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,this.stream?it.REQ_RECV_STREAM:it.REQ_RECV_POLL);e.on("data",t=>{this.onData(t)}),e.on("complete",t=>{if(this.recvRequest=null,this.onActivity(),t){t.code?this.onData(ni(t)):this.disconnect(t);return}_.Config.nextTick(()=>{this.recv()})}),e.exec()}onData(e){try{const t=this.decodeResponse(e);if(t&&t.length)for(let n=0;n<t.length;n++)this.onProtocolMessage(Gt(t[n],this.connectionManager.realtime._RealtimePresence))}catch(t){f.logAction(this.logger,f.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+t.stack)}}encodeRequest(e){return JSON.stringify(e)}decodeResponse(e){return typeof e=="string"?JSON.parse(e):e}},za=Wa;function Va(e,t){return sn(ct(t)).includes("x-ably-errorcode")}function Ja(e,t){if(Va(e,t))return e.error&&A.fromValues(e.error)}var $a=function(){},Ka=0,$i={};function Xa(e,t){return e.getResponseHeader&&e.getResponseHeader(t)}function Qa(e){return e.getResponseHeader&&(e.getResponseHeader("transfer-encoding")||!e.getResponseHeader("content-length"))}function Ya(e){const t=e.getAllResponseHeaders().trim().split(`\r
`),n={};for(let s=0;s<t.length;s++){const i=t[s].split(":").map(u=>u.trim());n[i[0].toLowerCase()]=i[1]}return n}var Za=class na extends _e{constructor(t,n,s,i,u,g,b,S){super(b),s=s||{},s.rnd=ae(),this.uri=t+yt(s),this.headers=n||{},this.body=i,this.method=S?S.toUpperCase():Ce(i)?"GET":"POST",this.requestMode=u,this.timeouts=g,this.timedOut=!1,this.requestComplete=!1,this.id=String(++Ka),$i[this.id]=this}static createRequest(t,n,s,i,u,g,b,S){const C=g||$.TIMEOUTS;return new na(t,n,ot(s),i,u,C,b,S)}complete(t,n,s,i,u){this.requestComplete||(this.requestComplete=!0,!t&&n&&this.emit("data",n),this.emit("complete",t,n,s,i,u),this.dispose())}abort(){this.dispose()}exec(){let t=this.headers;const n=this.requestMode==it.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout,s=this.timer=setTimeout(()=>{this.timedOut=!0,u.abort()},n),i=this.method,u=this.xhr=new XMLHttpRequest,g=t.accept;let b=this.body,S="text";g?g.indexOf("application/x-msgpack")===0&&(S="arraybuffer"):t.accept="application/json",b&&(t["content-type"]||(t["content-type"]="application/json")).indexOf("application/json")>-1&&typeof b!="string"&&(b=JSON.stringify(b)),u.open(i,this.uri,!0),u.responseType=S,"authorization"in t&&(u.withCredentials=!0);for(const Q in t)u.setRequestHeader(Q,t[Q]);const C=(Q,De,Pe,Nn)=>{var Jt;let oi=De+" (event type: "+Q.type+")";(Jt=this==null?void 0:this.xhr)!=null&&Jt.statusText&&(oi+=", current statusText is "+this.xhr.statusText),f.logAction(this.logger,f.LOG_ERROR,"Request.on"+Q.type+"()",oi),this.complete(new Re(oi,Pe,Nn))};u.onerror=function(Q){C(Q,"XHR error occurred",null,400)},u.onabort=Q=>{this.timedOut?C(Q,"Request aborted due to request timeout expiring",null,408):C(Q,"Request cancelled",null,400)},u.ontimeout=function(Q){C(Q,"Request timed out",null,408)};let E,P,j,M=0,V=!1;const G=()=>{if(clearTimeout(s),j=P<400,P==204){this.complete(null,null,null,null,P);return}E=this.requestMode==it.REQ_RECV_STREAM&&j&&Qa(u)},J=()=>{let Q;try{const Pe=Xa(u,"content-type");if(Pe?Pe.indexOf("application/json")>=0:u.responseType=="text"){const Jt=u.responseType==="arraybuffer"?_.BufferUtils.utf8Decode(u.response):String(u.responseText);Jt.length?Q=JSON.parse(Jt):Q=Jt,V=!0}else Q=u.response;Q.response!==void 0?(P=Q.statusCode,j=P<400,t=Q.headers,Q=Q.response):t=Ya(u)}catch(Pe){this.complete(new Re("Malformed response body from server: "+Pe.message,null,400));return}if(j||Array.isArray(Q)){this.complete(null,Q,t,V,P);return}let De=Ja(Q,t);De||(De=new Re("Error response received from server: "+P+" body was: "+_.Config.inspect(Q),null,P)),this.complete(De,Q,t,V,P)};function ie(){const Q=u.responseText,De=Q.length-1;let Pe,Nn;for(;M<De&&(Pe=Q.indexOf(`
`,M))>-1;)Nn=Q.slice(M,Pe),M=Pe+1,ce(Nn)}const ce=Q=>{try{Q=JSON.parse(Q)}catch(De){this.complete(new Re("Malformed response body from server: "+De.message,null,400));return}this.emit("data",Q)},le=()=>{ie(),this.streamComplete=!0,_.Config.nextTick(()=>{this.complete()})};u.onreadystatechange=function(){const Q=u.readyState;Q<3||u.status!==0&&(P===void 0&&(P=u.status,G()),Q==3&&E?ie():Q==4&&(E?le():J()))},u.send(b)}dispose(){const t=this.xhr;if(t){t.onreadystatechange=t.onerror=t.onabort=t.ontimeout=$a,this.xhr=null;const n=this.timer;n&&(clearTimeout(n),this.timer=null),this.requestComplete||t.abort()}delete $i[this.id]}},Ki=Za,Xi=Le.XhrPolling,ec=class extends za{constructor(e,t,n){super(e,t,n),this.shortName=Xi,n.stream=!1,this.shortName=Xi}static isAvailable(){return!!(_.Config.xhrSupported&&_.Config.allowComet)}toString(){return"XHRPollingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected}createRequest(e,t,n,s,i){return Ki.createRequest(e,t,n,s,i,this.timeouts,this.logger)}},tc=ec,nc=["xhr_polling"],sc={order:nc,bundledImplementations:{web_socket:qi,xhr_polling:tc}},rc=sc,ic={connectivityCheckUrl:"https://internet-up.ably-realtime.com/is-the-internet-up.txt",wsConnectivityCheckUrl:"wss://ws-up.ably-realtime.com",defaultTransports:[Le.XhrPolling,Le.WebSocket]},oc=ic;function ac(e){if(e===void 0)return"undefined";let t,n;if(e instanceof ArrayBuffer?(n="ArrayBuffer",t=new DataView(e)):e instanceof DataView&&(n="DataView",t=e),!t)return JSON.stringify(e);const s=[];for(let i=0;i<e.byteLength;i++){if(i>20){s.push("...");break}let u=t.getUint8(i).toString(16);u.length===1&&(u="0"+u),s.push(u)}return"<"+n+" "+s.join(" ")+">"}function Mn(e,t,n){for(let s=0,i=n.length;s<i;s++){const u=n.charCodeAt(s);if(u<128){e.setUint8(t++,u>>>0&127|0);continue}if(u<2048){e.setUint8(t++,u>>>6&31|192),e.setUint8(t++,u>>>0&63|128);continue}if(u<65536){e.setUint8(t++,u>>>12&15|224),e.setUint8(t++,u>>>6&63|128),e.setUint8(t++,u>>>0&63|128);continue}if(u<1114112){e.setUint8(t++,u>>>18&7|240),e.setUint8(t++,u>>>12&63|128),e.setUint8(t++,u>>>6&63|128),e.setUint8(t++,u>>>0&63|128);continue}throw new Error("bad codepoint "+u)}}function Qi(e,t,n){let s="";for(let i=t,u=t+n;i<u;i++){const g=e.getUint8(i);if((g&128)===0){s+=String.fromCharCode(g);continue}if((g&224)===192){s+=String.fromCharCode((g&15)<<6|e.getUint8(++i)&63);continue}if((g&240)===224){s+=String.fromCharCode((g&15)<<12|(e.getUint8(++i)&63)<<6|(e.getUint8(++i)&63)<<0);continue}if((g&248)===240){s+=String.fromCharCode((g&7)<<18|(e.getUint8(++i)&63)<<12|(e.getUint8(++i)&63)<<6|(e.getUint8(++i)&63)<<0);continue}throw new Error("Invalid byte "+g.toString(16))}return s}function si(e){let t=0;for(let n=0,s=e.length;n<s;n++){const i=e.charCodeAt(n);if(i<128){t+=1;continue}if(i<2048){t+=2;continue}if(i<65536){t+=3;continue}if(i<1114112){t+=4;continue}throw new Error("bad codepoint "+i)}return t}function cc(e,t){const n=Ln(e,t);if(n===0)return;const s=new ArrayBuffer(n),i=new DataView(s);return xn(e,i,0,t),s}var ri=65536*65536,Yi=1/ri;function lc(e,t){return t=t||0,e.getInt32(t)*ri+e.getUint32(t+4)}function uc(e,t){return t=t||0,e.getUint32(t)*ri+e.getUint32(t+4)}function hc(e,t,n){n<9223372036854776e3?(e.setInt32(t,Math.floor(n*Yi)),e.setInt32(t+4,n&-1)):(e.setUint32(t,2147483647),e.setUint32(t+4,2147483647))}function dc(e,t,n){n<18446744073709552e3?(e.setUint32(t,Math.floor(n*Yi)),e.setInt32(t+4,n&-1)):(e.setUint32(t,4294967295),e.setUint32(t+4,4294967295))}var fc=class{constructor(e,t){this.map=n=>{const s={};for(let i=0;i<n;i++){const u=this.parse();s[u]=this.parse()}return s},this.bin=n=>{const s=new ArrayBuffer(n);return new Uint8Array(s).set(new Uint8Array(this.view.buffer,this.offset,n),0),this.offset+=n,s},this.buf=this.bin,this.str=n=>{const s=Qi(this.view,this.offset,n);return this.offset+=n,s},this.array=n=>{const s=new Array(n);for(let i=0;i<n;i++)s[i]=this.parse();return s},this.ext=n=>(this.offset+=n,{type:this.view.getInt8(this.offset),data:this.buf(n)}),this.parse=()=>{const n=this.view.getUint8(this.offset);let s,i;if((n&128)===0)return this.offset++,n;if((n&240)===128)return i=n&15,this.offset++,this.map(i);if((n&240)===144)return i=n&15,this.offset++,this.array(i);if((n&224)===160)return i=n&31,this.offset++,this.str(i);if((n&224)===224)return s=this.view.getInt8(this.offset),this.offset++,s;switch(n){case 192:return this.offset++,null;case 193:this.offset++;return;case 194:return this.offset++,!1;case 195:return this.offset++,!0;case 196:return i=this.view.getUint8(this.offset+1),this.offset+=2,this.bin(i);case 197:return i=this.view.getUint16(this.offset+1),this.offset+=3,this.bin(i);case 198:return i=this.view.getUint32(this.offset+1),this.offset+=5,this.bin(i);case 199:return i=this.view.getUint8(this.offset+1),this.offset+=2,this.ext(i);case 200:return i=this.view.getUint16(this.offset+1),this.offset+=3,this.ext(i);case 201:return i=this.view.getUint32(this.offset+1),this.offset+=5,this.ext(i);case 202:return s=this.view.getFloat32(this.offset+1),this.offset+=5,s;case 203:return s=this.view.getFloat64(this.offset+1),this.offset+=9,s;case 204:return s=this.view.getUint8(this.offset+1),this.offset+=2,s;case 205:return s=this.view.getUint16(this.offset+1),this.offset+=3,s;case 206:return s=this.view.getUint32(this.offset+1),this.offset+=5,s;case 207:return s=uc(this.view,this.offset+1),this.offset+=9,s;case 208:return s=this.view.getInt8(this.offset+1),this.offset+=2,s;case 209:return s=this.view.getInt16(this.offset+1),this.offset+=3,s;case 210:return s=this.view.getInt32(this.offset+1),this.offset+=5,s;case 211:return s=lc(this.view,this.offset+1),this.offset+=9,s;case 212:return i=1,this.offset++,this.ext(i);case 213:return i=2,this.offset++,this.ext(i);case 214:return i=4,this.offset++,this.ext(i);case 215:return i=8,this.offset++,this.ext(i);case 216:return i=16,this.offset++,this.ext(i);case 217:return i=this.view.getUint8(this.offset+1),this.offset+=2,this.str(i);case 218:return i=this.view.getUint16(this.offset+1),this.offset+=3,this.str(i);case 219:return i=this.view.getUint32(this.offset+1),this.offset+=5,this.str(i);case 220:return i=this.view.getUint16(this.offset+1),this.offset+=3,this.array(i);case 221:return i=this.view.getUint32(this.offset+1),this.offset+=5,this.array(i);case 222:return i=this.view.getUint16(this.offset+1),this.offset+=3,this.map(i);case 223:return i=this.view.getUint32(this.offset+1),this.offset+=5,this.map(i)}throw new Error("Unknown type 0x"+n.toString(16))},this.offset=t||0,this.view=e}};function pc(e){const t=new DataView(e),n=new fc(t),s=n.parse();if(n.offset!==e.byteLength)throw new Error(e.byteLength-n.offset+" trailing bytes");return s}function Zi(e,t){return Object.keys(e).filter(function(n){const s=e[n],i=typeof s;return(!t||s!=null)&&(i!=="function"||!!s.toJSON)})}function xn(e,t,n,s){const i=typeof e;if(typeof e=="string"){const u=si(e);if(u<32)return t.setUint8(n,u|160),Mn(t,n+1,e),1+u;if(u<256)return t.setUint8(n,217),t.setUint8(n+1,u),Mn(t,n+2,e),2+u;if(u<65536)return t.setUint8(n,218),t.setUint16(n+1,u),Mn(t,n+3,e),3+u;if(u<4294967296)return t.setUint8(n,219),t.setUint32(n+1,u),Mn(t,n+5,e),5+u}if(ArrayBuffer.isView&&ArrayBuffer.isView(e)&&(e=e.buffer),e instanceof ArrayBuffer){const u=e.byteLength;if(u<256)return t.setUint8(n,196),t.setUint8(n+1,u),new Uint8Array(t.buffer).set(new Uint8Array(e),n+2),2+u;if(u<65536)return t.setUint8(n,197),t.setUint16(n+1,u),new Uint8Array(t.buffer).set(new Uint8Array(e),n+3),3+u;if(u<4294967296)return t.setUint8(n,198),t.setUint32(n+1,u),new Uint8Array(t.buffer).set(new Uint8Array(e),n+5),5+u}if(typeof e=="number"){if(Math.floor(e)!==e)return t.setUint8(n,203),t.setFloat64(n+1,e),9;if(e>=0){if(e<128)return t.setUint8(n,e),1;if(e<256)return t.setUint8(n,204),t.setUint8(n+1,e),2;if(e<65536)return t.setUint8(n,205),t.setUint16(n+1,e),3;if(e<4294967296)return t.setUint8(n,206),t.setUint32(n+1,e),5;if(e<18446744073709552e3)return t.setUint8(n,207),dc(t,n+1,e),9;throw new Error("Number too big 0x"+e.toString(16))}if(e>=-32)return t.setInt8(n,e),1;if(e>=-128)return t.setUint8(n,208),t.setInt8(n+1,e),2;if(e>=-32768)return t.setUint8(n,209),t.setInt16(n+1,e),3;if(e>=-2147483648)return t.setUint8(n,210),t.setInt32(n+1,e),5;if(e>=-9223372036854776e3)return t.setUint8(n,211),hc(t,n+1,e),9;throw new Error("Number too small -0x"+(-e).toString(16).substr(1))}if(i==="undefined")return s?0:(t.setUint8(n,212),t.setUint8(n+1,0),t.setUint8(n+2,0),3);if(e===null)return s?0:(t.setUint8(n,192),1);if(i==="boolean")return t.setUint8(n,e?195:194),1;if(typeof e.toJSON=="function")return xn(e.toJSON(),t,n,s);if(i==="object"){let u,g=0,b;const S=Array.isArray(e);if(S?u=e.length:(b=Zi(e,s),u=b.length),u<16?(t.setUint8(n,u|(S?144:128)),g=1):u<65536?(t.setUint8(n,S?220:222),t.setUint16(n+1,u),g=3):u<4294967296&&(t.setUint8(n,S?221:223),t.setUint32(n+1,u),g=5),S)for(let C=0;C<u;C++)g+=xn(e[C],t,n+g,s);else if(b)for(let C=0;C<u;C++){const E=b[C];g+=xn(E,t,n+g),g+=xn(e[E],t,n+g,s)}return g}if(i==="function")return 0;throw new Error("Unknown type "+i)}function Ln(e,t){const n=typeof e;if(n==="string"){const s=si(e);if(s<32)return 1+s;if(s<256)return 2+s;if(s<65536)return 3+s;if(s<4294967296)return 5+s}if(ArrayBuffer.isView&&ArrayBuffer.isView(e)&&(e=e.buffer),e instanceof ArrayBuffer){const s=e.byteLength;if(s<256)return 2+s;if(s<65536)return 3+s;if(s<4294967296)return 5+s}if(typeof e=="number"){if(Math.floor(e)!==e)return 9;if(e>=0){if(e<128)return 1;if(e<256)return 2;if(e<65536)return 3;if(e<4294967296)return 5;if(e<18446744073709552e3)return 9;throw new Error("Number too big 0x"+e.toString(16))}if(e>=-32)return 1;if(e>=-128)return 2;if(e>=-32768)return 3;if(e>=-2147483648)return 5;if(e>=-9223372036854776e3)return 9;throw new Error("Number too small -0x"+e.toString(16).substr(1))}if(n==="boolean")return 1;if(e===null)return t?0:1;if(e===void 0)return t?0:3;if(typeof e.toJSON=="function")return Ln(e.toJSON(),t);if(n==="object"){let s,i=0;if(Array.isArray(e)){s=e.length;for(let u=0;u<s;u++)i+=Ln(e[u],t)}else{const u=Zi(e,t);s=u.length;for(let g=0;g<s;g++){const b=u[g];i+=Ln(b)+Ln(e[b],t)}}if(s<16)return 1+i;if(s<65536)return 3+i;if(s<4294967296)return 5+i;throw new Error("Array or object too long 0x"+s.toString(16))}if(n==="function")return 0;throw new Error("Unknown type "+n)}var ii={encode:cc,decode:pc,inspect:ac,utf8Write:Mn,utf8Read:Qi,utf8ByteCount:si};function gc(e,t){return!!t.get("x-ably-errorcode")}function mc(e,t){if(gc(e,t))return e.error&&A.fromValues(e.error)}function yc(e){const t={};return e.forEach((n,s)=>{t[s]=n}),t}async function bc(e,t,n,s,i,u){const g=new Headers(s||{}),b=e?e.toUpperCase():Ce(u)?"GET":"POST",S=new AbortController;let C;const E=new Promise(M=>{C=setTimeout(()=>{S.abort(),M({error:new Re("Request timed out",null,408)})},t?t.options.timeouts.httpRequestTimeout:$.TIMEOUTS.httpRequestTimeout)}),P={method:b,headers:g,body:u,signal:S.signal};_.Config.isWebworker||(P.credentials=g.has("authorization")?"include":"same-origin");const j=(async()=>{try{const M=new URLSearchParams(i||{});M.set("rnd",ae());const V=n+"?"+M,G=await on().fetch(V,P);if(clearTimeout(C),G.status==204)return{error:null,statusCode:G.status};const J=G.headers.get("Content-Type");let ie;J&&J.indexOf("application/x-msgpack")>-1?ie=await G.arrayBuffer():J&&J.indexOf("application/json")>-1?ie=await G.json():ie=await G.text();const ce=!!J&&J.indexOf("application/x-msgpack")===-1,le=yc(G.headers);return G.ok?{error:null,body:ie,headers:le,unpacked:ce,statusCode:G.status}:{error:mc(ie,G.headers)||new Re("Error response received from server: "+G.status+" body was: "+_.Config.inspect(ie),null,G.status),body:ie,headers:le,unpacked:ce,statusCode:G.status}}catch(M){return clearTimeout(C),{error:M}}})();return Promise.race([E,j])}var vc={XHRRequest:Ki,FetchRequest:bc},eo=Na(Ji,Hi);_.Crypto=eo,_.BufferUtils=Hi,_.Http=zi,_.Config=Ji,_.Transports=rc,_.WebStorage=Vi;for(const e of[jt,Xr])e.Crypto=eo,e._MsgPack=ii;zi.bundledRequestImplementations=vc,f.initLogHandlers(),_.Defaults=dn(oc),_.Config.agent&&(_.Defaults.agent+=" "+_.Config.agent);var wc={ErrorInfo:A,Rest:jt,Realtime:Xr,msgpack:ii};if(typeof c.exports=="object"&&typeof h=="object"){var Cc=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Object.getOwnPropertyNames(t))!Object.prototype.hasOwnProperty.call(e,i)&&i!==n&&Object.defineProperty(e,i,{get:()=>t[i],enumerable:!(s=Object.getOwnPropertyDescriptor(t,i))||s.enumerable});return e};c.exports=Cc(c.exports,h)}return c.exports})}(Ds)),Ds.exports}var sa=gu();const mu=Xo(sa),yu=Sc({__proto__:null,default:mu},[sa]);window.Ably=yu;window.Pusher=fu;window.Echo=new uu({broadcaster:"pusher",key:"rpBplQ.JCsU1w",cluster:"eu",wsHost:"realtime-pusher.ably.io",wsPort:443,wssPort:443,forceTLS:!0,encrypted:!0,disableStats:!0,enabledTransports:["ws","wss"]});window.axios=ye;window.axios.defaults.headers.common["X-Requested-With"]="XMLHttpRequest";
